{% extends "admin/base.html" %}

{% block title %}{{ 'Editar' if category else 'Nova' }} Categoria{% endblock %}

{% block breadcrumb %}
<span>/</span>
<a href="/admin/categories">Categorias</a>
<span>/</span>
<span class="current">{{ 'Editar' if category else 'Nova' }}</span>
{% endblock %}

{% block content %}
<div class="admin-page-header">
    <h1 class="admin-page-title">{{ 'Editar Categoria' if category else 'Nova Categoria' }}</h1>
</div>

<form method="POST" action="/admin/categories{{ '/' + category.id|string if category else '' }}" class="admin-form">
    <div class="admin-form-grid">
        <div class="admin-form-main">
            <div class="admin-card">
                <div class="admin-card-header">
                    <h3>Informacoes da Categoria</h3>
                </div>
                <div class="admin-card-body">
                    <div class="admin-form-group">
                        <label for="name" class="admin-label">Nome *</label>
                        <input
                            type="text"
                            id="name"
                            name="name"
                            value="{{ category.name if category else '' }}"
                            class="admin-input"
                            required
                        >
                    </div>

                    <div class="admin-form-group">
                        <label for="slug" class="admin-label">Slug</label>
                        <input
                            type="text"
                            id="slug"
                            name="slug"
                            value="{{ category.slug if category else '' }}"
                            class="admin-input"
                            pattern="[a-z0-9-]+"
                            placeholder="gerado-automaticamente"
                        >
                        <small class="admin-help-text">URL amigavel - deixe vazio para gerar automaticamente</small>
                    </div>

                    <div class="admin-form-group">
                        <label for="description" class="admin-label">Descricao</label>
                        <textarea
                            id="description"
                            name="description"
                            class="admin-textarea"
                            rows="4"
                            maxlength="500"
                            data-char-counter
                        >{{ category.description if category else '' }}</textarea>
                        <small class="admin-help-text">Descricao para SEO (max 500 caracteres)</small>
                    </div>
                </div>
            </div>

            <div class="admin-card">
                <div class="admin-card-header">
                    <h3>SEO</h3>
                    <button type="button" class="admin-btn admin-btn-sm admin-btn-secondary" onclick="generateAllSEO()" title="Gerar todos os campos SEO com IA">
                        ðŸ¤– Gerar Tudo
                    </button>
                </div>
                <div class="admin-card-body">
                    <div class="admin-form-group">
                        <label for="seo_focus_keyword" class="admin-label">
                            Palavra-chave foco
                            <button type="button" class="admin-btn-icon-sm" onclick="generateSEO('seo_focus_keyword')" title="Gerar com IA">ðŸ¤–</button>
                        </label>
                        <input
                            type="text"
                            id="seo_focus_keyword"
                            name="seo_focus_keyword"
                            value="{{ category.seo_focus_keyword if category and category.seo_focus_keyword else '' }}"
                            class="admin-input"
                            maxlength="100"
                            placeholder="Ex: presentes geek, funko pop"
                        >
                        <small class="admin-help-text">Palavra-chave principal para otimizacao SEO</small>
                    </div>

                    <div class="admin-form-group">
                        <label for="seo_title" class="admin-label">
                            Titulo SEO
                            <button type="button" class="admin-btn-icon-sm" onclick="generateSEO('seo_title')" title="Gerar com IA">ðŸ¤–</button>
                        </label>
                        <input
                            type="text"
                            id="seo_title"
                            name="seo_title"
                            value="{{ category.seo_title if category and category.seo_title else '' }}"
                            class="admin-input"
                            maxlength="60"
                        >
                        <small class="admin-help-text"><span id="seo_title_count">{{ (category.seo_title|length) if category and category.seo_title else 0 }}</span>/60 caracteres</small>
                    </div>

                    <div class="admin-form-group">
                        <label for="seo_description" class="admin-label">
                            Descricao SEO
                            <button type="button" class="admin-btn-icon-sm" onclick="generateSEO('seo_description')" title="Gerar com IA">ðŸ¤–</button>
                        </label>
                        <textarea
                            id="seo_description"
                            name="seo_description"
                            class="admin-textarea"
                            rows="2"
                            maxlength="160"
                        >{{ category.seo_description if category and category.seo_description else '' }}</textarea>
                        <small class="admin-help-text"><span id="seo_description_count">{{ (category.seo_description|length) if category and category.seo_description else 0 }}</span>/160 caracteres</small>
                    </div>
                </div>
            </div>
        </div>

        <div class="admin-form-sidebar">
            <div class="admin-card">
                <div class="admin-card-header">
                    <h3>Hierarquia</h3>
                </div>
                <div class="admin-card-body">
                    <div class="admin-form-group">
                        <label for="parent_id" class="admin-label">Categoria Pai</label>
                        <select id="parent_id" name="parent_id" class="admin-select">
                            <option value="">Nenhuma (categoria raiz)</option>
                            {% for cat in categories %}
                            <option
                                value="{{ cat.id }}"
                                {{ 'selected' if category and category.parent_id == cat.id else '' }}
                            >
                                {{ cat.name }}
                            </option>
                            {% endfor %}
                        </select>
                        <small class="admin-help-text">Selecione para criar subcategoria</small>
                    </div>
                </div>
            </div>

            <div class="admin-card">
                <div class="admin-card-header">
                    <h3>Imagem</h3>
                </div>
                <div class="admin-card-body">
                    <div class="admin-form-group">
                        <label class="admin-label">Upload de Imagem</label>

                        <!-- Preview da imagem -->
                        <div id="image-preview" class="admin-image-preview" style="margin-bottom: 1rem; {% if not (category and category.image_url) %}display: none;{% endif %}">
                            <img
                                id="preview-img"
                                src="{{ category.image_url if category and category.image_url else '' }}"
                                alt="Preview"
                                style="max-width: 100%; border-radius: 4px;"
                            >
                        </div>

                        <div class="admin-upload-wrapper">
                            <input
                                type="file"
                                id="image_file"
                                accept="image/jpeg,image/png,image/webp,image/gif"
                                class="admin-file-input"
                                style="display: none;"
                            >
                            <button type="button" class="admin-btn admin-btn-secondary admin-btn-block" onclick="document.getElementById('image_file').click()">
                                {{ 'Trocar Imagem' if category and category.image_url else 'Escolher Imagem' }}
                            </button>
                            <small class="admin-help-text">Redimensionada automaticamente para 400x400 px. Max 10MB.</small>
                        </div>
                        <div id="upload-progress" style="display: none; margin-top: 0.5rem;">
                            <div class="admin-progress-bar">
                                <div class="admin-progress-fill" style="width: 0%"></div>
                            </div>
                            <small class="admin-help-text">Enviando...</small>
                        </div>
                    </div>

                    <!-- Hidden input para URL da imagem -->
                    <input
                        type="hidden"
                        id="image_url"
                        name="image_url"
                        value="{{ category.image_url if category and category.image_url else '' }}"
                    >
                </div>
            </div>

            <!-- Tags -->
            <div class="admin-card">
                <div class="admin-card-body">
                    <div class="admin-form-group" style="margin-bottom: 0;">
                        <label for="tags" class="admin-label">
                            Tags
                            <button type="button" class="admin-btn-icon-sm" onclick="generateTags()" title="Gerar com IA">ðŸ¤–</button>
                        </label>
                        <input
                            type="text"
                            id="tags"
                            name="tags"
                            class="admin-input"
                            value="{{ category.tags | join(', ') if category and category.tags else '' }}"
                            placeholder="tag1, tag2, tag3"
                        >
                        <small class="admin-help-text">Separadas por virgula</small>
                    </div>
                </div>
            </div>

            <!-- Custos de IA -->
            {% if category %}
            <div class="admin-card" style="background: var(--admin-bg-tertiary);">
                <h4 style="margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
                    <span>ðŸ’°</span> Custos de IA
                </h4>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; text-align: center; margin-bottom: 0.75rem;">
                    <div style="background: var(--admin-bg-secondary); padding: 0.5rem; border-radius: 4px;">
                        <div id="ai-prompt-tokens-display" style="font-size: 1rem; font-weight: bold; color: var(--admin-warning);">
                            {{ "{:,}".format(category.ai_prompt_tokens) }}
                        </div>
                        <div style="font-size: 0.65rem; color: var(--admin-text-muted);">Entrada</div>
                    </div>
                    <div style="background: var(--admin-bg-secondary); padding: 0.5rem; border-radius: 4px;">
                        <div id="ai-completion-tokens-display" style="font-size: 1rem; font-weight: bold; color: var(--admin-info);">
                            {{ "{:,}".format(category.ai_completion_tokens) }}
                        </div>
                        <div style="font-size: 0.65rem; color: var(--admin-text-muted);">Saida</div>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; text-align: center;">
                    <div>
                        <div id="ai-tokens-display" style="font-size: 1.1rem; font-weight: bold; color: var(--admin-primary);">
                            {{ "{:,}".format(category.ai_tokens_used) }}
                        </div>
                        <div style="font-size: 0.65rem; color: var(--admin-text-muted);">Total</div>
                    </div>
                    <div>
                        <div id="ai-cost-display" style="font-size: 1.1rem; font-weight: bold; color: var(--admin-success);">
                            ${{ "%.6f"|format(category.ai_cost_usd|float) }}
                        </div>
                        <div style="font-size: 0.65rem; color: var(--admin-text-muted);">Custo</div>
                    </div>
                    <div>
                        <div id="ai-generations-display" style="font-size: 1.1rem; font-weight: bold; color: var(--admin-text);">
                            {{ category.ai_generations_count }}
                        </div>
                        <div style="font-size: 0.65rem; color: var(--admin-text-muted);">Chamadas</div>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="admin-card" style="background: var(--admin-bg-tertiary); opacity: 0.6;">
                <h4 style="margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                    <span>ðŸ’°</span> Custos de IA
                </h4>
                <p style="font-size: 0.8rem; color: var(--admin-text-muted); margin: 0;">
                    Salve a categoria para acompanhar custos de IA
                </p>
            </div>
            {% endif %}

            {% if category %}
            <div class="admin-card">
                <div class="admin-card-header">
                    <h3>Informacoes</h3>
                </div>
                <div class="admin-card-body">
                    <div class="admin-info-item">
                        <span class="admin-info-label">Criado em:</span>
                        <span class="admin-info-value">{{ category.created_at.strftime('%d/%m/%Y %H:%M') }}</span>
                    </div>
                    <div class="admin-info-item">
                        <span class="admin-info-label">Atualizado em:</span>
                        <span class="admin-info-value">{{ category.updated_at.strftime('%d/%m/%Y %H:%M') if category.updated_at else '-' }}</span>
                    </div>
                    <div class="admin-info-item">
                        <span class="admin-info-label">Posts:</span>
                        <span class="admin-info-value">{{ category.posts | length if category.posts else 0 }}</span>
                    </div>
                </div>
            </div>
            {% endif %}

            <div class="admin-form-actions">
                <button type="submit" class="admin-btn admin-btn-primary admin-btn-block">
                    {{ 'Salvar Alteracoes' if category else 'Criar Categoria' }}
                </button>
                <a href="/admin/categories" class="admin-btn admin-btn-secondary admin-btn-block">
                    Cancelar
                </a>
            </div>
        </div>
    </div>
</form>

<!-- Modal de Loading IA -->
<div id="ai-loading-modal" class="ai-loading-modal">
    <div class="ai-loading-backdrop"></div>
    <div class="ai-loading-content">
        <div class="ai-loading-spinner"></div>
        <div class="ai-loading-text">Gerando com IA...</div>
        <div class="ai-loading-subtext">Aguarde, isso pode levar alguns segundos</div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// =============================================================================
// Variaveis globais
// =============================================================================

const categoryId = '{{ category.id if category else "" }}';

let localTokensUsed = {{ category.ai_tokens_used if category else 0 }};
let localPromptTokens = {{ category.ai_prompt_tokens if category else 0 }};
let localCompletionTokens = {{ category.ai_completion_tokens if category else 0 }};
let localCostUsd = {{ category.ai_cost_usd|float if category else 0 }};
let localGenerationsCount = {{ category.ai_generations_count if category else 0 }};

// =============================================================================
// Funcoes auxiliares
// =============================================================================

function generateSlug(text) {
    return text
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/[^\w\s-]/g, '')
        .replace(/\s+/g, '-')
        .replace(/-+/g, '-')
        .trim();
}

function showMessage(message, type) {
    alert(message);
}

// =============================================================================
// Modal de Loading IA
// =============================================================================

const aiLoadingModal = document.getElementById('ai-loading-modal');

function showAILoading(text = 'Gerando com IA...') {
    if (!aiLoadingModal) return;
    const textEl = aiLoadingModal.querySelector('.ai-loading-text');
    if (textEl) textEl.textContent = text;
    aiLoadingModal.classList.add('active');
    document.body.style.overflow = 'hidden';
}

function hideAILoading() {
    if (!aiLoadingModal) return;
    aiLoadingModal.classList.remove('active');
    document.body.style.overflow = '';
}

// =============================================================================
// Atualizar custos de IA
// =============================================================================

async function updateCategoryAICost(tokensUsed, promptTokens, completionTokens, costUsd) {
    if (!categoryId) return;

    try {
        await fetch(`/admin/api/categories/${categoryId}/ai-cost`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                tokens_used: tokensUsed,
                prompt_tokens: promptTokens,
                completion_tokens: completionTokens,
                cost_usd: costUsd
            })
        });
    } catch (error) {
        console.error('Erro ao salvar custos de IA:', error);
    }
}

function updateCostDisplay(tokensUsed, promptTokens, completionTokens, costUsd) {
    localTokensUsed += tokensUsed || 0;
    localPromptTokens += promptTokens || 0;
    localCompletionTokens += completionTokens || 0;
    localCostUsd += costUsd || 0;
    localGenerationsCount += 1;

    const tokensDisplay = document.getElementById('ai-tokens-display');
    const promptDisplay = document.getElementById('ai-prompt-tokens-display');
    const completionDisplay = document.getElementById('ai-completion-tokens-display');
    const costDisplay = document.getElementById('ai-cost-display');
    const genDisplay = document.getElementById('ai-generations-display');

    if (tokensDisplay) tokensDisplay.textContent = localTokensUsed.toLocaleString('pt-BR');
    if (promptDisplay) promptDisplay.textContent = localPromptTokens.toLocaleString('pt-BR');
    if (completionDisplay) completionDisplay.textContent = localCompletionTokens.toLocaleString('pt-BR');
    if (costDisplay) costDisplay.textContent = '$' + localCostUsd.toFixed(6);
    if (genDisplay) genDisplay.textContent = localGenerationsCount;
}

// =============================================================================
// Inicializacao
// =============================================================================

document.addEventListener('DOMContentLoaded', function() {
    // Auto-preenchimento de slug a partir do nome
    const nameInput = document.getElementById('name');
    const slugInput = document.getElementById('slug');

    if (nameInput && slugInput) {
        const isNewCategory = !slugInput.value;

        nameInput.addEventListener('input', function() {
            if (isNewCategory && !slugInput.dataset.manual) {
                slugInput.value = generateSlug(this.value);
            }
        });

        slugInput.addEventListener('input', function() {
            if (this.value) {
                this.dataset.manual = 'true';
            } else {
                delete this.dataset.manual;
            }
        });
    }

    // Upload de imagem
    const fileInput = document.getElementById('image_file');
    const imageUrlInput = document.getElementById('image_url');
    const imagePreview = document.getElementById('image-preview');
    const previewImg = document.getElementById('preview-img');
    const uploadProgress = document.getElementById('upload-progress');

    if (fileInput) {
        fileInput.addEventListener('change', async function() {
            const file = this.files[0];
            if (!file) return;

            const allowedTypes = ['image/jpeg', 'image/png', 'image/webp', 'image/gif'];
            if (!allowedTypes.includes(file.type)) {
                showMessage('Tipo de arquivo nao permitido. Use JPG, PNG, WebP ou GIF.', 'danger');
                return;
            }

            if (file.size > 10 * 1024 * 1024) {
                showMessage('Arquivo muito grande. Maximo 10MB.', 'danger');
                return;
            }

            uploadProgress.style.display = 'block';

            try {
                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch('/admin/upload/category-image', {
                    method: 'POST',
                    body: formData,
                });

                const data = await response.json();

                if (response.ok) {
                    imageUrlInput.value = data.url;
                    previewImg.src = data.url;
                    imagePreview.style.display = 'block';
                    showMessage('Imagem enviada com sucesso! (400x400 px)', 'success');
                } else {
                    showMessage(data.detail || 'Erro ao enviar imagem', 'danger');
                }
            } catch (error) {
                showMessage('Erro de conexao ao enviar imagem', 'danger');
                console.error('Upload error:', error);
            } finally {
                uploadProgress.style.display = 'none';
                fileInput.value = '';
            }
        });
    }

    // Contadores de caracteres SEO
    const seoTitle = document.getElementById('seo_title');
    const seoDesc = document.getElementById('seo_description');

    if (seoTitle) {
        seoTitle.addEventListener('input', function() {
            document.getElementById('seo_title_count').textContent = this.value.length;
        });
    }
    if (seoDesc) {
        seoDesc.addEventListener('input', function() {
            document.getElementById('seo_description_count').textContent = this.value.length;
        });
    }
});

// =============================================================================
// Geracao de SEO com IA
// =============================================================================

const fieldToUseCase = {
    'seo_title': 'category_seo_title',
    'seo_description': 'category_seo_description',
    'seo_focus_keyword': 'category_seo_keyword'
};

async function generateSEO(field) {
    const name = document.getElementById('name').value.trim();
    const description = document.getElementById('description').value.trim();

    if (!name) {
        alert('Preencha o nome da categoria antes de gerar SEO');
        return;
    }

    const useCase = fieldToUseCase[field] || field;
    const targetInput = document.getElementById(field);

    const fieldLabels = {
        'seo_focus_keyword': 'Gerando palavra-chave...',
        'seo_title': 'Gerando titulo SEO...',
        'seo_description': 'Gerando descricao SEO...'
    };
    showAILoading(fieldLabels[field] || 'Gerando com IA...');

    try {
        const response = await fetch('/admin/api/ai/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                use_case: useCase,
                title: name,
                content: description
            })
        });

        const data = await response.json();

        if (response.ok) {
            let generatedContent = data.generated_content;
            if (field === 'seo_focus_keyword') {
                generatedContent = generatedContent
                    .replace(/^(palavras?-?chave|keywords?|foco|principal)[:.\s-]*/i, '')
                    .split(/[,\n]/)[0]
                    .trim();
            }
            targetInput.value = generatedContent;
            const countSpan = document.getElementById(field + '_count');
            if (countSpan) {
                countSpan.textContent = generatedContent.length;
            }
            updateCostDisplay(data.tokens_used || 0, data.prompt_tokens || 0, data.completion_tokens || 0, data.cost_usd || 0);
            await updateCategoryAICost(data.tokens_used || 0, data.prompt_tokens || 0, data.completion_tokens || 0, data.cost_usd || 0);
        } else {
            alert('Erro ao gerar: ' + (data.detail || 'Erro desconhecido'));
        }
    } catch (error) {
        alert('Erro de conexao: ' + error.message);
    } finally {
        hideAILoading();
    }
}

async function generateAllSEO() {
    const name = document.getElementById('name').value.trim();
    const description = document.getElementById('description').value.trim();

    if (!name) {
        alert('Preencha o nome da categoria antes de gerar SEO');
        return;
    }

    const seoKeyword = document.getElementById('seo_focus_keyword');
    const seoTitle = document.getElementById('seo_title');
    const seoDescription = document.getElementById('seo_description');
    const tagsInput = document.getElementById('tags');

    showAILoading('Gerando SEO completo...');

    const requestBody = {
        title: name,
        content: description
    };

    try {
        const [keywordResponse, titleResponse, descResponse, tagsResponse] = await Promise.all([
            fetch('/admin/api/ai/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ...requestBody, use_case: 'category_seo_keyword' })
            }),
            fetch('/admin/api/ai/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ...requestBody, use_case: 'category_seo_title' })
            }),
            fetch('/admin/api/ai/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ...requestBody, use_case: 'category_seo_description' })
            }),
            fetch('/admin/api/ai/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ...requestBody, use_case: 'category_tags' })
            })
        ]);

        const [keywordData, titleData, descData, tagsData] = await Promise.all([
            keywordResponse.json(),
            titleResponse.json(),
            descResponse.json(),
            tagsResponse.json()
        ]);

        if (keywordResponse.ok) {
            let keyword = keywordData.generated_content
                .replace(/^(palavras?-?chave|keywords?|foco|principal)[:.\s-]*/i, '')
                .split(/[,\n]/)[0]
                .trim();
            seoKeyword.value = keyword;
        }

        if (titleResponse.ok) {
            seoTitle.value = titleData.generated_content;
            document.getElementById('seo_title_count').textContent = titleData.generated_content.length;
        }

        if (descResponse.ok) {
            seoDescription.value = descData.generated_content;
            document.getElementById('seo_description_count').textContent = descData.generated_content.length;
        }

        if (tagsResponse.ok) {
            let tags = tagsData.generated_content
                .replace(/^(tags?|sugest[oÃµ]es?)[:.\s-]*/i, '')
                .split(/[,\n]/)
                .map(t => t.trim().toLowerCase())
                .filter(t => t.length > 0)
                .join(', ');
            tagsInput.value = tags;
        }

        // Salva custos
        if (keywordResponse.ok) {
            updateCostDisplay(keywordData.tokens_used || 0, keywordData.prompt_tokens || 0, keywordData.completion_tokens || 0, keywordData.cost_usd || 0);
            await updateCategoryAICost(keywordData.tokens_used || 0, keywordData.prompt_tokens || 0, keywordData.completion_tokens || 0, keywordData.cost_usd || 0);
        }
        if (titleResponse.ok) {
            updateCostDisplay(titleData.tokens_used || 0, titleData.prompt_tokens || 0, titleData.completion_tokens || 0, titleData.cost_usd || 0);
            await updateCategoryAICost(titleData.tokens_used || 0, titleData.prompt_tokens || 0, titleData.completion_tokens || 0, titleData.cost_usd || 0);
        }
        if (descResponse.ok) {
            updateCostDisplay(descData.tokens_used || 0, descData.prompt_tokens || 0, descData.completion_tokens || 0, descData.cost_usd || 0);
            await updateCategoryAICost(descData.tokens_used || 0, descData.prompt_tokens || 0, descData.completion_tokens || 0, descData.cost_usd || 0);
        }
        if (tagsResponse.ok) {
            updateCostDisplay(tagsData.tokens_used || 0, tagsData.prompt_tokens || 0, tagsData.completion_tokens || 0, tagsData.cost_usd || 0);
            await updateCategoryAICost(tagsData.tokens_used || 0, tagsData.prompt_tokens || 0, tagsData.completion_tokens || 0, tagsData.cost_usd || 0);
        }

        if (!keywordResponse.ok || !titleResponse.ok || !descResponse.ok || !tagsResponse.ok) {
            alert('Alguns campos nao foram gerados. Verifique a configuracao de IA.');
        }
    } catch (error) {
        alert('Erro de conexao: ' + error.message);
    } finally {
        hideAILoading();
    }
}

// =============================================================================
// Geracao de Tags com IA
// =============================================================================

async function generateTags() {
    const name = document.getElementById('name').value.trim();
    const description = document.getElementById('description').value.trim();

    if (!name) {
        alert('Preencha o nome da categoria antes de gerar tags');
        return;
    }

    const tagsInput = document.getElementById('tags');

    showAILoading('Gerando tags...');

    try {
        const response = await fetch('/admin/api/ai/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                use_case: 'category_tags',
                title: name,
                content: description
            })
        });

        const data = await response.json();

        if (response.ok) {
            let tags = data.generated_content
                .replace(/^(tags?|sugest[oÃµ]es?)[:.\s-]*/i, '')
                .split(/[,\n]/)
                .map(t => t.trim().toLowerCase())
                .filter(t => t.length > 0)
                .join(', ');
            tagsInput.value = tags;
            updateCostDisplay(data.tokens_used || 0, data.prompt_tokens || 0, data.completion_tokens || 0, data.cost_usd || 0);
            await updateCategoryAICost(data.tokens_used || 0, data.prompt_tokens || 0, data.completion_tokens || 0, data.cost_usd || 0);
        } else {
            alert('Erro ao gerar: ' + (data.detail || 'Erro desconhecido'));
        }
    } catch (error) {
        alert('Erro de conexao: ' + error.message);
    } finally {
        hideAILoading();
    }
}
</script>
{% endblock %}
