{% extends "admin/base.html" %}

{% block title %}{{ 'Editar' if category else 'Nova' }} Categoria{% endblock %}

{% block breadcrumb %}
<span>/</span>
<a href="/admin/categories">Categorias</a>
<span>/</span>
<span class="current">{{ 'Editar' if category else 'Nova' }}</span>
{% endblock %}

{% block content %}
<div class="admin-page-header">
    <h1 class="admin-page-title">{{ 'Editar Categoria' if category else 'Nova Categoria' }}</h1>
</div>

<form method="POST" action="/admin/categories{{ '/' + category.id|string if category else '' }}" class="admin-form">
    <div class="admin-form-grid">
        <div class="admin-form-main">
            <div class="admin-card">
                <div class="admin-card-header">
                    <h3>Informacoes da Categoria</h3>
                </div>
                <div class="admin-card-body">
                    <div class="admin-form-group">
                        <label for="name" class="admin-label">Nome *</label>
                        <input
                            type="text"
                            id="name"
                            name="name"
                            value="{{ category.name if category else '' }}"
                            class="admin-input"
                            required
                        >
                    </div>

                    <div class="admin-form-group">
                        <label for="slug" class="admin-label">Slug</label>
                        <input
                            type="text"
                            id="slug"
                            name="slug"
                            value="{{ category.slug if category else '' }}"
                            class="admin-input"
                            pattern="[a-z0-9-]+"
                            placeholder="gerado-automaticamente"
                        >
                        <small class="admin-help-text">URL amigavel - deixe vazio para gerar automaticamente</small>
                    </div>

                    <div class="admin-form-group">
                        <label for="description" class="admin-label">Descricao</label>
                        <textarea
                            id="description"
                            name="description"
                            class="admin-textarea"
                            rows="4"
                            maxlength="500"
                            data-char-counter
                        >{{ category.description if category else '' }}</textarea>
                        <small class="admin-help-text">Descricao para SEO (max 500 caracteres)</small>
                    </div>
                </div>
            </div>

            <div class="admin-card">
                <div class="admin-card-header">
                    <h3>SEO</h3>
                    <button type="button" class="admin-btn admin-btn-sm admin-btn-secondary" onclick="generateAllSEO()" title="Gerar todos os campos SEO com IA">
                         Gerar Tudo
                    </button>
                </div>
                <div class="admin-card-body">
                    <div class="admin-form-group">
                        <label for="seo_focus_keyword" class="admin-label">
                            Palavra-chave foco
                            <button type="button" class="admin-btn-icon-sm" onclick="generateSEO('seo_focus_keyword')" title="Gerar com IA"></button>
                        </label>
                        <input
                            type="text"
                            id="seo_focus_keyword"
                            name="seo_focus_keyword"
                            value="{{ category.seo_focus_keyword if category and category.seo_focus_keyword else '' }}"
                            class="admin-input"
                            maxlength="100"
                            placeholder="Ex: presentes geek, funko pop"
                        >
                        <small class="admin-help-text">Palavra-chave principal para otimizacao SEO</small>
                    </div>

                    <div class="admin-form-group">
                        <label for="seo_title" class="admin-label">
                            Titulo SEO
                            <button type="button" class="admin-btn-icon-sm" onclick="generateSEO('seo_title')" title="Gerar com IA"></button>
                        </label>
                        <input
                            type="text"
                            id="seo_title"
                            name="seo_title"
                            value="{{ category.seo_title if category and category.seo_title else '' }}"
                            class="admin-input"
                            maxlength="60"
                        >
                        <small class="admin-help-text"><span id="seo_title_count">{{ (category.seo_title|length) if category and category.seo_title else 0 }}</span>/60 caracteres</small>
                    </div>

                    <div class="admin-form-group">
                        <label for="seo_description" class="admin-label">
                            Descricao SEO
                            <button type="button" class="admin-btn-icon-sm" onclick="generateSEO('seo_description')" title="Gerar com IA"></button>
                        </label>
                        <textarea
                            id="seo_description"
                            name="seo_description"
                            class="admin-textarea"
                            rows="2"
                            maxlength="160"
                        >{{ category.seo_description if category and category.seo_description else '' }}</textarea>
                        <small class="admin-help-text"><span id="seo_description_count">{{ (category.seo_description|length) if category and category.seo_description else 0 }}</span>/160 caracteres</small>
                    </div>

                    <div id="seo-loading" style="display: none; text-align: center; padding: 1rem; color: var(--admin-text-muted);">
                        <div class="ai-spinner"></div>
                        <span>Gerando com IA...</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="admin-form-sidebar">
            <div class="admin-card">
                <div class="admin-card-header">
                    <h3>Hierarquia</h3>
                </div>
                <div class="admin-card-body">
                    <div class="admin-form-group">
                        <label for="parent_id" class="admin-label">Categoria Pai</label>
                        <select id="parent_id" name="parent_id" class="admin-select">
                            <option value="">Nenhuma (categoria raiz)</option>
                            {% for cat in categories %}
                            <option
                                value="{{ cat.id }}"
                                {{ 'selected' if category and category.parent_id == cat.id else '' }}
                            >
                                {{ cat.name }}
                            </option>
                            {% endfor %}
                        </select>
                        <small class="admin-help-text">Selecione para criar subcategoria</small>
                    </div>
                </div>
            </div>

            <div class="admin-card">
                <div class="admin-card-header">
                    <h3>Imagem</h3>
                </div>
                <div class="admin-card-body">
                    <div class="admin-form-group">
                        <label class="admin-label">Upload de Imagem</label>

                        <!-- Preview da imagem -->
                        <div id="image-preview" class="admin-image-preview" style="margin-bottom: 1rem; {% if not (category and category.image_url) %}display: none;{% endif %}">
                            <img
                                id="preview-img"
                                src="{{ category.image_url if category and category.image_url else '' }}"
                                alt="Preview"
                                style="max-width: 100%; border-radius: 4px;"
                            >
                        </div>

                        <div class="admin-upload-wrapper">
                            <input
                                type="file"
                                id="image_file"
                                accept="image/jpeg,image/png,image/webp,image/gif"
                                class="admin-file-input"
                                style="display: none;"
                            >
                            <button type="button" class="admin-btn admin-btn-secondary admin-btn-block" onclick="document.getElementById('image_file').click()">
                                {{ 'Trocar Imagem' if category and category.image_url else 'Escolher Imagem' }}
                            </button>
                            <small class="admin-help-text">Redimensionada automaticamente para 400x400 px. Max 10MB.</small>
                        </div>
                        <div id="upload-progress" style="display: none; margin-top: 0.5rem;">
                            <div class="admin-progress-bar">
                                <div class="admin-progress-fill" style="width: 0%"></div>
                            </div>
                            <small class="admin-help-text">Enviando...</small>
                        </div>
                    </div>

                    <!-- Hidden input para URL da imagem -->
                    <input
                        type="hidden"
                        id="image_url"
                        name="image_url"
                        value="{{ category.image_url if category and category.image_url else '' }}"
                    >
                </div>
            </div>

            {% if category %}
            <div class="admin-card">
                <div class="admin-card-header">
                    <h3>Informacoes</h3>
                </div>
                <div class="admin-card-body">
                    <div class="admin-info-item">
                        <span class="admin-info-label">Criado em:</span>
                        <span class="admin-info-value">{{ category.created_at.strftime('%d/%m/%Y %H:%M') }}</span>
                    </div>
                    <div class="admin-info-item">
                        <span class="admin-info-label">Atualizado em:</span>
                        <span class="admin-info-value">{{ category.updated_at.strftime('%d/%m/%Y %H:%M') if category.updated_at else '-' }}</span>
                    </div>
                    <div class="admin-info-item">
                        <span class="admin-info-label">Posts:</span>
                        <span class="admin-info-value">{{ category.posts | length if category.posts else 0 }}</span>
                    </div>
                </div>
            </div>
            {% endif %}

            <div class="admin-form-actions">
                <button type="submit" class="admin-btn admin-btn-primary admin-btn-block">
                    {{ 'Salvar Alteracoes' if category else 'Criar Categoria' }}
                </button>
                <a href="/admin/categories" class="admin-btn admin-btn-secondary admin-btn-block">
                    Cancelar
                </a>
            </div>
        </div>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Auto-preenchimento de slug a partir do nome
    const nameInput = document.getElementById('name');
    const slugInput = document.getElementById('slug');

    if (nameInput && slugInput) {
        // So auto-preenche se for nova categoria (slug vazio)
        const isNewCategory = !slugInput.value;

        nameInput.addEventListener('input', function() {
            if (isNewCategory && !slugInput.dataset.manual) {
                slugInput.value = generateSlug(this.value);
            }
        });

        // Se usuario editar slug manualmente, para de auto-preencher
        slugInput.addEventListener('input', function() {
            if (this.value) {
                this.dataset.manual = 'true';
            } else {
                delete this.dataset.manual;
            }
        });
    }

    // Upload de imagem
    const fileInput = document.getElementById('image_file');
    const imageUrlInput = document.getElementById('image_url');
    const imagePreview = document.getElementById('image-preview');
    const previewImg = document.getElementById('preview-img');
    const uploadProgress = document.getElementById('upload-progress');

    if (fileInput) {
        fileInput.addEventListener('change', async function() {
            const file = this.files[0];
            if (!file) return;

            // Validar tipo de arquivo
            const allowedTypes = ['image/jpeg', 'image/png', 'image/webp', 'image/gif'];
            if (!allowedTypes.includes(file.type)) {
                showMessage('Tipo de arquivo nao permitido. Use JPG, PNG, WebP ou GIF.', 'danger');
                return;
            }

            // Validar tamanho (10MB max - sera comprimido no servidor)
            if (file.size > 10 * 1024 * 1024) {
                showMessage('Arquivo muito grande. Maximo 10MB.', 'danger');
                return;
            }

            // Mostrar progresso
            uploadProgress.style.display = 'block';

            try {
                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch('/admin/upload/category-image', {
                    method: 'POST',
                    body: formData,
                });

                const data = await response.json();

                if (response.ok) {
                    // Atualizar URL e preview
                    imageUrlInput.value = data.url;
                    previewImg.src = data.url;
                    imagePreview.style.display = 'block';
                    showMessage('Imagem enviada com sucesso! (400x400 px)', 'success');
                } else {
                    showMessage(data.detail || 'Erro ao enviar imagem', 'danger');
                }
            } catch (error) {
                showMessage('Erro de conexao ao enviar imagem', 'danger');
                console.error('Upload error:', error);
            } finally {
                uploadProgress.style.display = 'none';
                fileInput.value = ''; // Reset para permitir reupload
            }
        });
    }

    // Contadores de caracteres SEO
    const seoTitle = document.getElementById('seo_title');
    const seoDesc = document.getElementById('seo_description');

    if (seoTitle) {
        seoTitle.addEventListener('input', function() {
            document.getElementById('seo_title_count').textContent = this.value.length;
        });
    }
    if (seoDesc) {
        seoDesc.addEventListener('input', function() {
            document.getElementById('seo_description_count').textContent = this.value.length;
        });
    }
});

// =============================================================================
// Geracao de SEO com IA
// =============================================================================

const fieldToUseCase = {
    'seo_title': 'seo_title',
    'seo_description': 'seo_description',
    'seo_focus_keyword': 'seo_keywords'
};

async function generateSEO(field) {
    const name = document.getElementById('name').value.trim();
    const description = document.getElementById('description').value.trim();

    if (!name && !description) {
        alert('Preencha o nome ou descricao antes de gerar SEO');
        return;
    }

    const useCase = fieldToUseCase[field] || field;
    const loadingDiv = document.getElementById('seo-loading');
    const targetInput = document.getElementById(field);

    loadingDiv.style.display = 'flex';
    targetInput.disabled = true;

    try {
        const response = await fetch('/admin/api/ai/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                use_case: useCase,
                title: name,
                content: description
            })
        });

        const data = await response.json();

        if (response.ok) {
            let generatedContent = data.generated_content;
            if (field === 'seo_focus_keyword') {
                generatedContent = generatedContent
                    .replace(/^(palavras?-?chave|keywords?|foco|principal)[:.\s-]*/i, '')
                    .split(/[,\n]/)[0]
                    .trim();
            }
            targetInput.value = generatedContent;
            const countSpan = document.getElementById(field + '_count');
            if (countSpan) {
                countSpan.textContent = generatedContent.length;
            }
        } else {
            alert('Erro ao gerar: ' + (data.detail || 'Erro desconhecido'));
        }
    } catch (error) {
        alert('Erro de conexao: ' + error.message);
    } finally {
        loadingDiv.style.display = 'none';
        targetInput.disabled = false;
    }
}

async function generateAllSEO() {
    const name = document.getElementById('name').value.trim();
    const description = document.getElementById('description').value.trim();

    if (!name && !description) {
        alert('Preencha o nome ou descricao antes de gerar SEO');
        return;
    }

    const loadingDiv = document.getElementById('seo-loading');
    const seoKeyword = document.getElementById('seo_focus_keyword');
    const seoTitle = document.getElementById('seo_title');
    const seoDescription = document.getElementById('seo_description');

    loadingDiv.style.display = 'flex';
    seoKeyword.disabled = true;
    seoTitle.disabled = true;
    seoDescription.disabled = true;

    try {
        const [keywordResponse, titleResponse, descResponse] = await Promise.all([
            fetch('/admin/api/ai/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    use_case: 'seo_keywords',
                    title: name,
                    content: description
                })
            }),
            fetch('/admin/api/ai/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    use_case: 'seo_title',
                    title: name,
                    content: description
                })
            }),
            fetch('/admin/api/ai/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    use_case: 'seo_description',
                    title: name,
                    content: description
                })
            })
        ]);

        const [keywordData, titleData, descData] = await Promise.all([
            keywordResponse.json(),
            titleResponse.json(),
            descResponse.json()
        ]);

        if (keywordResponse.ok) {
            let keyword = keywordData.generated_content
                .replace(/^(palavras?-?chave|keywords?|foco|principal)[:.\s-]*/i, '')
                .split(/[,\n]/)[0]
                .trim();
            seoKeyword.value = keyword;
        }

        if (titleResponse.ok) {
            seoTitle.value = titleData.generated_content;
            document.getElementById('seo_title_count').textContent = titleData.generated_content.length;
        }

        if (descResponse.ok) {
            seoDescription.value = descData.generated_content;
            document.getElementById('seo_description_count').textContent = descData.generated_content.length;
        }

        if (!keywordResponse.ok || !titleResponse.ok || !descResponse.ok) {
            alert('Alguns campos nao foram gerados. Verifique a configuracao de IA.');
        }
    } catch (error) {
        alert('Erro de conexao: ' + error.message);
    } finally {
        loadingDiv.style.display = 'none';
        seoKeyword.disabled = false;
        seoTitle.disabled = false;
        seoDescription.disabled = false;
    }
}
</script>
{% endblock %}
