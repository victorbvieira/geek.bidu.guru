{% extends "admin/base.html" %}

{% block title %}{{ 'Editar' if category else 'Nova' }} Categoria{% endblock %}

{% block breadcrumb %}
<span>/</span>
<a href="/admin/categories">Categorias</a>
<span>/</span>
<span class="current">{{ 'Editar' if category else 'Nova' }}</span>
{% endblock %}

{% block content %}
<div class="admin-page-header">
    <h1 class="admin-page-title">{{ 'Editar Categoria' if category else 'Nova Categoria' }}</h1>
</div>

<form method="POST" action="/admin/categories{{ '/' + category.id|string if category else '' }}" class="admin-form">
    <div class="admin-form-grid">
        <div class="admin-form-main">
            <div class="admin-card">
                <div class="admin-card-header">
                    <h3>Informacoes da Categoria</h3>
                </div>
                <div class="admin-card-body">
                    <div class="admin-form-group">
                        <label for="name" class="admin-label">Nome *</label>
                        <input
                            type="text"
                            id="name"
                            name="name"
                            value="{{ category.name if category else '' }}"
                            class="admin-input"
                            required
                        >
                    </div>

                    <div class="admin-form-group">
                        <label for="slug" class="admin-label">Slug</label>
                        <input
                            type="text"
                            id="slug"
                            name="slug"
                            value="{{ category.slug if category else '' }}"
                            class="admin-input"
                            pattern="[a-z0-9-]+"
                            placeholder="gerado-automaticamente"
                        >
                        <small class="admin-help-text">URL amigavel - deixe vazio para gerar automaticamente</small>
                    </div>

                    <div class="admin-form-group">
                        <label for="description" class="admin-label">Descricao</label>
                        <textarea
                            id="description"
                            name="description"
                            class="admin-textarea"
                            rows="4"
                            maxlength="500"
                            data-char-counter
                        >{{ category.description if category else '' }}</textarea>
                        <small class="admin-help-text">Descricao para SEO (max 500 caracteres)</small>
                    </div>
                </div>
            </div>

            <div class="admin-card">
                <div class="admin-card-header">
                    <h3>SEO</h3>
                    <button type="button" class="admin-btn admin-btn-sm admin-btn-secondary" onclick="generateAllSEO()" title="Gerar todos os campos SEO com IA">
                        ðŸ¤– Gerar Tudo
                    </button>
                </div>
                <div class="admin-card-body">
                    <div class="admin-form-group">
                        <label for="seo_focus_keyword" class="admin-label">
                            Palavra-chave foco
                            <button type="button" class="admin-btn-icon-sm" onclick="generateSEO('seo_focus_keyword')" title="Gerar com IA">ðŸ¤–</button>
                        </label>
                        <input
                            type="text"
                            id="seo_focus_keyword"
                            name="seo_focus_keyword"
                            value="{{ category.seo_focus_keyword if category and category.seo_focus_keyword else '' }}"
                            class="admin-input"
                            maxlength="100"
                            placeholder="Ex: presentes geek, funko pop"
                        >
                        <small class="admin-help-text">Palavra-chave principal para otimizacao SEO</small>
                    </div>

                    <div class="admin-form-group">
                        <label for="seo_title" class="admin-label">
                            Titulo SEO
                            <button type="button" class="admin-btn-icon-sm" onclick="generateSEO('seo_title')" title="Gerar com IA">ðŸ¤–</button>
                        </label>
                        <input
                            type="text"
                            id="seo_title"
                            name="seo_title"
                            value="{{ category.seo_title if category and category.seo_title else '' }}"
                            class="admin-input"
                            maxlength="60"
                        >
                        <small class="admin-help-text"><span id="seo_title_count">{{ (category.seo_title|length) if category and category.seo_title else 0 }}</span>/60 caracteres</small>
                    </div>

                    <div class="admin-form-group">
                        <label for="seo_description" class="admin-label">
                            Descricao SEO
                            <button type="button" class="admin-btn-icon-sm" onclick="generateSEO('seo_description')" title="Gerar com IA">ðŸ¤–</button>
                        </label>
                        <textarea
                            id="seo_description"
                            name="seo_description"
                            class="admin-textarea"
                            rows="2"
                            maxlength="160"
                        >{{ category.seo_description if category and category.seo_description else '' }}</textarea>
                        <small class="admin-help-text"><span id="seo_description_count">{{ (category.seo_description|length) if category and category.seo_description else 0 }}</span>/160 caracteres</small>
                    </div>
                </div>
            </div>
        </div>

        <div class="admin-form-sidebar">
            <div class="admin-card">
                <div class="admin-card-header">
                    <h3>Hierarquia</h3>
                </div>
                <div class="admin-card-body">
                    <div class="admin-form-group">
                        <label for="parent_id" class="admin-label">Categoria Pai</label>
                        <select id="parent_id" name="parent_id" class="admin-select">
                            <option value="">Nenhuma (categoria raiz)</option>
                            {% for cat in categories %}
                            <option
                                value="{{ cat.id }}"
                                {{ 'selected' if category and category.parent_id == cat.id else '' }}
                            >
                                {{ cat.name }}
                            </option>
                            {% endfor %}
                        </select>
                        <small class="admin-help-text">Selecione para criar subcategoria</small>
                    </div>
                </div>
            </div>

            <!-- Imagem do Card/Icone (400x400) -->
            <div class="admin-card">
                <div class="admin-card-header">
                    <h3>Imagem do Card</h3>
                </div>
                <div class="admin-card-body">
                    <div class="admin-form-group">
                        <label class="admin-label">Icone/Miniatura da Categoria</label>

                        <!-- Preview da imagem -->
                        <div id="image-preview" class="admin-image-preview" style="margin-bottom: 1rem; {% if not (category and category.image_url) %}display: none;{% endif %}">
                            <img
                                id="preview-img"
                                src="{{ category.image_url if category and category.image_url else '' }}"
                                alt="Preview"
                                style="max-width: 100%; border-radius: 4px;"
                            >
                        </div>

                        <div class="admin-upload-wrapper">
                            <input
                                type="file"
                                id="image_file"
                                accept="image/jpeg,image/png,image/webp,image/gif"
                                class="admin-file-input"
                                style="display: none;"
                            >
                            <button type="button" class="admin-btn admin-btn-secondary admin-btn-block" onclick="document.getElementById('image_file').click()">
                                {{ 'Trocar Imagem' if category and category.image_url else 'Escolher Imagem' }}
                            </button>
                            <small class="admin-help-text">Usada em cards de subcategoria. Redimensionada para 400x400 px. Max 10MB.</small>
                        </div>
                        <div id="upload-progress" style="display: none; margin-top: 0.5rem;">
                            <div class="admin-progress-bar">
                                <div class="admin-progress-fill" style="width: 0%"></div>
                            </div>
                            <small class="admin-help-text">Enviando...</small>
                        </div>
                    </div>

                    <!-- Hidden input para URL da imagem -->
                    <input
                        type="hidden"
                        id="image_url"
                        name="image_url"
                        value="{{ category.image_url if category and category.image_url else '' }}"
                    >
                </div>
            </div>

            <!-- Imagem do Header/Banner (1920x400) -->
            <div class="admin-card">
                <div class="admin-card-header">
                    <h3>Imagem do Header</h3>
                </div>
                <div class="admin-card-body">
                    <div class="admin-form-group">
                        <label class="admin-label">Banner de Fundo da Pagina</label>

                        <!-- Preview da imagem do header -->
                        <div id="header-image-preview" class="admin-image-preview" style="margin-bottom: 1rem; {% if not (category and category.header_image_url) %}display: none;{% endif %}">
                            <img
                                id="header-preview-img"
                                src="{{ category.header_image_url if category and category.header_image_url else '' }}"
                                alt="Preview Header"
                                style="max-width: 100%; border-radius: 4px; aspect-ratio: 4.8/1; object-fit: cover;"
                            >
                        </div>

                        <div class="admin-upload-wrapper">
                            <input
                                type="file"
                                id="header_image_file"
                                accept="image/jpeg,image/png,image/webp,image/gif"
                                class="admin-file-input"
                                style="display: none;"
                            >
                            <button type="button" class="admin-btn admin-btn-secondary admin-btn-block" onclick="document.getElementById('header_image_file').click()">
                                {{ 'Trocar Banner' if category and category.header_image_url else 'Escolher Banner' }}
                            </button>
                            <small class="admin-help-text">
                                <strong>Tamanho recomendado: 1920x400 px</strong><br>
                                Aparece como fundo do header da pagina de categoria.<br>
                                Responsivo: adapta automaticamente para mobile/tablet/desktop.<br>
                                Max 10MB.
                            </small>
                        </div>
                        <div id="header-upload-progress" style="display: none; margin-top: 0.5rem;">
                            <div class="admin-progress-bar">
                                <div class="admin-progress-fill" style="width: 0%"></div>
                            </div>
                            <small class="admin-help-text">Enviando...</small>
                        </div>
                    </div>

                    <!-- Hidden input para URL da imagem do header -->
                    <input
                        type="hidden"
                        id="header_image_url"
                        name="header_image_url"
                        value="{{ category.header_image_url if category and category.header_image_url else '' }}"
                    >
                </div>
            </div>

            <!-- Tags -->
            <div class="admin-card">
                <div class="admin-card-body">
                    <div class="admin-form-group" style="margin-bottom: 0;">
                        <label for="tags" class="admin-label">
                            Tags
                            <button type="button" class="admin-btn-icon-sm" onclick="generateTags()" title="Gerar com IA">ðŸ¤–</button>
                        </label>
                        <input
                            type="text"
                            id="tags"
                            name="tags"
                            class="admin-input"
                            value="{{ category.tags | join(', ') if category and category.tags else '' }}"
                            placeholder="tag1, tag2, tag3"
                        >
                        <small class="admin-help-text">Separadas por virgula</small>
                    </div>
                </div>
            </div>

            <!-- Custos de IA -->
            {% if category %}
            <div class="admin-card" style="background: var(--admin-bg-tertiary);">
                <h4 style="margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
                    <span>ðŸ’°</span> Custos de IA
                </h4>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; text-align: center; margin-bottom: 0.75rem;">
                    <div style="background: var(--admin-bg-secondary); padding: 0.5rem; border-radius: 4px;">
                        <div id="ai-prompt-tokens-display" style="font-size: 1rem; font-weight: bold; color: var(--admin-warning);">
                            {{ "{:,}".format(category.ai_prompt_tokens) }}
                        </div>
                        <div style="font-size: 0.65rem; color: var(--admin-text-muted);">Entrada</div>
                    </div>
                    <div style="background: var(--admin-bg-secondary); padding: 0.5rem; border-radius: 4px;">
                        <div id="ai-completion-tokens-display" style="font-size: 1rem; font-weight: bold; color: var(--admin-info);">
                            {{ "{:,}".format(category.ai_completion_tokens) }}
                        </div>
                        <div style="font-size: 0.65rem; color: var(--admin-text-muted);">Saida</div>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; text-align: center;">
                    <div>
                        <div id="ai-tokens-display" style="font-size: 1.1rem; font-weight: bold; color: var(--admin-primary);">
                            {{ "{:,}".format(category.ai_tokens_used) }}
                        </div>
                        <div style="font-size: 0.65rem; color: var(--admin-text-muted);">Total</div>
                    </div>
                    <div>
                        <div id="ai-cost-display" style="font-size: 1.1rem; font-weight: bold; color: var(--admin-success);">
                            ${{ "%.6f"|format(category.ai_cost_usd|float) }}
                        </div>
                        <div style="font-size: 0.65rem; color: var(--admin-text-muted);">Custo</div>
                    </div>
                    <div>
                        <div id="ai-generations-display" style="font-size: 1.1rem; font-weight: bold; color: var(--admin-text);">
                            {{ category.ai_generations_count }}
                        </div>
                        <div style="font-size: 0.65rem; color: var(--admin-text-muted);">Chamadas</div>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="admin-card" style="background: var(--admin-bg-tertiary); opacity: 0.6;">
                <h4 style="margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                    <span>ðŸ’°</span> Custos de IA
                </h4>
                <p style="font-size: 0.8rem; color: var(--admin-text-muted); margin: 0;">
                    Salve a categoria para acompanhar custos de IA
                </p>
            </div>
            {% endif %}

            {% if category %}
            <div class="admin-card">
                <div class="admin-card-header">
                    <h3>Informacoes</h3>
                </div>
                <div class="admin-card-body">
                    <div class="admin-info-item">
                        <span class="admin-info-label">Criado em:</span>
                        <span class="admin-info-value">{{ category.created_at.strftime('%d/%m/%Y %H:%M') }}</span>
                    </div>
                    <div class="admin-info-item">
                        <span class="admin-info-label">Atualizado em:</span>
                        <span class="admin-info-value">{{ category.updated_at.strftime('%d/%m/%Y %H:%M') if category.updated_at else '-' }}</span>
                    </div>
                    <div class="admin-info-item">
                        <span class="admin-info-label">Posts:</span>
                        <span class="admin-info-value">{{ category.posts | length if category.posts else 0 }}</span>
                    </div>
                </div>
            </div>
            {% endif %}

            <div class="admin-form-actions">
                <button type="submit" class="admin-btn admin-btn-primary admin-btn-block">
                    {{ 'Salvar Alteracoes' if category else 'Criar Categoria' }}
                </button>
                <a href="/admin/categories" class="admin-btn admin-btn-secondary admin-btn-block">
                    Cancelar
                </a>
            </div>
        </div>
    </div>
</form>

<!-- Modal de Loading IA -->
<div id="ai-loading-modal" class="ai-loading-modal">
    <div class="ai-loading-backdrop"></div>
    <div class="ai-loading-content">
        <div class="ai-loading-spinner"></div>
        <div class="ai-loading-text">Gerando com IA...</div>
        <div class="ai-loading-subtext">Aguarde, isso pode levar alguns segundos</div>
    </div>
</div>

<!-- Modal de Notificacao (Toast) -->
<div id="notification-modal" class="notification-modal">
    <div class="notification-content">
        <div class="notification-icon">
            <span class="icon-success">âœ“</span>
            <span class="icon-error">âœ•</span>
            <span class="icon-warning">âš </span>
            <span class="icon-info">â„¹</span>
        </div>
        <div class="notification-body">
            <div class="notification-title"></div>
            <div class="notification-message"></div>
        </div>
        <button type="button" class="notification-close" onclick="hideNotification()">&times;</button>
    </div>
    <div class="notification-progress"></div>
</div>

<style>
/* =============================================================================
   Modal de Notificacao (Toast Elegante)
   ============================================================================= */

.notification-modal {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 10000;
    min-width: 320px;
    max-width: 450px;
    background: var(--admin-card-bg, #1E293B);
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3), 0 0 0 1px rgba(255, 255, 255, 0.05);
    transform: translateX(120%);
    opacity: 0;
    transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    overflow: hidden;
}

.notification-modal.active {
    transform: translateX(0);
    opacity: 1;
}

.notification-content {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 16px 20px;
}

.notification-icon {
    flex-shrink: 0;
    width: 40px;
    height: 40px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
    font-weight: bold;
}

.notification-icon span {
    display: none;
}

/* Icone de sucesso */
.notification-modal.success .notification-icon {
    background: linear-gradient(135deg, #10B981 0%, #059669 100%);
    color: white;
}
.notification-modal.success .icon-success { display: block; }

/* Icone de erro */
.notification-modal.error .notification-icon,
.notification-modal.danger .notification-icon {
    background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
    color: white;
}
.notification-modal.error .icon-error,
.notification-modal.danger .icon-error { display: block; }

/* Icone de aviso */
.notification-modal.warning .notification-icon {
    background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
    color: white;
}
.notification-modal.warning .icon-warning { display: block; }

/* Icone de info */
.notification-modal.info .notification-icon {
    background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%);
    color: white;
}
.notification-modal.info .icon-info { display: block; }

.notification-body {
    flex: 1;
    min-width: 0;
}

.notification-title {
    font-weight: 600;
    font-size: 0.95rem;
    color: var(--admin-text, #F9FAFB);
    margin-bottom: 4px;
}

.notification-message {
    font-size: 0.85rem;
    color: var(--admin-text-muted, #9CA3AF);
    line-height: 1.4;
    word-wrap: break-word;
}

.notification-close {
    flex-shrink: 0;
    width: 28px;
    height: 28px;
    border: none;
    background: rgba(255, 255, 255, 0.1);
    color: var(--admin-text-muted, #9CA3AF);
    border-radius: 6px;
    cursor: pointer;
    font-size: 1.1rem;
    line-height: 1;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
}

.notification-close:hover {
    background: rgba(255, 255, 255, 0.2);
    color: var(--admin-text, #F9FAFB);
}

/* Barra de progresso */
.notification-progress {
    height: 3px;
    background: rgba(255, 255, 255, 0.1);
    position: relative;
    overflow: hidden;
}

.notification-progress::after {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    height: 100%;
    width: 100%;
    transform-origin: left;
    animation: notification-timer 4s linear forwards;
}

.notification-modal.success .notification-progress::after {
    background: linear-gradient(90deg, #10B981, #059669);
}
.notification-modal.error .notification-progress::after,
.notification-modal.danger .notification-progress::after {
    background: linear-gradient(90deg, #EF4444, #DC2626);
}
.notification-modal.warning .notification-progress::after {
    background: linear-gradient(90deg, #F59E0B, #D97706);
}
.notification-modal.info .notification-progress::after {
    background: linear-gradient(90deg, #3B82F6, #2563EB);
}

@keyframes notification-timer {
    from { transform: scaleX(1); }
    to { transform: scaleX(0); }
}

/* Responsivo */
@media (max-width: 480px) {
    .notification-modal {
        left: 10px;
        right: 10px;
        min-width: auto;
        max-width: none;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// =============================================================================
// Variaveis globais
// =============================================================================

const categoryId = '{{ category.id if category else "" }}';

let localTokensUsed = {{ category.ai_tokens_used if category else 0 }};
let localPromptTokens = {{ category.ai_prompt_tokens if category else 0 }};
let localCompletionTokens = {{ category.ai_completion_tokens if category else 0 }};
let localCostUsd = {{ category.ai_cost_usd|float if category else 0 }};
let localGenerationsCount = {{ category.ai_generations_count if category else 0 }};

// =============================================================================
// Funcoes auxiliares
// =============================================================================

function generateSlug(text) {
    return text
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/[^\w\s-]/g, '')
        .replace(/\s+/g, '-')
        .replace(/-+/g, '-')
        .trim();
}

// =============================================================================
// Modal de Notificacao (Toast)
// =============================================================================

let notificationTimeout = null;
const notificationModal = document.getElementById('notification-modal');

/**
 * Exibe uma notificacao elegante no canto superior direito.
 *
 * @param {string} message - Mensagem principal da notificacao
 * @param {string} type - Tipo: 'success', 'error', 'danger', 'warning', 'info'
 * @param {string} title - Titulo opcional (gerado automaticamente se nao fornecido)
 * @param {number} duration - Duracao em ms (padrao: 4000)
 */
function showMessage(message, type = 'info', title = null, duration = 4000) {
    if (!notificationModal) {
        // Fallback para alert se o modal nao existir
        alert(message);
        return;
    }

    // Limpa timeout anterior se existir
    if (notificationTimeout) {
        clearTimeout(notificationTimeout);
    }

    // Define titulo padrao baseado no tipo
    const defaultTitles = {
        success: 'Sucesso!',
        error: 'Erro',
        danger: 'Erro',
        warning: 'Atencao',
        info: 'Informacao'
    };

    const titleText = title || defaultTitles[type] || 'Notificacao';

    // Atualiza conteudo
    const titleEl = notificationModal.querySelector('.notification-title');
    const messageEl = notificationModal.querySelector('.notification-message');

    if (titleEl) titleEl.textContent = titleText;
    if (messageEl) messageEl.textContent = message;

    // Remove classes anteriores e adiciona a nova
    notificationModal.classList.remove('success', 'error', 'danger', 'warning', 'info', 'active');
    notificationModal.classList.add(type);

    // Reinicia animacao da barra de progresso
    const progressBar = notificationModal.querySelector('.notification-progress');
    if (progressBar) {
        progressBar.style.animation = 'none';
        progressBar.offsetHeight; // Trigger reflow
        progressBar.style.animation = '';

        // Ajusta duracao da animacao
        const afterStyle = document.createElement('style');
        afterStyle.id = 'notification-progress-style';
        const existingStyle = document.getElementById('notification-progress-style');
        if (existingStyle) existingStyle.remove();

        afterStyle.textContent = `
            .notification-progress::after {
                animation-duration: ${duration}ms !important;
            }
        `;
        document.head.appendChild(afterStyle);
    }

    // Exibe o modal com pequeno delay para garantir transicao
    requestAnimationFrame(() => {
        notificationModal.classList.add('active');
    });

    // Auto-hide apos duracao
    notificationTimeout = setTimeout(() => {
        hideNotification();
    }, duration);
}

/**
 * Esconde a notificacao atual.
 */
function hideNotification() {
    if (!notificationModal) return;

    notificationModal.classList.remove('active');

    if (notificationTimeout) {
        clearTimeout(notificationTimeout);
        notificationTimeout = null;
    }
}

// =============================================================================
// Modal de Loading IA
// =============================================================================

const aiLoadingModal = document.getElementById('ai-loading-modal');

function showAILoading(text = 'Gerando com IA...') {
    if (!aiLoadingModal) return;
    const textEl = aiLoadingModal.querySelector('.ai-loading-text');
    if (textEl) textEl.textContent = text;
    aiLoadingModal.classList.add('active');
    document.body.style.overflow = 'hidden';
}

function hideAILoading() {
    if (!aiLoadingModal) return;
    aiLoadingModal.classList.remove('active');
    document.body.style.overflow = '';
}

// =============================================================================
// Atualizar custos de IA
// =============================================================================

async function updateCategoryAICost(tokensUsed, promptTokens, completionTokens, costUsd) {
    if (!categoryId) return;

    try {
        await fetch(`/admin/api/categories/${categoryId}/ai-cost`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                tokens_used: tokensUsed,
                prompt_tokens: promptTokens,
                completion_tokens: completionTokens,
                cost_usd: costUsd
            })
        });
    } catch (error) {
        console.error('Erro ao salvar custos de IA:', error);
    }
}

function updateCostDisplay(tokensUsed, promptTokens, completionTokens, costUsd) {
    localTokensUsed += tokensUsed || 0;
    localPromptTokens += promptTokens || 0;
    localCompletionTokens += completionTokens || 0;
    localCostUsd += costUsd || 0;
    localGenerationsCount += 1;

    const tokensDisplay = document.getElementById('ai-tokens-display');
    const promptDisplay = document.getElementById('ai-prompt-tokens-display');
    const completionDisplay = document.getElementById('ai-completion-tokens-display');
    const costDisplay = document.getElementById('ai-cost-display');
    const genDisplay = document.getElementById('ai-generations-display');

    if (tokensDisplay) tokensDisplay.textContent = localTokensUsed.toLocaleString('pt-BR');
    if (promptDisplay) promptDisplay.textContent = localPromptTokens.toLocaleString('pt-BR');
    if (completionDisplay) completionDisplay.textContent = localCompletionTokens.toLocaleString('pt-BR');
    if (costDisplay) costDisplay.textContent = '$' + localCostUsd.toFixed(6);
    if (genDisplay) genDisplay.textContent = localGenerationsCount;
}

// =============================================================================
// Inicializacao
// =============================================================================

document.addEventListener('DOMContentLoaded', function() {
    // Auto-preenchimento de slug a partir do nome
    const nameInput = document.getElementById('name');
    const slugInput = document.getElementById('slug');

    if (nameInput && slugInput) {
        const isNewCategory = !slugInput.value;

        nameInput.addEventListener('input', function() {
            if (isNewCategory && !slugInput.dataset.manual) {
                slugInput.value = generateSlug(this.value);
            }
        });

        slugInput.addEventListener('input', function() {
            if (this.value) {
                this.dataset.manual = 'true';
            } else {
                delete this.dataset.manual;
            }
        });
    }

    // Upload de imagem
    const fileInput = document.getElementById('image_file');
    const imageUrlInput = document.getElementById('image_url');
    const imagePreview = document.getElementById('image-preview');
    const previewImg = document.getElementById('preview-img');
    const uploadProgress = document.getElementById('upload-progress');

    if (fileInput) {
        fileInput.addEventListener('change', async function() {
            const file = this.files[0];
            if (!file) return;

            const allowedTypes = ['image/jpeg', 'image/png', 'image/webp', 'image/gif'];
            if (!allowedTypes.includes(file.type)) {
                showMessage('Tipo de arquivo nao permitido. Use JPG, PNG, WebP ou GIF.', 'danger');
                return;
            }

            if (file.size > 10 * 1024 * 1024) {
                showMessage('Arquivo muito grande. Maximo 10MB.', 'danger');
                return;
            }

            uploadProgress.style.display = 'block';

            try {
                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch('/admin/upload/category-image', {
                    method: 'POST',
                    body: formData,
                });

                const data = await response.json();

                if (response.ok) {
                    imageUrlInput.value = data.url;
                    previewImg.src = data.url;
                    imagePreview.style.display = 'block';
                    showMessage('Imagem enviada com sucesso! (400x400 px)', 'success');
                } else {
                    showMessage(data.detail || 'Erro ao enviar imagem', 'danger');
                }
            } catch (error) {
                showMessage('Erro de conexao ao enviar imagem', 'danger');
                console.error('Upload error:', error);
            } finally {
                uploadProgress.style.display = 'none';
                fileInput.value = '';
            }
        });
    }

    // Upload de imagem do header (banner)
    const headerFileInput = document.getElementById('header_image_file');
    const headerImageUrlInput = document.getElementById('header_image_url');
    const headerImagePreview = document.getElementById('header-image-preview');
    const headerPreviewImg = document.getElementById('header-preview-img');
    const headerUploadProgress = document.getElementById('header-upload-progress');

    if (headerFileInput) {
        headerFileInput.addEventListener('change', async function() {
            const file = this.files[0];
            if (!file) return;

            const allowedTypes = ['image/jpeg', 'image/png', 'image/webp', 'image/gif'];
            if (!allowedTypes.includes(file.type)) {
                showMessage('Tipo de arquivo nao permitido. Use JPG, PNG, WebP ou GIF.', 'danger');
                return;
            }

            if (file.size > 10 * 1024 * 1024) {
                showMessage('Arquivo muito grande. Maximo 10MB.', 'danger');
                return;
            }

            headerUploadProgress.style.display = 'block';

            try {
                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch('/admin/upload/category-header-image', {
                    method: 'POST',
                    body: formData,
                });

                const data = await response.json();

                if (response.ok) {
                    headerImageUrlInput.value = data.url;
                    headerPreviewImg.src = data.url;
                    headerImagePreview.style.display = 'block';
                    showMessage('Imagem do header enviada com sucesso! (1920x400 px)', 'success');
                } else {
                    showMessage(data.detail || 'Erro ao enviar imagem do header', 'danger');
                }
            } catch (error) {
                showMessage('Erro de conexao ao enviar imagem do header', 'danger');
                console.error('Header upload error:', error);
            } finally {
                headerUploadProgress.style.display = 'none';
                headerFileInput.value = '';
            }
        });
    }

    // Contadores de caracteres SEO
    const seoTitle = document.getElementById('seo_title');
    const seoDesc = document.getElementById('seo_description');

    if (seoTitle) {
        seoTitle.addEventListener('input', function() {
            document.getElementById('seo_title_count').textContent = this.value.length;
        });
    }
    if (seoDesc) {
        seoDesc.addEventListener('input', function() {
            document.getElementById('seo_description_count').textContent = this.value.length;
        });
    }
});

// =============================================================================
// Geracao de SEO com IA
// =============================================================================

const fieldToUseCase = {
    'seo_title': 'category_seo_title',
    'seo_description': 'category_seo_description',
    'seo_focus_keyword': 'category_seo_keyword'
};

async function generateSEO(field) {
    const name = document.getElementById('name').value.trim();
    const description = document.getElementById('description').value.trim();

    if (!name) {
        alert('Preencha o nome da categoria antes de gerar SEO');
        return;
    }

    const useCase = fieldToUseCase[field] || field;
    const targetInput = document.getElementById(field);

    const fieldLabels = {
        'seo_focus_keyword': 'Gerando palavra-chave...',
        'seo_title': 'Gerando titulo SEO...',
        'seo_description': 'Gerando descricao SEO...'
    };
    showAILoading(fieldLabels[field] || 'Gerando com IA...');

    try {
        const response = await fetch('/admin/api/ai/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                use_case: useCase,
                title: name,
                content: description
            })
        });

        const data = await response.json();

        if (response.ok) {
            let generatedContent = data.generated_content;
            if (field === 'seo_focus_keyword') {
                generatedContent = generatedContent
                    .replace(/^(palavras?-?chave|keywords?|foco|principal)[:.\s-]*/i, '')
                    .split(/[,\n]/)[0]
                    .trim();
            }
            targetInput.value = generatedContent;
            const countSpan = document.getElementById(field + '_count');
            if (countSpan) {
                countSpan.textContent = generatedContent.length;
            }
            updateCostDisplay(data.tokens_used || 0, data.prompt_tokens || 0, data.completion_tokens || 0, data.cost_usd || 0);
            await updateCategoryAICost(data.tokens_used || 0, data.prompt_tokens || 0, data.completion_tokens || 0, data.cost_usd || 0);
        } else {
            alert('Erro ao gerar: ' + (data.detail || 'Erro desconhecido'));
        }
    } catch (error) {
        alert('Erro de conexao: ' + error.message);
    } finally {
        hideAILoading();
    }
}

async function generateAllSEO() {
    const name = document.getElementById('name').value.trim();
    const description = document.getElementById('description').value.trim();

    if (!name) {
        alert('Preencha o nome da categoria antes de gerar SEO');
        return;
    }

    const seoKeyword = document.getElementById('seo_focus_keyword');
    const seoTitle = document.getElementById('seo_title');
    const seoDescription = document.getElementById('seo_description');
    const tagsInput = document.getElementById('tags');

    showAILoading('Gerando SEO completo...');

    const requestBody = {
        title: name,
        content: description
    };

    try {
        const [keywordResponse, titleResponse, descResponse, tagsResponse] = await Promise.all([
            fetch('/admin/api/ai/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ...requestBody, use_case: 'category_seo_keyword' })
            }),
            fetch('/admin/api/ai/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ...requestBody, use_case: 'category_seo_title' })
            }),
            fetch('/admin/api/ai/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ...requestBody, use_case: 'category_seo_description' })
            }),
            fetch('/admin/api/ai/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ...requestBody, use_case: 'category_tags' })
            })
        ]);

        const [keywordData, titleData, descData, tagsData] = await Promise.all([
            keywordResponse.json(),
            titleResponse.json(),
            descResponse.json(),
            tagsResponse.json()
        ]);

        if (keywordResponse.ok) {
            let keyword = keywordData.generated_content
                .replace(/^(palavras?-?chave|keywords?|foco|principal)[:.\s-]*/i, '')
                .split(/[,\n]/)[0]
                .trim();
            seoKeyword.value = keyword;
        }

        if (titleResponse.ok) {
            seoTitle.value = titleData.generated_content;
            document.getElementById('seo_title_count').textContent = titleData.generated_content.length;
        }

        if (descResponse.ok) {
            seoDescription.value = descData.generated_content;
            document.getElementById('seo_description_count').textContent = descData.generated_content.length;
        }

        if (tagsResponse.ok) {
            let tags = tagsData.generated_content
                .replace(/^(tags?|sugest[oÃµ]es?)[:.\s-]*/i, '')
                .split(/[,\n]/)
                .map(t => t.trim().toLowerCase())
                .filter(t => t.length > 0)
                .join(', ');
            tagsInput.value = tags;
        }

        // Salva custos
        if (keywordResponse.ok) {
            updateCostDisplay(keywordData.tokens_used || 0, keywordData.prompt_tokens || 0, keywordData.completion_tokens || 0, keywordData.cost_usd || 0);
            await updateCategoryAICost(keywordData.tokens_used || 0, keywordData.prompt_tokens || 0, keywordData.completion_tokens || 0, keywordData.cost_usd || 0);
        }
        if (titleResponse.ok) {
            updateCostDisplay(titleData.tokens_used || 0, titleData.prompt_tokens || 0, titleData.completion_tokens || 0, titleData.cost_usd || 0);
            await updateCategoryAICost(titleData.tokens_used || 0, titleData.prompt_tokens || 0, titleData.completion_tokens || 0, titleData.cost_usd || 0);
        }
        if (descResponse.ok) {
            updateCostDisplay(descData.tokens_used || 0, descData.prompt_tokens || 0, descData.completion_tokens || 0, descData.cost_usd || 0);
            await updateCategoryAICost(descData.tokens_used || 0, descData.prompt_tokens || 0, descData.completion_tokens || 0, descData.cost_usd || 0);
        }
        if (tagsResponse.ok) {
            updateCostDisplay(tagsData.tokens_used || 0, tagsData.prompt_tokens || 0, tagsData.completion_tokens || 0, tagsData.cost_usd || 0);
            await updateCategoryAICost(tagsData.tokens_used || 0, tagsData.prompt_tokens || 0, tagsData.completion_tokens || 0, tagsData.cost_usd || 0);
        }

        if (!keywordResponse.ok || !titleResponse.ok || !descResponse.ok || !tagsResponse.ok) {
            alert('Alguns campos nao foram gerados. Verifique a configuracao de IA.');
        }
    } catch (error) {
        alert('Erro de conexao: ' + error.message);
    } finally {
        hideAILoading();
    }
}

// =============================================================================
// Geracao de Tags com IA
// =============================================================================

async function generateTags() {
    const name = document.getElementById('name').value.trim();
    const description = document.getElementById('description').value.trim();

    if (!name) {
        alert('Preencha o nome da categoria antes de gerar tags');
        return;
    }

    const tagsInput = document.getElementById('tags');

    showAILoading('Gerando tags...');

    try {
        const response = await fetch('/admin/api/ai/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                use_case: 'category_tags',
                title: name,
                content: description
            })
        });

        const data = await response.json();

        if (response.ok) {
            let tags = data.generated_content
                .replace(/^(tags?|sugest[oÃµ]es?)[:.\s-]*/i, '')
                .split(/[,\n]/)
                .map(t => t.trim().toLowerCase())
                .filter(t => t.length > 0)
                .join(', ');
            tagsInput.value = tags;
            updateCostDisplay(data.tokens_used || 0, data.prompt_tokens || 0, data.completion_tokens || 0, data.cost_usd || 0);
            await updateCategoryAICost(data.tokens_used || 0, data.prompt_tokens || 0, data.completion_tokens || 0, data.cost_usd || 0);
        } else {
            alert('Erro ao gerar: ' + (data.detail || 'Erro desconhecido'));
        }
    } catch (error) {
        alert('Erro de conexao: ' + error.message);
    } finally {
        hideAILoading();
    }
}
</script>
{% endblock %}
