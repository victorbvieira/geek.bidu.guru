{% extends "admin/base.html" %}

{% block title %}{{ 'Editar' if occasion else 'Nova' }} Ocasiao{% endblock %}

{% block breadcrumb %}
<span>/</span>
<a href="/admin/occasions">Ocasioes</a>
<span>/</span>
<span class="current">{{ 'Editar' if occasion else 'Nova' }}</span>
{% endblock %}

{% block content %}
<div class="admin-page-header">
    <h1 class="admin-page-title">{{ 'Editar Ocasiao' if occasion else 'Nova Ocasiao' }}</h1>
</div>

<form method="POST" action="{{ '/admin/occasions/' ~ occasion.id if occasion else '/admin/occasions' }}" class="admin-form">
    <div class="admin-form-grid">
        <!-- Main Content -->
        <div class="admin-form-main">
            <div class="admin-card">
                <div class="admin-form-group">
                    <label for="name" class="admin-form-label">Nome da Ocasiao *</label>
                    <input
                        type="text"
                        id="name"
                        name="name"
                        class="admin-form-input"
                        value="{{ occasion.name if occasion else '' }}"
                        required
                    >
                </div>

                <div class="admin-form-group">
                    <label for="slug" class="admin-form-label">Slug</label>
                    <input
                        type="text"
                        id="slug"
                        name="slug"
                        class="admin-form-input"
                        value="{{ occasion.slug if occasion else '' }}"
                        placeholder="gerado-automaticamente"
                    >
                    <div class="admin-form-hint">URL: /ocasiao/{{ occasion.slug if occasion else 'seu-slug' }}</div>
                </div>

                <div class="admin-form-group">
                    <label for="description" class="admin-form-label">Descricao Curta</label>
                    <textarea
                        id="description"
                        name="description"
                        class="admin-form-textarea"
                        rows="2"
                        placeholder="Descricao breve para listagens (max 200 caracteres)"
                        maxlength="200"
                    >{{ occasion.description if occasion else '' }}</textarea>
                    <div class="admin-form-hint">Exibida em cards e listagens</div>
                </div>

                <div class="admin-form-group">
                    <label for="icon" class="admin-form-label">Icone (Emoji)</label>
                    <input
                        type="text"
                        id="icon"
                        name="icon"
                        class="admin-form-input"
                        value="{{ occasion.icon if occasion else '' }}"
                        placeholder="Ex: ðŸŽ„ ðŸŽ‚ ðŸ’"
                        style="max-width: 150px;"
                    >
                    <div class="admin-form-hint">Use um emoji para representar a ocasiao</div>
                </div>
            </div>

            <!-- Conteudo Markdown -->
            <div class="admin-card">
                <div class="admin-card-header">
                    <h3 class="admin-card-title">Conteudo</h3>
                </div>

                <div class="admin-form-group">
                    <label for="content" class="admin-form-label">Conteudo (Markdown)</label>
                    <div class="markdown-editor">
                        <div class="markdown-toolbar">
                            <button type="button" class="md-btn" data-action="bold" title="Negrito (Ctrl+B)"><strong>B</strong></button>
                            <button type="button" class="md-btn" data-action="italic" title="Italico (Ctrl+I)"><em>I</em></button>
                            <button type="button" class="md-btn" data-action="heading" title="Titulo">H</button>
                            <button type="button" class="md-btn" data-action="link" title="Link">ðŸ”—</button>
                            <button type="button" class="md-btn" data-action="image" title="Imagem">ðŸ–¼</button>
                            <button type="button" class="md-btn" data-action="list" title="Lista">â€¢</button>
                            <button type="button" class="md-btn" data-action="olist" title="Lista numerada">1.</button>
                            <button type="button" class="md-btn" data-action="quote" title="Citacao">"</button>
                            <button type="button" class="md-btn" data-action="code" title="Codigo">&lt;/&gt;</button>
                            <span class="md-toolbar-separator"></span>
                            <button type="button" class="md-btn md-btn-product" data-action="product" title="Inserir Produto">ðŸ›’ Produto</button>
                            <span class="md-toolbar-separator"></span>
                            <button type="button" class="md-btn md-btn-preview" data-action="preview" title="Preview">Preview</button>
                        </div>
                        <div class="markdown-panels">
                            <textarea
                                id="content"
                                name="content"
                                class="admin-form-textarea markdown-input"
                            >{{ occasion.content if occasion else '' }}</textarea>
                            <div class="markdown-preview" id="markdown-preview">
                                <p class="preview-placeholder">Clique em "Preview" para visualizar</p>
                            </div>
                        </div>
                    </div>
                    <div class="admin-form-hint">
                        Suporta Markdown: **negrito**, *italico*, # titulo, [link](url), ![imagem](url)<br>
                        <strong>Produtos:</strong> Use <code>[product:slug-do-produto]</code> para inserir um card de produto no conteudo
                    </div>
                </div>
            </div>

            <!-- SEO -->
            <div class="admin-card">
                <div class="admin-card-header">
                    <h3 class="admin-card-title">SEO</h3>
                    <button type="button" class="admin-btn admin-btn-sm admin-btn-secondary" onclick="generateAllSEO()" title="Gerar todos os campos SEO com IA">
                        ðŸ¤– Gerar Tudo
                    </button>
                </div>

                <div class="admin-form-group">
                    <label for="seo_focus_keyword" class="admin-form-label">
                        Palavra-chave foco
                        <button type="button" class="admin-btn-icon-sm" onclick="generateSEO('seo_focus_keyword')" title="Gerar com IA">ðŸ¤–</button>
                    </label>
                    <input
                        type="text"
                        id="seo_focus_keyword"
                        name="seo_focus_keyword"
                        class="admin-form-input"
                        value="{{ occasion.seo_focus_keyword if occasion else '' }}"
                        placeholder="Ex: presentes de natal geek"
                        maxlength="100"
                    >
                    <div class="admin-form-hint">Palavra-chave principal para otimizacao SEO</div>
                </div>

                <div class="admin-form-group">
                    <label for="seo_title" class="admin-form-label">
                        Titulo SEO
                        <button type="button" class="admin-btn-icon-sm" onclick="generateSEO('seo_title')" title="Gerar com IA">ðŸ¤–</button>
                    </label>
                    <input
                        type="text"
                        id="seo_title"
                        name="seo_title"
                        class="admin-form-input"
                        value="{{ occasion.seo_title if occasion else '' }}"
                        maxlength="60"
                    >
                    <div class="admin-form-hint"><span id="seo_title_count">{{ (occasion.seo_title|length) if occasion and occasion.seo_title else 0 }}</span>/60 caracteres</div>
                </div>

                <div class="admin-form-group">
                    <label for="seo_description" class="admin-form-label">
                        Descricao SEO
                        <button type="button" class="admin-btn-icon-sm" onclick="generateSEO('seo_description')" title="Gerar com IA">ðŸ¤–</button>
                    </label>
                    <textarea
                        id="seo_description"
                        name="seo_description"
                        class="admin-form-textarea"
                        style="min-height: 80px;"
                        maxlength="160"
                    >{{ occasion.seo_description if occasion else '' }}</textarea>
                    <div class="admin-form-hint"><span id="seo_description_count">{{ (occasion.seo_description|length) if occasion and occasion.seo_description else 0 }}</span>/160 caracteres</div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="admin-form-sidebar">
            <!-- Status e Ordem -->
            <div class="admin-card">
                <div class="admin-form-group">
                    <label class="admin-checkbox">
                        <input
                            type="checkbox"
                            name="is_active"
                            {% if not occasion or occasion.is_active %}checked{% endif %}
                        >
                        <span>Ocasiao ativa</span>
                    </label>
                    <div class="admin-form-hint">Ocasioes inativas nao aparecem no site</div>
                </div>

                <div class="admin-form-group">
                    <label for="display_order" class="admin-form-label">Ordem de Exibicao</label>
                    <input
                        type="number"
                        id="display_order"
                        name="display_order"
                        class="admin-form-input"
                        value="{{ occasion.display_order if occasion else 0 }}"
                        min="0"
                    >
                    <div class="admin-form-hint">Menor numero aparece primeiro</div>
                </div>

                <div class="admin-form-actions" style="flex-direction: row;">
                    <button type="submit" class="admin-btn admin-btn-primary" style="flex: 1;">
                        {{ 'Salvar' if occasion else 'Criar Ocasiao' }}
                    </button>
                    {% if occasion %}
                    <a href="/ocasiao/{{ occasion.slug }}" target="_blank" class="admin-btn admin-btn-secondary">
                        Ver
                    </a>
                    {% endif %}
                </div>
            </div>

            <!-- Proxima Revisao -->
            <div class="admin-card">
                <div class="admin-card-header">
                    <h3 class="admin-card-title">Revisao</h3>
                </div>

                <div class="admin-form-group">
                    <label for="next_review_date" class="admin-form-label">Proxima Revisao</label>
                    <input
                        type="month"
                        id="next_review_date"
                        name="next_review_date"
                        class="admin-form-input"
                        value="{{ occasion.next_review_date.strftime('%Y-%m') if occasion and occasion.next_review_date else '' }}"
                    >
                    <div class="admin-form-hint">Mes/ano para revisar este conteudo</div>
                </div>
            </div>

            <!-- Imagem -->
            <div class="admin-card">
                <div class="admin-card-header">
                    <h3 class="admin-card-title">Imagem</h3>
                </div>

                <div class="occasion-image-upload">
                    <div class="occasion-image-preview" id="occasion-image-preview">
                        {% if occasion and occasion.image_url %}
                        <img src="{{ occasion.image_url }}" alt="{{ occasion.name }}">
                        {% else %}
                        <div class="image-placeholder">
                            <span>Sem imagem</span>
                        </div>
                        {% endif %}
                    </div>
                    <div class="occasion-image-controls">
                        <input type="file" id="occasion-image-file" accept="image/jpeg,image/png,image/webp,image/gif" style="display: none;">
                        <button type="button" class="admin-btn admin-btn-secondary admin-btn-sm" onclick="document.getElementById('occasion-image-file').click()">
                            Upload
                        </button>
                        <span class="upload-status" id="occasion-upload-status"></span>
                    </div>
                    <input type="hidden" id="image_url" name="image_url" value="{{ occasion.image_url if occasion and occasion.image_url else '' }}">
                    <div class="admin-form-hint">Redimensionada para 400x400 px</div>
                </div>
            </div>

            <!-- Tags -->
            <div class="admin-card">
                <div class="admin-form-group" style="margin-bottom: 0;">
                    <label for="tags" class="admin-form-label">
                        Tags
                        <button type="button" class="admin-btn-icon-sm" onclick="generateTags()" title="Gerar com IA">ðŸ¤–</button>
                    </label>
                    <input
                        type="text"
                        id="tags"
                        name="tags"
                        class="admin-form-input"
                        value="{{ occasion.tags | join(', ') if occasion and occasion.tags else '' }}"
                        placeholder="tag1, tag2, tag3"
                    >
                    <div class="admin-form-hint">Separadas por virgula</div>
                </div>
            </div>

            <!-- Custos de IA -->
            {% if occasion %}
            <div class="admin-card" id="ai-costs-card" style="background: var(--admin-bg-tertiary);">
                <h4 style="margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
                    <span>ðŸ’°</span> Custos de IA
                </h4>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; text-align: center; margin-bottom: 0.75rem;">
                    <div style="background: var(--admin-bg-secondary); padding: 0.5rem; border-radius: 4px;">
                        <div id="ai-prompt-tokens-display" style="font-size: 1rem; font-weight: bold; color: var(--admin-warning);">
                            {{ "{:,}".format(occasion.ai_prompt_tokens) }}
                        </div>
                        <div style="font-size: 0.65rem; color: var(--admin-text-muted);">Entrada</div>
                    </div>
                    <div style="background: var(--admin-bg-secondary); padding: 0.5rem; border-radius: 4px;">
                        <div id="ai-completion-tokens-display" style="font-size: 1rem; font-weight: bold; color: var(--admin-info);">
                            {{ "{:,}".format(occasion.ai_completion_tokens) }}
                        </div>
                        <div style="font-size: 0.65rem; color: var(--admin-text-muted);">Saida</div>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; text-align: center;">
                    <div>
                        <div id="ai-tokens-display" style="font-size: 1.1rem; font-weight: bold; color: var(--admin-primary);">
                            {{ "{:,}".format(occasion.ai_tokens_used) }}
                        </div>
                        <div style="font-size: 0.65rem; color: var(--admin-text-muted);">Total</div>
                    </div>
                    <div>
                        <div id="ai-cost-display" style="font-size: 1.1rem; font-weight: bold; color: var(--admin-success);">
                            ${{ "%.6f"|format(occasion.ai_cost_usd|float) }}
                        </div>
                        <div style="font-size: 0.65rem; color: var(--admin-text-muted);">Custo</div>
                    </div>
                    <div>
                        <div id="ai-generations-display" style="font-size: 1.1rem; font-weight: bold; color: var(--admin-text);">
                            {{ occasion.ai_generations_count }}
                        </div>
                        <div style="font-size: 0.65rem; color: var(--admin-text-muted);">Chamadas</div>
                    </div>
                </div>
            </div>
            {% else %}
            <!-- Nova ocasiao - custos serao exibidos apos salvar -->
            <div class="admin-card" style="background: var(--admin-bg-tertiary); opacity: 0.6;">
                <h4 style="margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                    <span>ðŸ’°</span> Custos de IA
                </h4>
                <p style="font-size: 0.8rem; color: var(--admin-text-muted); margin: 0;">
                    Salve a ocasiao para acompanhar custos de IA
                </p>
            </div>
            {% endif %}

            {% if occasion %}
            <!-- Informacoes -->
            <div class="admin-card">
                <div class="admin-card-header">
                    <h3 class="admin-card-title">Informacoes</h3>
                </div>
                <div class="admin-info-list">
                    <div class="admin-info-item">
                        <span class="admin-info-label">Criada em:</span>
                        <span class="admin-info-value">{{ occasion.created_at.strftime('%d/%m/%Y %H:%M') }}</span>
                    </div>
                    <div class="admin-info-item">
                        <span class="admin-info-label">Atualizada em:</span>
                        <span class="admin-info-value">{{ occasion.updated_at.strftime('%d/%m/%Y %H:%M') if occasion.updated_at else '-' }}</span>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</form>

<!-- Modal de Loading IA (bloqueia interacao) -->
<div id="ai-loading-modal" class="ai-loading-modal">
    <div class="ai-loading-backdrop"></div>
    <div class="ai-loading-content">
        <div class="ai-loading-spinner"></div>
        <div class="ai-loading-text">Gerando com IA...</div>
        <div class="ai-loading-subtext">Aguarde, isso pode levar alguns segundos</div>
    </div>
</div>

<!-- Modal de Selecao de Produto -->
<div id="product-modal" class="product-modal" style="display: none;">
    <div class="product-modal-backdrop" onclick="closeProductModal()"></div>
    <div class="product-modal-content">
        <div class="product-modal-header">
            <h3>Inserir Produto no Conteudo</h3>
            <button type="button" class="product-modal-close" onclick="closeProductModal()">&times;</button>
        </div>
        <div class="product-modal-search">
            <input
                type="text"
                id="product-search"
                class="admin-form-input"
                placeholder="Buscar produto por nome..."
                oninput="filterProducts(this.value)"
            >
        </div>
        <div class="product-modal-list" id="product-modal-list">
            {% for product in products %}
            <div class="product-modal-item" data-slug="{{ product.slug }}" data-name="{{ product.name|lower }}" onclick="insertProduct('{{ product.slug }}', '{{ product.name|e }}')">
                <div class="product-modal-item-image">
                    {% if product.main_image_url %}
                    <img src="{{ product.main_image_url }}" alt="{{ product.name }}" loading="lazy">
                    {% else %}
                    <span class="no-image">ðŸ“¦</span>
                    {% endif %}
                </div>
                <div class="product-modal-item-info">
                    <span class="product-modal-item-name">{{ product.name }}</span>
                    <span class="product-modal-item-meta">
                        <span class="platform platform-{{ product.platform.value }}">{{ product.platform.value|title }}</span>
                        {% if product.price %}
                        <span class="price">R$ {{ "%.2f"|format(product.price) }}</span>
                        {% endif %}
                    </span>
                    <code class="product-modal-item-slug">[product:{{ product.slug }}]</code>
                </div>
            </div>
            {% else %}
            <div class="product-modal-empty">
                <p>Nenhum produto cadastrado.</p>
                <a href="/admin/products/new" class="admin-btn admin-btn-primary">Criar Produto</a>
            </div>
            {% endfor %}
        </div>
        <div class="product-modal-footer">
            <span class="product-modal-hint">Clique em um produto para inserir o shortcode na posicao do cursor</span>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// =============================================================================
// Variaveis globais
// =============================================================================

// ID da ocasiao atual (para salvar custos de IA)
const occasionId = '{{ occasion.id if occasion else "" }}';

// Variaveis para acumular custos localmente (atualiza UI em tempo real)
let localTokensUsed = {{ occasion.ai_tokens_used if occasion else 0 }};
let localPromptTokens = {{ occasion.ai_prompt_tokens if occasion else 0 }};
let localCompletionTokens = {{ occasion.ai_completion_tokens if occasion else 0 }};
let localCostUsd = {{ occasion.ai_cost_usd|float if occasion else 0 }};
let localGenerationsCount = {{ occasion.ai_generations_count if occasion else 0 }};

// =============================================================================
// Auto-gerar slug do nome
// =============================================================================
const nameInput = document.getElementById('name');
const slugInput = document.getElementById('slug');
let slugManuallyEdited = {{ 'true' if occasion else 'false' }};

function generateSlug(text) {
    if (!text) return '';
    return text
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/[^\w\s-]/g, '')
        .replace(/\s+/g, '-')
        .replace(/-+/g, '-')
        .trim();
}

nameInput.addEventListener('input', function() {
    if (!slugManuallyEdited) {
        slugInput.value = generateSlug(this.value);
    }
});

slugInput.addEventListener('input', function() {
    if (this.value.trim() !== '') {
        slugManuallyEdited = true;
    }
});

// =============================================================================
// Contador de caracteres SEO
// =============================================================================
document.getElementById('seo_title').addEventListener('input', function() {
    document.getElementById('seo_title_count').textContent = this.value.length;
});

document.getElementById('seo_description').addEventListener('input', function() {
    document.getElementById('seo_description_count').textContent = this.value.length;
});

// =============================================================================
// Upload de imagem
// =============================================================================
const imageFileInput = document.getElementById('occasion-image-file');
const imagePreview = document.getElementById('occasion-image-preview');
const imageUrlInput = document.getElementById('image_url');
const uploadStatus = document.getElementById('occasion-upload-status');

imageFileInput.addEventListener('change', async function(e) {
    const file = e.target.files[0];
    if (!file) return;

    const allowedTypes = ['image/jpeg', 'image/png', 'image/webp', 'image/gif'];
    if (!allowedTypes.includes(file.type)) {
        uploadStatus.textContent = 'Tipo nao permitido';
        uploadStatus.style.color = 'var(--admin-danger)';
        return;
    }

    if (file.size > 10 * 1024 * 1024) {
        uploadStatus.textContent = 'Max 10MB';
        uploadStatus.style.color = 'var(--admin-danger)';
        return;
    }

    uploadStatus.textContent = 'Enviando...';
    uploadStatus.style.color = 'var(--admin-text-muted)';

    const formData = new FormData();
    formData.append('file', file);

    try {
        const response = await fetch('/admin/upload/category-image', {
            method: 'POST',
            body: formData,
        });

        const data = await response.json();

        if (response.ok) {
            imageUrlInput.value = data.url;
            imagePreview.innerHTML = `<img src="${data.url}" alt="Preview">`;
            uploadStatus.textContent = '400x400 OK!';
            uploadStatus.style.color = 'var(--admin-success)';
        } else {
            uploadStatus.textContent = data.detail || 'Erro';
            uploadStatus.style.color = 'var(--admin-danger)';
        }
    } catch (error) {
        uploadStatus.textContent = 'Erro de conexao';
        uploadStatus.style.color = 'var(--admin-danger)';
    }

    imageFileInput.value = '';
});

// =============================================================================
// Markdown Editor com Preview
// =============================================================================
(function() {
    const textarea = document.getElementById('content');
    const preview = document.getElementById('markdown-preview');
    const panels = document.querySelector('.markdown-panels');
    const previewBtn = document.querySelector('[data-action="preview"]');
    const toolbar = document.querySelector('.markdown-toolbar');

    if (!textarea || !preview) return;

    let previewMode = 'edit';
    let previewTimeout = null;

    const actions = {
        bold: () => wrapText('**', '**'),
        italic: () => wrapText('*', '*'),
        heading: () => insertAtLineStart('## '),
        link: () => {
            const url = prompt('URL do link:');
            if (url) wrapText('[', `](${url})`);
        },
        image: () => {
            const url = prompt('URL da imagem:');
            if (url) insertText(`![Imagem](${url})`);
        },
        list: () => insertAtLineStart('- '),
        olist: () => insertAtLineStart('1. '),
        quote: () => insertAtLineStart('> '),
        code: () => {
            const selection = getSelection();
            if (selection.includes('\n')) {
                wrapText('\n```\n', '\n```\n');
            } else {
                wrapText('`', '`');
            }
        },
        product: () => openProductModal(),
        preview: () => togglePreview()
    };

    toolbar.querySelectorAll('.md-btn').forEach(btn => {
        const action = btn.dataset.action;
        if (action && actions[action]) {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                actions[action]();
                textarea.focus();
            });
        }
    });

    function getSelection() {
        return textarea.value.substring(textarea.selectionStart, textarea.selectionEnd);
    }

    function wrapText(before, after) {
        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;
        const selection = textarea.value.substring(start, end);
        const replacement = before + selection + after;

        textarea.setRangeText(replacement, start, end, 'select');
        textarea.selectionStart = start + before.length;
        textarea.selectionEnd = end + before.length;
    }

    function insertText(text) {
        const start = textarea.selectionStart;
        textarea.setRangeText(text, start, start, 'end');
    }

    function insertAtLineStart(prefix) {
        const start = textarea.selectionStart;
        const value = textarea.value;

        let lineStart = start;
        while (lineStart > 0 && value[lineStart - 1] !== '\n') {
            lineStart--;
        }

        const lineContent = value.substring(lineStart);
        if (lineContent.startsWith(prefix)) {
            return;
        }

        textarea.setRangeText(prefix, lineStart, lineStart, 'end');
    }

    function togglePreview() {
        if (previewMode === 'edit') {
            previewMode = 'split';
            panels.classList.add('split-view');
            panels.classList.remove('preview-only');
            previewBtn.classList.add('active');
            previewBtn.textContent = 'Split';
            updatePreview();
        } else if (previewMode === 'split') {
            previewMode = 'preview';
            panels.classList.remove('split-view');
            panels.classList.add('preview-only');
            previewBtn.textContent = 'Editar';
            updatePreview();
        } else {
            previewMode = 'edit';
            panels.classList.remove('split-view', 'preview-only');
            previewBtn.classList.remove('active');
            previewBtn.textContent = 'Preview';
        }
    }

    async function updatePreview() {
        if (previewMode === 'edit') return;

        const content = textarea.value;
        if (!content.trim()) {
            preview.innerHTML = '<p class="preview-placeholder">Nenhum conteudo para visualizar</p>';
            return;
        }

        try {
            const response = await fetch('/api/v1/posts/preview', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content })
            });

            if (response.ok) {
                const data = await response.json();
                preview.innerHTML = data.html;
            } else {
                preview.innerHTML = '<p class="preview-placeholder">Erro ao renderizar preview</p>';
            }
        } catch (error) {
            console.error('Preview error:', error);
            preview.innerHTML = '<p class="preview-placeholder">Erro ao renderizar preview</p>';
        }
    }

    function schedulePreviewUpdate() {
        if (previewMode === 'edit') return;

        if (previewTimeout) {
            clearTimeout(previewTimeout);
        }
        previewTimeout = setTimeout(updatePreview, 500);
    }

    textarea.addEventListener('input', schedulePreviewUpdate);

    textarea.addEventListener('keydown', (e) => {
        if (e.ctrlKey || e.metaKey) {
            switch (e.key.toLowerCase()) {
                case 'b':
                    e.preventDefault();
                    actions.bold();
                    break;
                case 'i':
                    e.preventDefault();
                    actions.italic();
                    break;
                case 'k':
                    e.preventDefault();
                    actions.link();
                    break;
            }
        }
    });

    textarea.addEventListener('keydown', (e) => {
        if (e.key === 'Tab') {
            e.preventDefault();
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;

            if (e.shiftKey) {
                const lineStart = textarea.value.lastIndexOf('\n', start - 1) + 1;
                const lineContent = textarea.value.substring(lineStart);
                if (lineContent.startsWith('    ') || lineContent.startsWith('\t')) {
                    const removeChars = lineContent.startsWith('    ') ? 4 : 1;
                    textarea.setRangeText('', lineStart, lineStart + removeChars, 'end');
                }
            } else {
                textarea.setRangeText('    ', start, end, 'end');
            }
        }
    });
})();

// =============================================================================
// Modal de Selecao de Produto
// =============================================================================
const productModal = document.getElementById('product-modal');
const productSearchInput = document.getElementById('product-search');
const productModalList = document.getElementById('product-modal-list');
const contentTextarea = document.getElementById('content');
let cursorPosition = 0;

function openProductModal() {
    cursorPosition = contentTextarea.selectionStart;
    productModal.style.display = 'flex';
    productSearchInput.value = '';
    filterProducts('');
    setTimeout(() => productSearchInput.focus(), 100);
}

function closeProductModal() {
    productModal.style.display = 'none';
    contentTextarea.focus();
    contentTextarea.setSelectionRange(cursorPosition, cursorPosition);
}

function filterProducts(query) {
    const items = productModalList.querySelectorAll('.product-modal-item');
    const lowerQuery = query.toLowerCase().trim();

    items.forEach(item => {
        const name = item.dataset.name || '';
        const slug = item.dataset.slug || '';

        if (!lowerQuery || name.includes(lowerQuery) || slug.includes(lowerQuery)) {
            item.style.display = 'flex';
        } else {
            item.style.display = 'none';
        }
    });
}

function insertProduct(slug, name) {
    const shortcode = `[product:${slug}]`;
    const content = contentTextarea.value;

    let prefix = '';
    let suffix = '\n';

    if (cursorPosition > 0) {
        const charBefore = content[cursorPosition - 1];
        if (charBefore !== '\n') {
            prefix = '\n\n';
        } else if (cursorPosition > 1 && content[cursorPosition - 2] !== '\n') {
            prefix = '\n';
        }
    }

    if (cursorPosition < content.length) {
        const charAfter = content[cursorPosition];
        if (charAfter !== '\n') {
            suffix = '\n\n';
        }
    }

    const insertion = prefix + shortcode + suffix;
    const newContent = content.slice(0, cursorPosition) + insertion + content.slice(cursorPosition);

    contentTextarea.value = newContent;

    const newPosition = cursorPosition + insertion.length;
    contentTextarea.setSelectionRange(newPosition, newPosition);

    closeProductModal();
    contentTextarea.dispatchEvent(new Event('input'));
    showInsertFeedback(name);
}

function showInsertFeedback(productName) {
    const feedback = document.createElement('div');
    feedback.className = 'insert-feedback';
    feedback.textContent = `Produto "${productName}" inserido!`;
    document.body.appendChild(feedback);

    setTimeout(() => {
        feedback.classList.add('fade-out');
        setTimeout(() => feedback.remove(), 300);
    }, 2000);
}

document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && productModal.style.display === 'flex') {
        closeProductModal();
    }
});

// =============================================================================
// Modal de Loading IA
// =============================================================================
const aiLoadingModal = document.getElementById('ai-loading-modal');

function showAILoading(text = 'Gerando com IA...') {
    if (!aiLoadingModal) return;
    const textEl = aiLoadingModal.querySelector('.ai-loading-text');
    if (textEl) textEl.textContent = text;
    aiLoadingModal.classList.add('active');
    document.body.style.overflow = 'hidden';
}

function hideAILoading() {
    if (!aiLoadingModal) return;
    aiLoadingModal.classList.remove('active');
    document.body.style.overflow = '';
}

// =============================================================================
// Atualizar custos de IA
// =============================================================================
async function updateOccasionAICost(tokensUsed, promptTokens, completionTokens, costUsd) {
    if (!occasionId) return;

    try {
        await fetch(`/admin/api/occasions/${occasionId}/ai-cost`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                tokens_used: tokensUsed,
                prompt_tokens: promptTokens,
                completion_tokens: completionTokens,
                cost_usd: costUsd
            })
        });
    } catch (error) {
        console.error('Erro ao salvar custos de IA:', error);
    }
}

function updateCostDisplay(tokensUsed, promptTokens, completionTokens, costUsd) {
    localTokensUsed += tokensUsed || 0;
    localPromptTokens += promptTokens || 0;
    localCompletionTokens += completionTokens || 0;
    localCostUsd += costUsd || 0;
    localGenerationsCount += 1;

    const tokensDisplay = document.getElementById('ai-tokens-display');
    const promptDisplay = document.getElementById('ai-prompt-tokens-display');
    const completionDisplay = document.getElementById('ai-completion-tokens-display');
    const costDisplay = document.getElementById('ai-cost-display');
    const genDisplay = document.getElementById('ai-generations-display');

    if (tokensDisplay) tokensDisplay.textContent = localTokensUsed.toLocaleString('pt-BR');
    if (promptDisplay) promptDisplay.textContent = localPromptTokens.toLocaleString('pt-BR');
    if (completionDisplay) completionDisplay.textContent = localCompletionTokens.toLocaleString('pt-BR');
    if (costDisplay) costDisplay.textContent = '$' + localCostUsd.toFixed(6);
    if (genDisplay) genDisplay.textContent = localGenerationsCount;
}

// =============================================================================
// Geracao de SEO com IA
// =============================================================================
const fieldToUseCase = {
    'seo_title': 'occasion_seo_title',
    'seo_description': 'occasion_seo_description',
    'seo_focus_keyword': 'occasion_seo_keyword'
};

const fallbackUseCase = {
    'occasion_seo_title': 'seo_title',
    'occasion_seo_description': 'seo_description',
    'occasion_seo_keyword': 'seo_keywords'
};

async function generateSEO(field) {
    const name = document.getElementById('name').value.trim();
    const content = document.getElementById('content').value.trim();

    if (!name) {
        alert('Preencha o nome da ocasiao antes de gerar SEO');
        return;
    }

    const useCase = fieldToUseCase[field] || field;
    const targetInput = document.getElementById(field);

    const fieldLabels = {
        'seo_focus_keyword': 'Gerando palavra-chave...',
        'seo_title': 'Gerando titulo SEO...',
        'seo_description': 'Gerando descricao SEO...'
    };
    showAILoading(fieldLabels[field] || 'Gerando com IA...');

    try {
        const response = await fetch('/admin/api/ai/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                use_case: useCase,
                title: name,
                content: content.substring(0, 5000)
            })
        });

        let data = await response.json();

        // Fallback para use_case generico
        if (!response.ok && fallbackUseCase[useCase]) {
            const fallbackResponse = await fetch('/admin/api/ai/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    use_case: fallbackUseCase[useCase],
                    title: name,
                    content: content.substring(0, 5000)
                })
            });
            data = await fallbackResponse.json();
            if (fallbackResponse.ok) {
                processGeneratedContent(field, data.generated_content, targetInput);
                updateCostDisplay(data.tokens_used || 0, data.prompt_tokens || 0, data.completion_tokens || 0, data.cost_usd || 0);
                await updateOccasionAICost(data.tokens_used || 0, data.prompt_tokens || 0, data.completion_tokens || 0, data.cost_usd || 0);
                return;
            }
        }

        if (response.ok) {
            processGeneratedContent(field, data.generated_content, targetInput);
            updateCostDisplay(data.tokens_used || 0, data.prompt_tokens || 0, data.completion_tokens || 0, data.cost_usd || 0);
            await updateOccasionAICost(data.tokens_used || 0, data.prompt_tokens || 0, data.completion_tokens || 0, data.cost_usd || 0);
        } else {
            alert('Erro ao gerar: ' + (data.detail || 'Erro desconhecido'));
        }
    } catch (error) {
        alert('Erro de conexao: ' + error.message);
    } finally {
        hideAILoading();
    }
}

function processGeneratedContent(field, generatedContent, targetInput) {
    if (field === 'seo_focus_keyword') {
        generatedContent = generatedContent
            .replace(/^(palavras?-?chave|keywords?|foco|principal)[:.\s-]*/i, '')
            .split(/[,\n]/)[0]
            .trim();
    }
    targetInput.value = generatedContent;
    const countSpan = document.getElementById(field + '_count');
    if (countSpan) {
        countSpan.textContent = generatedContent.length;
    }
}

async function generateAllSEO() {
    const name = document.getElementById('name').value.trim();

    if (!name) {
        alert('Preencha o nome da ocasiao antes de gerar SEO');
        return;
    }

    const content = document.getElementById('content').value.trim();
    const seoKeyword = document.getElementById('seo_focus_keyword');
    const seoTitle = document.getElementById('seo_title');
    const seoDescription = document.getElementById('seo_description');
    const tagsInput = document.getElementById('tags');

    showAILoading('Gerando SEO completo...');

    const requestBody = {
        title: name,
        content: content.substring(0, 5000)
    };

    try {
        const [keywordResponse, titleResponse, descResponse, tagsResponse] = await Promise.all([
            fetch('/admin/api/ai/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ...requestBody, use_case: 'occasion_seo_keyword' })
            }),
            fetch('/admin/api/ai/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ...requestBody, use_case: 'occasion_seo_title' })
            }),
            fetch('/admin/api/ai/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ...requestBody, use_case: 'occasion_seo_description' })
            }),
            fetch('/admin/api/ai/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ...requestBody, use_case: 'occasion_tags' })
            })
        ]);

        const [keywordData, titleData, descData, tagsData] = await Promise.all([
            keywordResponse.json(),
            titleResponse.json(),
            descResponse.json(),
            tagsResponse.json()
        ]);

        if (keywordResponse.ok) {
            let keyword = keywordData.generated_content
                .replace(/^(palavras?-?chave|keywords?|foco|principal)[:.\s-]*/i, '')
                .split(/[,\n]/)[0]
                .trim();
            seoKeyword.value = keyword;
        }

        if (titleResponse.ok) {
            seoTitle.value = titleData.generated_content;
            document.getElementById('seo_title_count').textContent = titleData.generated_content.length;
        }

        if (descResponse.ok) {
            seoDescription.value = descData.generated_content;
            document.getElementById('seo_description_count').textContent = descData.generated_content.length;
        }

        if (tagsResponse.ok) {
            let tags = tagsData.generated_content
                .replace(/^(tags?|sugest[oÃµ]es?)[:.\s-]*/i, '')
                .split(/[,\n]/)
                .map(t => t.trim().toLowerCase())
                .filter(t => t.length > 0)
                .join(', ');
            tagsInput.value = tags;
        }

        // Salva custos
        if (keywordResponse.ok) {
            updateCostDisplay(keywordData.tokens_used || 0, keywordData.prompt_tokens || 0, keywordData.completion_tokens || 0, keywordData.cost_usd || 0);
            await updateOccasionAICost(keywordData.tokens_used || 0, keywordData.prompt_tokens || 0, keywordData.completion_tokens || 0, keywordData.cost_usd || 0);
        }
        if (titleResponse.ok) {
            updateCostDisplay(titleData.tokens_used || 0, titleData.prompt_tokens || 0, titleData.completion_tokens || 0, titleData.cost_usd || 0);
            await updateOccasionAICost(titleData.tokens_used || 0, titleData.prompt_tokens || 0, titleData.completion_tokens || 0, titleData.cost_usd || 0);
        }
        if (descResponse.ok) {
            updateCostDisplay(descData.tokens_used || 0, descData.prompt_tokens || 0, descData.completion_tokens || 0, descData.cost_usd || 0);
            await updateOccasionAICost(descData.tokens_used || 0, descData.prompt_tokens || 0, descData.completion_tokens || 0, descData.cost_usd || 0);
        }
        if (tagsResponse.ok) {
            updateCostDisplay(tagsData.tokens_used || 0, tagsData.prompt_tokens || 0, tagsData.completion_tokens || 0, tagsData.cost_usd || 0);
            await updateOccasionAICost(tagsData.tokens_used || 0, tagsData.prompt_tokens || 0, tagsData.completion_tokens || 0, tagsData.cost_usd || 0);
        }

        if (!keywordResponse.ok || !titleResponse.ok || !descResponse.ok || !tagsResponse.ok) {
            alert('Alguns campos nao foram gerados. Verifique a configuracao de IA.');
        }
    } catch (error) {
        alert('Erro de conexao: ' + error.message);
    } finally {
        hideAILoading();
    }
}

// =============================================================================
// Geracao de Tags com IA
// =============================================================================
async function generateTags() {
    const name = document.getElementById('name').value.trim();
    const content = document.getElementById('content').value.trim();

    if (!name) {
        alert('Preencha o nome da ocasiao antes de gerar tags');
        return;
    }

    const tagsInput = document.getElementById('tags');

    showAILoading('Gerando tags...');

    try {
        const response = await fetch('/admin/api/ai/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                use_case: 'occasion_tags',
                title: name,
                content: content.substring(0, 5000)
            })
        });

        const data = await response.json();

        if (response.ok) {
            // Limpa e formata as tags
            let tags = data.generated_content
                .replace(/^(tags?|sugest[oÃµ]es?)[:.\s-]*/i, '')
                .split(/[,\n]/)
                .map(t => t.trim().toLowerCase())
                .filter(t => t.length > 0)
                .join(', ');
            tagsInput.value = tags;
            updateCostDisplay(data.tokens_used || 0, data.prompt_tokens || 0, data.completion_tokens || 0, data.cost_usd || 0);
            await updateOccasionAICost(data.tokens_used || 0, data.prompt_tokens || 0, data.completion_tokens || 0, data.cost_usd || 0);
        } else {
            alert('Erro ao gerar: ' + (data.detail || 'Erro desconhecido'));
        }
    } catch (error) {
        alert('Erro de conexao: ' + error.message);
    } finally {
        hideAILoading();
    }
}
</script>
{% endblock %}
