{% extends "admin/base.html" %}

{% block title %}{{ 'Editar' if occasion else 'Nova' }} Ocasi√£o{% endblock %}

{% block breadcrumb %}
<span>/</span>
<a href="/admin/occasions">Ocasi√µes</a>
<span>/</span>
<span class="current">{{ 'Editar' if occasion else 'Nova' }}</span>
{% endblock %}

{% block content %}
<div class="admin-page-header">
    <h1 class="admin-page-title">{{ 'Editar Ocasi√£o' if occasion else 'Nova Ocasi√£o' }}</h1>
</div>

<form method="POST" action="{{ '/admin/occasions/' ~ occasion.id if occasion else '/admin/occasions' }}" class="admin-form">
    <div class="admin-form-grid">
        <!-- Main Content -->
        <div class="admin-form-main">
            <div class="admin-card">
                <div class="admin-form-group">
                    <label for="name" class="admin-form-label">Nome da Ocasi√£o *</label>
                    <input
                        type="text"
                        id="name"
                        name="name"
                        class="admin-form-input"
                        value="{{ occasion.name if occasion else '' }}"
                        required
                    >
                </div>

                <div class="admin-form-group">
                    <label for="slug" class="admin-form-label">Slug</label>
                    <input
                        type="text"
                        id="slug"
                        name="slug"
                        class="admin-form-input"
                        value="{{ occasion.slug if occasion else '' }}"
                        placeholder="gerado-automaticamente"
                    >
                    <div class="admin-form-hint">URL: /ocasiao/{{ occasion.slug if occasion else 'seu-slug' }}</div>
                </div>

                <div class="admin-form-group">
                    <label for="description" class="admin-form-label">Descri√ß√£o Curta</label>
                    <textarea
                        id="description"
                        name="description"
                        class="admin-form-textarea"
                        rows="2"
                        placeholder="Descri√ß√£o breve para listagens (max 200 caracteres)"
                        maxlength="200"
                    >{{ occasion.description if occasion else '' }}</textarea>
                    <div class="admin-form-hint">Exibida em cards e listagens</div>
                </div>

                <div class="admin-form-group">
                    <label for="icon" class="admin-form-label">√çcone (Emoji)</label>
                    <input
                        type="text"
                        id="icon"
                        name="icon"
                        class="admin-form-input"
                        value="{{ occasion.icon if occasion else '' }}"
                        placeholder="Ex: üéÑ üéÇ üíù"
                        style="max-width: 150px;"
                    >
                    <div class="admin-form-hint">Use um emoji para representar a ocasi√£o</div>
                </div>
            </div>

            <!-- Conte√∫do Markdown -->
            <div class="admin-card">
                <div class="admin-card-header">
                    <h3 class="admin-card-title">Conte√∫do</h3>
                </div>

                <div class="admin-form-group">
                    <label for="content" class="admin-form-label">Conte√∫do (Markdown)</label>
                    <div class="markdown-editor">
                        <div class="markdown-toolbar">
                            <button type="button" class="md-btn" data-action="bold" title="Negrito (Ctrl+B)"><strong>B</strong></button>
                            <button type="button" class="md-btn" data-action="italic" title="It√°lico (Ctrl+I)"><em>I</em></button>
                            <button type="button" class="md-btn" data-action="heading" title="T√≠tulo">H</button>
                            <button type="button" class="md-btn" data-action="link" title="Link">üîó</button>
                            <button type="button" class="md-btn" data-action="image" title="Imagem">üñº</button>
                            <button type="button" class="md-btn" data-action="list" title="Lista">‚Ä¢</button>
                            <button type="button" class="md-btn" data-action="olist" title="Lista numerada">1.</button>
                            <button type="button" class="md-btn" data-action="quote" title="Cita√ß√£o">"</button>
                            <button type="button" class="md-btn" data-action="code" title="C√≥digo">&lt;/&gt;</button>
                            <span class="md-toolbar-separator"></span>
                            <button type="button" class="md-btn md-btn-product" data-action="product" title="Inserir Produto">üõí Produto</button>
                            <span class="md-toolbar-separator"></span>
                            <button type="button" class="md-btn md-btn-preview" data-action="preview" title="Preview">Preview</button>
                        </div>
                        <div class="markdown-panels">
                            <textarea
                                id="content"
                                name="content"
                                class="admin-form-textarea markdown-input"
                            >{{ occasion.content if occasion else '' }}</textarea>
                            <div class="markdown-preview" id="markdown-preview">
                                <p class="preview-placeholder">Clique em "Preview" para visualizar</p>
                            </div>
                        </div>
                    </div>
                    <div class="admin-form-hint">
                        Suporta Markdown: **negrito**, *it√°lico*, # t√≠tulo, [link](url), ![imagem](url)<br>
                        <strong>Produtos:</strong> Use <code>[product:slug-do-produto]</code> para inserir um card de produto no conte√∫do
                    </div>
                </div>
            </div>

            <!-- SEO -->
            <div class="admin-card">
                <div class="admin-card-header">
                    <h3 class="admin-card-title">SEO</h3>
                    <button type="button" class="admin-btn admin-btn-sm admin-btn-secondary" onclick="generateAllSEO()">
                        ü§ñ Gerar Tudo
                    </button>
                </div>

                <div class="admin-form-group">
                    <label for="seo_focus_keyword" class="admin-form-label">Palavra-chave Foco</label>
                    <div class="admin-input-with-btn">
                        <input
                            type="text"
                            id="seo_focus_keyword"
                            name="seo_focus_keyword"
                            class="admin-form-input"
                            value="{{ occasion.seo_focus_keyword if occasion else '' }}"
                            placeholder="Palavra-chave principal (ex: presentes de natal)"
                            maxlength="100"
                        >
                        <button type="button" class="admin-btn admin-btn-sm admin-btn-ai" onclick="generateSEO('seo_focus_keyword')" title="Gerar com IA">
                            ü§ñ
                        </button>
                    </div>
                    <div class="admin-form-hint">Keyword principal para otimizar o conteudo</div>
                    <div id="seo_focus_keyword_loading" class="ai-loading" style="display: none;">
                        <div class="ai-spinner"></div>
                        <span>Gerando...</span>
                    </div>
                </div>

                <div class="admin-form-group">
                    <label for="seo_title" class="admin-form-label">T√≠tulo SEO</label>
                    <div class="admin-input-with-btn">
                        <input
                            type="text"
                            id="seo_title"
                            name="seo_title"
                            class="admin-form-input"
                            value="{{ occasion.seo_title if occasion else '' }}"
                            placeholder="T√≠tulo para buscadores (max 60 caracteres)"
                            maxlength="60"
                        >
                        <button type="button" class="admin-btn admin-btn-sm admin-btn-ai" onclick="generateSEO('seo_title')" title="Gerar com IA">
                            ü§ñ
                        </button>
                    </div>
                    <div class="admin-form-hint">
                        <span id="seo_title_count">{{ (occasion.seo_title|length) if occasion and occasion.seo_title else 0 }}</span>/60 caracteres
                    </div>
                    <div id="seo_title_loading" class="ai-loading" style="display: none;">
                        <div class="ai-spinner"></div>
                        <span>Gerando...</span>
                    </div>
                </div>

                <div class="admin-form-group">
                    <label for="seo_description" class="admin-form-label">Descri√ß√£o SEO</label>
                    <div class="admin-input-with-btn">
                        <textarea
                            id="seo_description"
                            name="seo_description"
                            class="admin-form-textarea"
                            rows="2"
                            placeholder="Descri√ß√£o para buscadores (max 160 caracteres)"
                            maxlength="160"
                        >{{ occasion.seo_description if occasion else '' }}</textarea>
                        <button type="button" class="admin-btn admin-btn-sm admin-btn-ai" onclick="generateSEO('seo_description')" title="Gerar com IA">
                            ü§ñ
                        </button>
                    </div>
                    <div class="admin-form-hint">
                        <span id="seo_description_count">{{ (occasion.seo_description|length) if occasion and occasion.seo_description else 0 }}</span>/160 caracteres
                    </div>
                    <div id="seo_description_loading" class="ai-loading" style="display: none;">
                        <div class="ai-spinner"></div>
                        <span>Gerando...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="admin-form-sidebar">
            <!-- Status e Ordem -->
            <div class="admin-card">
                <div class="admin-form-group">
                    <label class="admin-checkbox">
                        <input
                            type="checkbox"
                            name="is_active"
                            {% if not occasion or occasion.is_active %}checked{% endif %}
                        >
                        <span>Ocasi√£o ativa</span>
                    </label>
                    <div class="admin-form-hint">Ocasi√µes inativas n√£o aparecem no site</div>
                </div>

                <div class="admin-form-group">
                    <label for="display_order" class="admin-form-label">Ordem de Exibi√ß√£o</label>
                    <input
                        type="number"
                        id="display_order"
                        name="display_order"
                        class="admin-form-input"
                        value="{{ occasion.display_order if occasion else 0 }}"
                        min="0"
                    >
                    <div class="admin-form-hint">Menor n√∫mero aparece primeiro</div>
                </div>

                <div class="admin-form-actions">
                    <button type="submit" class="admin-btn admin-btn-primary admin-btn-block">
                        {{ 'Salvar' if occasion else 'Criar Ocasi√£o' }}
                    </button>
                    {% if occasion %}
                    <a href="/ocasiao/{{ occasion.slug }}" target="_blank" class="admin-btn admin-btn-secondary admin-btn-block">
                        Ver no Site
                    </a>
                    {% endif %}
                </div>
            </div>

            <!-- Pr√≥xima Revis√£o -->
            <div class="admin-card">
                <div class="admin-card-header">
                    <h3 class="admin-card-title">Revis√£o</h3>
                </div>

                <div class="admin-form-group">
                    <label for="next_review_date" class="admin-form-label">Pr√≥xima Revis√£o</label>
                    <input
                        type="month"
                        id="next_review_date"
                        name="next_review_date"
                        class="admin-form-input"
                        value="{{ occasion.next_review_date.strftime('%Y-%m') if occasion and occasion.next_review_date else '' }}"
                    >
                    <div class="admin-form-hint">M√™s/ano para revisar este conte√∫do</div>
                </div>
            </div>

            <!-- Imagem -->
            <div class="admin-card">
                <div class="admin-card-header">
                    <h3 class="admin-card-title">Imagem</h3>
                </div>

                <div class="occasion-image-upload">
                    <div class="occasion-image-preview" id="occasion-image-preview">
                        {% if occasion and occasion.image_url %}
                        <img src="{{ occasion.image_url }}" alt="{{ occasion.name }}">
                        {% else %}
                        <div class="image-placeholder">
                            <span>Sem imagem</span>
                        </div>
                        {% endif %}
                    </div>
                    <div class="occasion-image-controls">
                        <input type="file" id="occasion-image-file" accept="image/jpeg,image/png,image/webp,image/gif" style="display: none;">
                        <button type="button" class="admin-btn admin-btn-secondary admin-btn-sm" onclick="document.getElementById('occasion-image-file').click()">
                            Upload
                        </button>
                        <span class="upload-status" id="occasion-upload-status"></span>
                    </div>
                    <input type="hidden" id="image_url" name="image_url" value="{{ occasion.image_url if occasion and occasion.image_url else '' }}">
                    <div class="admin-form-hint">Redimensionada para 400x400 px</div>
                </div>
            </div>

            {% if occasion %}
            <!-- Informa√ß√µes -->
            <div class="admin-card">
                <div class="admin-card-header">
                    <h3 class="admin-card-title">Informa√ß√µes</h3>
                </div>
                <div class="admin-info-list">
                    <div class="admin-info-item">
                        <span class="admin-info-label">Criada em:</span>
                        <span class="admin-info-value">{{ occasion.created_at.strftime('%d/%m/%Y %H:%M') }}</span>
                    </div>
                    <div class="admin-info-item">
                        <span class="admin-info-label">Atualizada em:</span>
                        <span class="admin-info-value">{{ occasion.updated_at.strftime('%d/%m/%Y %H:%M') if occasion.updated_at else '-' }}</span>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</form>

<!-- Modal de Sele√ß√£o de Produto -->
<div id="product-modal" class="product-modal" style="display: none;">
    <div class="product-modal-backdrop" onclick="closeProductModal()"></div>
    <div class="product-modal-content">
        <div class="product-modal-header">
            <h3>Inserir Produto no Conte√∫do</h3>
            <button type="button" class="product-modal-close" onclick="closeProductModal()">&times;</button>
        </div>
        <div class="product-modal-search">
            <input
                type="text"
                id="product-search"
                class="admin-form-input"
                placeholder="Buscar produto por nome..."
                oninput="filterProducts(this.value)"
            >
        </div>
        <div class="product-modal-list" id="product-modal-list">
            {% for product in products %}
            <div class="product-modal-item" data-slug="{{ product.slug }}" data-name="{{ product.name|lower }}" onclick="insertProduct('{{ product.slug }}', '{{ product.name|e }}')">
                <div class="product-modal-item-image">
                    {% if product.main_image_url %}
                    <img src="{{ product.main_image_url }}" alt="{{ product.name }}" loading="lazy">
                    {% else %}
                    <span class="no-image">üì¶</span>
                    {% endif %}
                </div>
                <div class="product-modal-item-info">
                    <span class="product-modal-item-name">{{ product.name }}</span>
                    <span class="product-modal-item-meta">
                        <span class="platform platform-{{ product.platform.value }}">{{ product.platform.value|title }}</span>
                        {% if product.price %}
                        <span class="price">R$ {{ "%.2f"|format(product.price) }}</span>
                        {% endif %}
                    </span>
                    <code class="product-modal-item-slug">[product:{{ product.slug }}]</code>
                </div>
            </div>
            {% else %}
            <div class="product-modal-empty">
                <p>Nenhum produto cadastrado.</p>
                <a href="/admin/products/new" class="admin-btn admin-btn-primary">Criar Produto</a>
            </div>
            {% endfor %}
        </div>
        <div class="product-modal-footer">
            <span class="product-modal-hint">Clique em um produto para inserir o shortcode na posi√ß√£o do cursor</span>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.occasion-image-upload {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.occasion-image-preview {
    width: 100%;
    aspect-ratio: 1;
    border-radius: 8px;
    overflow: hidden;
    background: var(--admin-bg);
    display: flex;
    align-items: center;
    justify-content: center;
}

.occasion-image-preview img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.image-placeholder {
    color: var(--admin-text-muted);
    font-size: 0.875rem;
}

.occasion-image-controls {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.upload-status {
    font-size: 0.75rem;
}

.admin-info-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.admin-info-item {
    display: flex;
    justify-content: space-between;
    font-size: 0.875rem;
}

.admin-info-label {
    color: var(--admin-text-muted);
}

.admin-info-value {
    color: var(--admin-text);
}

/* Input com botao de IA */
.admin-input-with-btn {
    display: flex;
    gap: 0.5rem;
    align-items: flex-start;
}

.admin-input-with-btn .admin-form-input,
.admin-input-with-btn .admin-form-textarea {
    flex: 1;
}

.admin-btn-ai {
    flex-shrink: 0;
    padding: 0.5rem 0.75rem;
    background: var(--admin-bg);
    border: 1px solid var(--admin-border);
    cursor: pointer;
    transition: all 0.2s ease;
}

.admin-btn-ai:hover {
    background: var(--admin-primary);
    border-color: var(--admin-primary);
}

/* Loading de IA */
.ai-loading {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: 0.5rem;
    font-size: 0.875rem;
    color: var(--admin-text-muted);
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// =============================================================================
// Auto-gerar slug do nome
// =============================================================================
const nameInput = document.getElementById('name');
const slugInput = document.getElementById('slug');
let slugManuallyEdited = {{ 'true' if occasion else 'false' }};

function generateSlug(text) {
    if (!text) return '';
    return text
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/[^\w\s-]/g, '')
        .replace(/\s+/g, '-')
        .replace(/-+/g, '-')
        .trim();
}

nameInput.addEventListener('input', function() {
    if (!slugManuallyEdited) {
        slugInput.value = generateSlug(this.value);
    }
});

slugInput.addEventListener('input', function() {
    if (this.value.trim() !== '') {
        slugManuallyEdited = true;
    }
});

// =============================================================================
// Contador de caracteres SEO
// =============================================================================
const seoTitleInput = document.getElementById('seo_title');
const seoTitleCount = document.getElementById('seo_title_count');
const seoDescInput = document.getElementById('seo_description');
const seoDescCount = document.getElementById('seo_description_count');

seoTitleInput.addEventListener('input', function() {
    seoTitleCount.textContent = this.value.length;
});

seoDescInput.addEventListener('input', function() {
    seoDescCount.textContent = this.value.length;
});

// =============================================================================
// Upload de imagem
// =============================================================================
const imageFileInput = document.getElementById('occasion-image-file');
const imagePreview = document.getElementById('occasion-image-preview');
const imageUrlInput = document.getElementById('image_url');
const uploadStatus = document.getElementById('occasion-upload-status');

imageFileInput.addEventListener('change', async function(e) {
    const file = e.target.files[0];
    if (!file) return;

    const allowedTypes = ['image/jpeg', 'image/png', 'image/webp', 'image/gif'];
    if (!allowedTypes.includes(file.type)) {
        uploadStatus.textContent = 'Tipo n√£o permitido';
        uploadStatus.style.color = 'var(--admin-danger)';
        return;
    }

    if (file.size > 10 * 1024 * 1024) {
        uploadStatus.textContent = 'Max 10MB';
        uploadStatus.style.color = 'var(--admin-danger)';
        return;
    }

    uploadStatus.textContent = 'Enviando...';
    uploadStatus.style.color = 'var(--admin-text-muted)';

    const formData = new FormData();
    formData.append('file', file);

    try {
        const response = await fetch('/admin/upload/category-image', {
            method: 'POST',
            body: formData,
        });

        const data = await response.json();

        if (response.ok) {
            imageUrlInput.value = data.url;
            imagePreview.innerHTML = `<img src="${data.url}" alt="Preview">`;
            uploadStatus.textContent = '400x400 OK!';
            uploadStatus.style.color = 'var(--admin-success)';
        } else {
            uploadStatus.textContent = data.detail || 'Erro';
            uploadStatus.style.color = 'var(--admin-danger)';
        }
    } catch (error) {
        uploadStatus.textContent = 'Erro de conex√£o';
        uploadStatus.style.color = 'var(--admin-danger)';
    }

    imageFileInput.value = '';
});

// =============================================================================
// Markdown Editor com Preview
// =============================================================================
(function() {
    const textarea = document.getElementById('content');
    const preview = document.getElementById('markdown-preview');
    const panels = document.querySelector('.markdown-panels');
    const previewBtn = document.querySelector('[data-action="preview"]');
    const toolbar = document.querySelector('.markdown-toolbar');

    if (!textarea || !preview) return;

    let previewMode = 'edit'; // 'edit', 'split', 'preview'
    let previewTimeout = null;

    // Toolbar actions
    const actions = {
        bold: () => wrapText('**', '**'),
        italic: () => wrapText('*', '*'),
        heading: () => insertAtLineStart('## '),
        link: () => {
            const url = prompt('URL do link:');
            if (url) wrapText('[', `](${url})`);
        },
        image: () => {
            const url = prompt('URL da imagem:');
            if (url) insertText(`![Imagem](${url})`);
        },
        list: () => insertAtLineStart('- '),
        olist: () => insertAtLineStart('1. '),
        quote: () => insertAtLineStart('> '),
        code: () => {
            const selection = getSelection();
            if (selection.includes('\n')) {
                wrapText('\n```\n', '\n```\n');
            } else {
                wrapText('`', '`');
            }
        },
        product: () => openProductModal(),
        preview: () => togglePreview()
    };

    // Bind toolbar buttons
    toolbar.querySelectorAll('.md-btn').forEach(btn => {
        const action = btn.dataset.action;
        if (action && actions[action]) {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                actions[action]();
                textarea.focus();
            });
        }
    });

    // Helper functions
    function getSelection() {
        return textarea.value.substring(textarea.selectionStart, textarea.selectionEnd);
    }

    function wrapText(before, after) {
        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;
        const selection = textarea.value.substring(start, end);
        const replacement = before + selection + after;

        textarea.setRangeText(replacement, start, end, 'select');
        textarea.selectionStart = start + before.length;
        textarea.selectionEnd = end + before.length;
    }

    function insertText(text) {
        const start = textarea.selectionStart;
        textarea.setRangeText(text, start, start, 'end');
    }

    function insertAtLineStart(prefix) {
        const start = textarea.selectionStart;
        const value = textarea.value;

        // Find line start
        let lineStart = start;
        while (lineStart > 0 && value[lineStart - 1] !== '\n') {
            lineStart--;
        }

        // Check if already has prefix
        const lineContent = value.substring(lineStart);
        if (lineContent.startsWith(prefix)) {
            return; // Already has prefix
        }

        textarea.setRangeText(prefix, lineStart, lineStart, 'end');
    }

    // Toggle preview modes
    function togglePreview() {
        if (previewMode === 'edit') {
            previewMode = 'split';
            panels.classList.add('split-view');
            panels.classList.remove('preview-only');
            previewBtn.classList.add('active');
            previewBtn.textContent = 'Split';
            updatePreview();
        } else if (previewMode === 'split') {
            previewMode = 'preview';
            panels.classList.remove('split-view');
            panels.classList.add('preview-only');
            previewBtn.textContent = 'Editar';
            updatePreview();
        } else {
            previewMode = 'edit';
            panels.classList.remove('split-view', 'preview-only');
            previewBtn.classList.remove('active');
            previewBtn.textContent = 'Preview';
        }
    }

    // Update preview content
    async function updatePreview() {
        if (previewMode === 'edit') return;

        const content = textarea.value;
        if (!content.trim()) {
            preview.innerHTML = '<p class="preview-placeholder">Nenhum conte√∫do para visualizar</p>';
            return;
        }

        try {
            const response = await fetch('/api/v1/posts/preview', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ content })
            });

            if (response.ok) {
                const data = await response.json();
                preview.innerHTML = data.html;
            } else {
                preview.innerHTML = '<p class="preview-placeholder">Erro ao renderizar preview</p>';
            }
        } catch (error) {
            console.error('Preview error:', error);
            preview.innerHTML = '<p class="preview-placeholder">Erro ao renderizar preview</p>';
        }
    }

    // Debounced preview update
    function schedulePreviewUpdate() {
        if (previewMode === 'edit') return;

        if (previewTimeout) {
            clearTimeout(previewTimeout);
        }
        previewTimeout = setTimeout(updatePreview, 500);
    }

    // Listen for content changes
    textarea.addEventListener('input', schedulePreviewUpdate);

    // Keyboard shortcuts
    textarea.addEventListener('keydown', (e) => {
        if (e.ctrlKey || e.metaKey) {
            switch (e.key.toLowerCase()) {
                case 'b':
                    e.preventDefault();
                    actions.bold();
                    break;
                case 'i':
                    e.preventDefault();
                    actions.italic();
                    break;
                case 'k':
                    e.preventDefault();
                    actions.link();
                    break;
            }
        }
    });

    // Tab handling for code blocks
    textarea.addEventListener('keydown', (e) => {
        if (e.key === 'Tab') {
            e.preventDefault();
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;

            if (e.shiftKey) {
                // Unindent
                const lineStart = textarea.value.lastIndexOf('\n', start - 1) + 1;
                const lineContent = textarea.value.substring(lineStart);
                if (lineContent.startsWith('    ') || lineContent.startsWith('\t')) {
                    const removeChars = lineContent.startsWith('    ') ? 4 : 1;
                    textarea.setRangeText('', lineStart, lineStart + removeChars, 'end');
                }
            } else {
                // Indent
                textarea.setRangeText('    ', start, end, 'end');
            }
        }
    });
})();

// =============================================================================
// Modal de Sele√ß√£o de Produto para Shortcode
// =============================================================================

const productModal = document.getElementById('product-modal');
const productSearchInput = document.getElementById('product-search');
const productModalList = document.getElementById('product-modal-list');
const contentTextarea = document.getElementById('content');

// Guarda a posi√ß√£o do cursor antes de abrir o modal
let cursorPosition = 0;

function openProductModal() {
    // Salva a posi√ß√£o atual do cursor
    cursorPosition = contentTextarea.selectionStart;

    // Mostra o modal
    productModal.style.display = 'flex';

    // Limpa a busca
    productSearchInput.value = '';
    filterProducts('');

    // Foca no campo de busca
    setTimeout(() => productSearchInput.focus(), 100);
}

function closeProductModal() {
    productModal.style.display = 'none';

    // Retorna o foco para o textarea
    contentTextarea.focus();
    contentTextarea.setSelectionRange(cursorPosition, cursorPosition);
}

function filterProducts(query) {
    const items = productModalList.querySelectorAll('.product-modal-item');
    const lowerQuery = query.toLowerCase().trim();

    items.forEach(item => {
        const name = item.dataset.name || '';
        const slug = item.dataset.slug || '';

        if (!lowerQuery || name.includes(lowerQuery) || slug.includes(lowerQuery)) {
            item.style.display = 'flex';
        } else {
            item.style.display = 'none';
        }
    });
}

function insertProduct(slug, name) {
    const shortcode = `[product:${slug}]`;

    // Pega o conte√∫do atual
    const content = contentTextarea.value;

    // Verifica se estamos no in√≠cio de uma linha ou precisamos de quebra
    let prefix = '';
    let suffix = '\n';

    // Se n√£o estamos no in√≠cio do conte√∫do
    if (cursorPosition > 0) {
        const charBefore = content[cursorPosition - 1];
        // Se o caractere anterior n√£o √© uma quebra de linha, adiciona duas
        if (charBefore !== '\n') {
            prefix = '\n\n';
        } else if (cursorPosition > 1 && content[cursorPosition - 2] !== '\n') {
            // Se tem apenas uma quebra, adiciona mais uma
            prefix = '\n';
        }
    }

    // Verifica se precisamos de quebra depois
    if (cursorPosition < content.length) {
        const charAfter = content[cursorPosition];
        if (charAfter !== '\n') {
            suffix = '\n\n';
        }
    }

    // Insere o shortcode
    const insertion = prefix + shortcode + suffix;
    const newContent = content.slice(0, cursorPosition) + insertion + content.slice(cursorPosition);

    contentTextarea.value = newContent;

    // Atualiza posi√ß√£o do cursor para depois do shortcode
    const newPosition = cursorPosition + insertion.length;
    contentTextarea.setSelectionRange(newPosition, newPosition);

    // Fecha o modal
    closeProductModal();

    // Dispara evento de input para atualizar preview
    contentTextarea.dispatchEvent(new Event('input'));

    // Feedback visual
    showInsertFeedback(name);
}

function showInsertFeedback(productName) {
    // Cria elemento de feedback
    const feedback = document.createElement('div');
    feedback.className = 'insert-feedback';
    feedback.textContent = `Produto "${productName}" inserido!`;
    document.body.appendChild(feedback);

    // Remove ap√≥s anima√ß√£o
    setTimeout(() => {
        feedback.classList.add('fade-out');
        setTimeout(() => feedback.remove(), 300);
    }, 2000);
}

// Fecha modal com ESC
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && productModal.style.display === 'flex') {
        closeProductModal();
    }
});

// =============================================================================
// Geracao de SEO com IA
// =============================================================================

/**
 * Gera conteudo SEO usando a API de IA.
 * @param {string} fieldType - Tipo do campo: 'seo_focus_keyword', 'seo_title' ou 'seo_description'
 */
async function generateSEO(fieldType) {
    const nameInput = document.getElementById('name');
    const descriptionInput = document.getElementById('description');
    const targetInput = document.getElementById(fieldType);
    const loadingDiv = document.getElementById(fieldType + '_loading');

    // Valida se tem nome preenchido
    if (!nameInput.value.trim()) {
        alert('Preencha o nome da ocasiao antes de gerar SEO.');
        nameInput.focus();
        return;
    }

    // Mapeia o campo para o use_case da API
    const useCaseMap = {
        'seo_focus_keyword': 'seo_keywords',
        'seo_title': 'seo_title',
        'seo_description': 'seo_description'
    };
    const useCase = useCaseMap[fieldType];

    // Mostra loading
    loadingDiv.style.display = 'flex';
    targetInput.disabled = true;

    try {
        const response = await fetch('/admin/api/ai/generate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify({
                use_case: useCase,
                title: nameInput.value.trim(),
                content: descriptionInput.value.trim()
            })
        });

        const data = await response.json();

        if (!response.ok) {
            throw new Error(data.detail || 'Erro ao gerar conteudo');
        }

        // Processa o resultado
        let generatedContent = data.generated_content || '';

        // Para keywords, pega apenas a primeira se vier lista
        if (fieldType === 'seo_focus_keyword') {
            generatedContent = generatedContent.split(',')[0].trim();
            generatedContent = generatedContent.split('\n')[0].trim();
        }

        // Remove aspas extras se houver
        generatedContent = generatedContent.replace(/^["']|["']$/g, '').trim();

        // Preenche o campo
        targetInput.value = generatedContent;

        // Dispara evento de input para atualizar contadores
        targetInput.dispatchEvent(new Event('input'));

    } catch (error) {
        console.error('Erro na geracao:', error);
        alert('Erro ao gerar: ' + error.message);
    } finally {
        loadingDiv.style.display = 'none';
        targetInput.disabled = false;
    }
}

/**
 * Gera todos os campos SEO em sequencia.
 */
async function generateAllSEO() {
    const fields = ['seo_focus_keyword', 'seo_title', 'seo_description'];

    for (const field of fields) {
        await generateSEO(field);
        // Pequeno delay entre chamadas para evitar rate limiting
        await new Promise(resolve => setTimeout(resolve, 500));
    }
}
</script>
{% endblock %}
