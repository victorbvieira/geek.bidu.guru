{% extends "admin/base.html" %}

{% block title %}{{ 'Editar' if post else 'Novo' }} Post{% endblock %}

{% block breadcrumb %}
<span>/</span>
<a href="/admin/posts">Posts</a>
<span>/</span>
<span class="current">{{ 'Editar' if post else 'Novo' }}</span>
{% endblock %}

{% block content %}
<div class="admin-page-header">
    <h1 class="admin-page-title">{{ 'Editar Post' if post else 'Novo Post' }}</h1>
</div>

<form method="POST" action="{{ '/admin/posts/' ~ post.id if post else '/admin/posts' }}" class="admin-form">
    <div class="admin-form-grid">
        <!-- Main Content -->
        <div class="admin-form-main">
            <div class="admin-card">
                <div class="admin-form-group">
                    <label for="title" class="admin-form-label">Titulo *</label>
                    <input
                        type="text"
                        id="title"
                        name="title"
                        class="admin-form-input"
                        value="{{ post.title if post else '' }}"
                        required
                    >
                </div>

                <div class="admin-form-group">
                    <label for="slug" class="admin-form-label">Slug</label>
                    <input
                        type="text"
                        id="slug"
                        name="slug"
                        class="admin-form-input"
                        value="{{ post.slug if post else '' }}"
                        placeholder="gerado-automaticamente"
                    >
                    <div class="admin-form-hint">Deixe vazio para gerar automaticamente</div>
                </div>

                <div class="admin-form-group">
                    <label for="subtitle" class="admin-form-label">Subtitulo</label>
                    <input
                        type="text"
                        id="subtitle"
                        name="subtitle"
                        class="admin-form-input"
                        value="{{ post.subtitle if post else '' }}"
                    >
                </div>

                <div class="admin-form-group">
                    <label for="content" class="admin-form-label">Conteudo * (Markdown)</label>
                    <div class="markdown-editor">
                        <div class="markdown-toolbar">
                            <button type="button" class="md-btn" data-action="bold" title="Negrito (Ctrl+B)"><strong>B</strong></button>
                            <button type="button" class="md-btn" data-action="italic" title="Italico (Ctrl+I)"><em>I</em></button>
                            <button type="button" class="md-btn" data-action="heading" title="Titulo">H</button>
                            <button type="button" class="md-btn" data-action="link" title="Link">ðŸ”—</button>
                            <button type="button" class="md-btn" data-action="image" title="Imagem">ðŸ–¼</button>
                            <button type="button" class="md-btn" data-action="list" title="Lista">â€¢</button>
                            <button type="button" class="md-btn" data-action="olist" title="Lista numerada">1.</button>
                            <button type="button" class="md-btn" data-action="quote" title="Citacao">"</button>
                            <button type="button" class="md-btn" data-action="code" title="Codigo">&lt;/&gt;</button>
                            <span class="md-toolbar-separator"></span>
                            <button type="button" class="md-btn md-btn-product" data-action="product" title="Inserir Produto">ðŸ›’ Produto</button>
                            <span class="md-toolbar-separator"></span>
                            <button type="button" class="md-btn md-btn-preview" data-action="preview" title="Preview">Preview</button>
                        </div>
                        <div class="markdown-panels">
                            <textarea
                                id="content"
                                name="content"
                                class="admin-form-textarea markdown-input"
                                required
                            >{{ post.content if post else '' }}</textarea>
                            <div class="markdown-preview" id="markdown-preview">
                                <p class="preview-placeholder">Clique em "Preview" para visualizar</p>
                            </div>
                        </div>
                    </div>
                    <div class="admin-form-hint">
                        Suporta Markdown: **negrito**, *italico*, # titulo, [link](url), ![imagem](url)<br>
                        <strong>Produtos:</strong> Use <code>[product:slug-do-produto]</code> para inserir um card de produto no conteudo
                    </div>
                </div>
            </div>

            <!-- SEO -->
            <div class="admin-card">
                <div class="admin-card-header">
                    <h3 class="admin-card-title">SEO</h3>
                    <button type="button" class="admin-btn admin-btn-sm admin-btn-secondary" onclick="generateAllSEO()" title="Gerar todos os campos SEO com IA">
                        ðŸ¤– Gerar Tudo
                    </button>
                </div>

                <div class="admin-form-group">
                    <label for="seo_focus_keyword" class="admin-form-label">
                        Palavra-chave foco
                        <button type="button" class="admin-btn-icon-sm" onclick="generateSEO('seo_focus_keyword')" title="Gerar com IA">ðŸ¤–</button>
                    </label>
                    <input
                        type="text"
                        id="seo_focus_keyword"
                        name="seo_focus_keyword"
                        class="admin-form-input"
                        value="{{ post.seo_focus_keyword if post else '' }}"
                        placeholder="Ex: presentes geek, funko pop marvel"
                    >
                    <div class="admin-form-hint">Palavra-chave principal para otimizacao SEO</div>
                </div>

                <div class="admin-form-group">
                    <label for="seo_title" class="admin-form-label">
                        Titulo SEO
                        <button type="button" class="admin-btn-icon-sm" onclick="generateSEO('seo_title')" title="Gerar com IA">ðŸ¤–</button>
                    </label>
                    <input
                        type="text"
                        id="seo_title"
                        name="seo_title"
                        class="admin-form-input"
                        value="{{ post.seo_title if post else '' }}"
                        maxlength="60"
                    >
                    <div class="admin-form-hint"><span id="seo_title_count">{{ (post.seo_title|length) if post and post.seo_title else 0 }}</span>/60 caracteres</div>
                </div>

                <div class="admin-form-group">
                    <label for="seo_description" class="admin-form-label">
                        Descricao SEO
                        <button type="button" class="admin-btn-icon-sm" onclick="generateSEO('seo_description')" title="Gerar com IA">ðŸ¤–</button>
                    </label>
                    <textarea
                        id="seo_description"
                        name="seo_description"
                        class="admin-form-textarea"
                        style="min-height: 80px;"
                        maxlength="160"
                    >{{ post.seo_description if post else '' }}</textarea>
                    <div class="admin-form-hint"><span id="seo_description_count">{{ (post.seo_description|length) if post and post.seo_description else 0 }}</span>/160 caracteres</div>
                </div>

                <div id="seo-loading" style="display: none; text-align: center; padding: 1rem; color: var(--admin-text-muted);">
                    <div class="ai-spinner"></div>
                    <span>Gerando com IA...</span>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="admin-form-sidebar">
            <!-- Publish -->
            <div class="admin-card">
                <div class="admin-card-header">
                    <h3 class="admin-card-title">Publicar</h3>
                </div>

                <div class="admin-form-group">
                    <label for="status" class="admin-form-label">Status</label>
                    <select id="status" name="status" class="admin-form-select">
                        <option value="draft" {% if not post or post.status.value == 'draft' %}selected{% endif %}>Rascunho</option>
                        <option value="published" {% if post and post.status.value == 'published' %}selected{% endif %}>Publicado</option>
                        <option value="scheduled" {% if post and post.status.value == 'scheduled' %}selected{% endif %}>Agendado</option>
                        <option value="archived" {% if post and post.status.value == 'archived' %}selected{% endif %}>Arquivado</option>
                    </select>
                </div>

                <div class="admin-form-group">
                    <label for="publish_at" class="admin-form-label">Data de Publicacao</label>
                    <input
                        type="datetime-local"
                        id="publish_at"
                        name="publish_at"
                        class="admin-form-input"
                        value="{{ post.publish_at.strftime('%Y-%m-%dT%H:%M') if post and post.publish_at else '' }}"
                    >
                </div>

                <div class="admin-form-actions" style="flex-direction: row;">
                    <button type="submit" class="admin-btn admin-btn-primary" style="flex: 1;">
                        {{ 'Salvar' if post else 'Criar Post' }}
                    </button>
                    {% if post %}
                    <a href="/blog/{{ post.slug }}" target="_blank" class="admin-btn admin-btn-secondary">
                        Ver
                    </a>
                    {% endif %}
                </div>
            </div>

            <!-- Type & Category -->
            <div class="admin-card">
                <div class="admin-form-group">
                    <label for="type" class="admin-form-label">Tipo</label>
                    <select id="type" name="type" class="admin-form-select">
                        <option value="product_single" {% if post and post.type.value == 'product_single' %}selected{% endif %}>Review de Produto</option>
                        <option value="listicle" {% if not post or post.type.value == 'listicle' %}selected{% endif %}>Listicle (Top 10)</option>
                        <option value="guide" {% if post and post.type.value == 'guide' %}selected{% endif %}>Guia de Compra</option>
                    </select>
                </div>

                <div class="admin-form-group">
                    <label for="category_id" class="admin-form-label">Categoria</label>
                    <select id="category_id" name="category_id" class="admin-form-select">
                        <option value="">Sem categoria</option>
                        {% for category in categories %}
                        <option value="{{ category.id }}" {% if post and post.category_id == category.id %}selected{% endif %}>
                            {{ category.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <!-- Featured Image -->
            <div class="admin-card">
                <div class="admin-form-group" style="margin-bottom: 0;">
                    <label class="admin-form-label">Imagem Destacada</label>

                    <!-- Preview da imagem -->
                    <div class="featured-image-preview" id="featured-image-preview">
                        {% if post and post.featured_image_url %}
                        <img src="{{ post.featured_image_url }}" alt="Preview">
                        {% else %}
                        <div class="image-placeholder">
                            <span>1200x630 px</span>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Upload e URL -->
                    <div class="featured-image-controls">
                        <input type="file" id="featured-image-file" accept="image/jpeg,image/png,image/webp,image/gif" style="display: none;">
                        <button type="button" class="admin-btn admin-btn-secondary admin-btn-sm" onclick="document.getElementById('featured-image-file').click()">
                            Upload
                        </button>
                        <span class="upload-status" id="featured-upload-status"></span>
                    </div>

                    <input
                        type="url"
                        id="featured_image_url"
                        name="featured_image_url"
                        class="admin-form-input"
                        value="{{ post.featured_image_url if post and post.featured_image_url else '' }}"
                        placeholder="Ou cole uma URL externa..."
                        style="margin-top: 0.5rem;"
                    >
                    <div class="admin-form-hint">Redimensionada para 1200x630 px (Open Graph). Max: 5MB.</div>
                </div>
            </div>

            <!-- Tags -->
            <div class="admin-card">
                <div class="admin-form-group" style="margin-bottom: 0;">
                    <label for="tags" class="admin-form-label">
                        Tags
                        <button type="button" class="admin-btn-icon-sm" onclick="generateTags()" title="Gerar com IA">ðŸ¤–</button>
                    </label>
                    <input
                        type="text"
                        id="tags"
                        name="tags"
                        class="admin-form-input"
                        value="{{ post.tags | join(', ') if post and post.tags else '' }}"
                        placeholder="tag1, tag2, tag3"
                    >
                    <div class="admin-form-hint">Separadas por virgula</div>
                    <div id="tags_loading" style="display: none; text-align: center; padding: 0.5rem; color: var(--admin-text-muted);">
                        <div class="ai-spinner"></div>
                        <span>Gerando...</span>
                    </div>
                </div>
            </div>

        </div>
    </div>
</form>

<!-- Modal de Selecao de Produto -->
<div id="product-modal" class="product-modal" style="display: none;">
    <div class="product-modal-backdrop" onclick="closeProductModal()"></div>
    <div class="product-modal-content">
        <div class="product-modal-header">
            <h3>Inserir Produto no Conteudo</h3>
            <button type="button" class="product-modal-close" onclick="closeProductModal()">&times;</button>
        </div>
        <div class="product-modal-search">
            <input
                type="text"
                id="product-search"
                class="admin-form-input"
                placeholder="Buscar produto por nome..."
                oninput="filterProducts(this.value)"
            >
        </div>
        <div class="product-modal-list" id="product-modal-list">
            {% for product in products %}
            <div class="product-modal-item" data-slug="{{ product.slug }}" data-name="{{ product.name|lower }}" onclick="insertProduct('{{ product.slug }}', '{{ product.name|e }}')">
                <div class="product-modal-item-image">
                    {% if product.main_image_url %}
                    <img src="{{ product.main_image_url }}" alt="{{ product.name }}" loading="lazy">
                    {% else %}
                    <span class="no-image">ðŸ“¦</span>
                    {% endif %}
                </div>
                <div class="product-modal-item-info">
                    <span class="product-modal-item-name">{{ product.name }}</span>
                    <span class="product-modal-item-meta">
                        <span class="platform platform-{{ product.platform.value }}">{{ product.platform.value|title }}</span>
                        {% if product.price %}
                        <span class="price">R$ {{ "%.2f"|format(product.price) }}</span>
                        {% endif %}
                    </span>
                    <code class="product-modal-item-slug">[product:{{ product.slug }}]</code>
                </div>
            </div>
            {% else %}
            <div class="product-modal-empty">
                <p>Nenhum produto cadastrado.</p>
                <a href="/admin/products/new" class="admin-btn admin-btn-primary">Criar Produto</a>
            </div>
            {% endfor %}
        </div>
        <div class="product-modal-footer">
            <span class="product-modal-hint">Clique em um produto para inserir o shortcode na posicao do cursor</span>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Markdown Editor com Preview
(function() {
    const textarea = document.getElementById('content');
    const preview = document.getElementById('markdown-preview');
    const panels = document.querySelector('.markdown-panels');
    const previewBtn = document.querySelector('[data-action="preview"]');
    const toolbar = document.querySelector('.markdown-toolbar');

    if (!textarea || !preview) return;

    let previewMode = 'edit'; // 'edit', 'split', 'preview'
    let previewTimeout = null;

    // Toolbar actions
    const actions = {
        bold: () => wrapText('**', '**'),
        italic: () => wrapText('*', '*'),
        heading: () => insertAtLineStart('## '),
        link: () => {
            const url = prompt('URL do link:');
            if (url) wrapText('[', `](${url})`);
        },
        image: () => {
            const url = prompt('URL da imagem:');
            if (url) insertText(`![Imagem](${url})`);
        },
        list: () => insertAtLineStart('- '),
        olist: () => insertAtLineStart('1. '),
        quote: () => insertAtLineStart('> '),
        code: () => {
            const selection = getSelection();
            if (selection.includes('\n')) {
                wrapText('\n```\n', '\n```\n');
            } else {
                wrapText('`', '`');
            }
        },
        product: () => openProductModal(),
        preview: () => togglePreview()
    };

    // Bind toolbar buttons
    toolbar.querySelectorAll('.md-btn').forEach(btn => {
        const action = btn.dataset.action;
        if (action && actions[action]) {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                actions[action]();
                textarea.focus();
            });
        }
    });

    // Helper functions
    function getSelection() {
        return textarea.value.substring(textarea.selectionStart, textarea.selectionEnd);
    }

    function wrapText(before, after) {
        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;
        const selection = textarea.value.substring(start, end);
        const replacement = before + selection + after;

        textarea.setRangeText(replacement, start, end, 'select');
        textarea.selectionStart = start + before.length;
        textarea.selectionEnd = end + before.length;
    }

    function insertText(text) {
        const start = textarea.selectionStart;
        textarea.setRangeText(text, start, start, 'end');
    }

    function insertAtLineStart(prefix) {
        const start = textarea.selectionStart;
        const value = textarea.value;

        // Find line start
        let lineStart = start;
        while (lineStart > 0 && value[lineStart - 1] !== '\n') {
            lineStart--;
        }

        // Check if already has prefix
        const lineContent = value.substring(lineStart);
        if (lineContent.startsWith(prefix)) {
            return; // Already has prefix
        }

        textarea.setRangeText(prefix, lineStart, lineStart, 'end');
    }

    // Toggle preview modes
    function togglePreview() {
        if (previewMode === 'edit') {
            previewMode = 'split';
            panels.classList.add('split-view');
            panels.classList.remove('preview-only');
            previewBtn.classList.add('active');
            previewBtn.textContent = 'Split';
            updatePreview();
        } else if (previewMode === 'split') {
            previewMode = 'preview';
            panels.classList.remove('split-view');
            panels.classList.add('preview-only');
            previewBtn.textContent = 'Editar';
            updatePreview();
        } else {
            previewMode = 'edit';
            panels.classList.remove('split-view', 'preview-only');
            previewBtn.classList.remove('active');
            previewBtn.textContent = 'Preview';
        }
    }

    // Update preview content
    async function updatePreview() {
        if (previewMode === 'edit') return;

        const content = textarea.value;
        if (!content.trim()) {
            preview.innerHTML = '<p class="preview-placeholder">Nenhum conteudo para visualizar</p>';
            return;
        }

        try {
            const response = await fetch('/api/v1/posts/preview', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ content })
            });

            if (response.ok) {
                const data = await response.json();
                preview.innerHTML = data.html;
            } else {
                preview.innerHTML = '<p class="preview-placeholder">Erro ao renderizar preview</p>';
            }
        } catch (error) {
            console.error('Preview error:', error);
            preview.innerHTML = '<p class="preview-placeholder">Erro ao renderizar preview</p>';
        }
    }

    // Debounced preview update
    function schedulePreviewUpdate() {
        if (previewMode === 'edit') return;

        if (previewTimeout) {
            clearTimeout(previewTimeout);
        }
        previewTimeout = setTimeout(updatePreview, 500);
    }

    // Listen for content changes
    textarea.addEventListener('input', schedulePreviewUpdate);

    // Keyboard shortcuts
    textarea.addEventListener('keydown', (e) => {
        if (e.ctrlKey || e.metaKey) {
            switch (e.key.toLowerCase()) {
                case 'b':
                    e.preventDefault();
                    actions.bold();
                    break;
                case 'i':
                    e.preventDefault();
                    actions.italic();
                    break;
                case 'k':
                    e.preventDefault();
                    actions.link();
                    break;
            }
        }
    });

    // Tab handling for code blocks
    textarea.addEventListener('keydown', (e) => {
        if (e.key === 'Tab') {
            e.preventDefault();
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;

            if (e.shiftKey) {
                // Unindent
                const lineStart = textarea.value.lastIndexOf('\n', start - 1) + 1;
                const lineContent = textarea.value.substring(lineStart);
                if (lineContent.startsWith('    ') || lineContent.startsWith('\t')) {
                    const removeChars = lineContent.startsWith('    ') ? 4 : 1;
                    textarea.setRangeText('', lineStart, lineStart + removeChars, 'end');
                }
            } else {
                // Indent
                textarea.setRangeText('    ', start, end, 'end');
            }
        }
    });
})();

// =============================================================================
// Modal de Selecao de Produto para Shortcode
// =============================================================================

const productModal = document.getElementById('product-modal');
const productSearchInput = document.getElementById('product-search');
const productModalList = document.getElementById('product-modal-list');
const contentTextarea = document.getElementById('content');

// Guarda a posicao do cursor antes de abrir o modal
let cursorPosition = 0;

function openProductModal() {
    // Salva a posicao atual do cursor
    cursorPosition = contentTextarea.selectionStart;

    // Mostra o modal
    productModal.style.display = 'flex';

    // Limpa a busca
    productSearchInput.value = '';
    filterProducts('');

    // Foca no campo de busca
    setTimeout(() => productSearchInput.focus(), 100);
}

function closeProductModal() {
    productModal.style.display = 'none';

    // Retorna o foco para o textarea
    contentTextarea.focus();
    contentTextarea.setSelectionRange(cursorPosition, cursorPosition);
}

function filterProducts(query) {
    const items = productModalList.querySelectorAll('.product-modal-item');
    const lowerQuery = query.toLowerCase().trim();

    items.forEach(item => {
        const name = item.dataset.name || '';
        const slug = item.dataset.slug || '';

        if (!lowerQuery || name.includes(lowerQuery) || slug.includes(lowerQuery)) {
            item.style.display = 'flex';
        } else {
            item.style.display = 'none';
        }
    });
}

function insertProduct(slug, name) {
    const shortcode = `[product:${slug}]`;

    // Pega o conteudo atual
    const content = contentTextarea.value;

    // Verifica se estamos no inicio de uma linha ou precisamos de quebra
    let prefix = '';
    let suffix = '\n';

    // Se nao estamos no inicio do conteudo
    if (cursorPosition > 0) {
        const charBefore = content[cursorPosition - 1];
        // Se o caractere anterior nao e uma quebra de linha, adiciona duas
        if (charBefore !== '\n') {
            prefix = '\n\n';
        } else if (cursorPosition > 1 && content[cursorPosition - 2] !== '\n') {
            // Se tem apenas uma quebra, adiciona mais uma
            prefix = '\n';
        }
    }

    // Verifica se precisamos de quebra depois
    if (cursorPosition < content.length) {
        const charAfter = content[cursorPosition];
        if (charAfter !== '\n') {
            suffix = '\n\n';
        }
    }

    // Insere o shortcode
    const insertion = prefix + shortcode + suffix;
    const newContent = content.slice(0, cursorPosition) + insertion + content.slice(cursorPosition);

    contentTextarea.value = newContent;

    // Atualiza posicao do cursor para depois do shortcode
    const newPosition = cursorPosition + insertion.length;
    contentTextarea.setSelectionRange(newPosition, newPosition);

    // Fecha o modal
    closeProductModal();

    // Dispara evento de input para atualizar preview
    contentTextarea.dispatchEvent(new Event('input'));

    // Feedback visual
    showInsertFeedback(name);
}

function showInsertFeedback(productName) {
    // Cria elemento de feedback
    const feedback = document.createElement('div');
    feedback.className = 'insert-feedback';
    feedback.textContent = `Produto "${productName}" inserido!`;
    document.body.appendChild(feedback);

    // Remove apos animacao
    setTimeout(() => {
        feedback.classList.add('fade-out');
        setTimeout(() => feedback.remove(), 300);
    }, 2000);
}

// Fecha modal com ESC
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && productModal.style.display === 'flex') {
        closeProductModal();
    }
});

// =============================================================================
// Upload de Imagem Destacada
// =============================================================================

const featuredImageFile = document.getElementById('featured-image-file');
const featuredImageUrl = document.getElementById('featured_image_url');
const featuredImagePreview = document.getElementById('featured-image-preview');
const featuredUploadStatus = document.getElementById('featured-upload-status');

if (featuredImageFile) {
    featuredImageFile.addEventListener('change', async function(e) {
        const file = e.target.files[0];
        if (!file) return;

        const allowedTypes = ['image/jpeg', 'image/png', 'image/webp', 'image/gif'];
        if (!allowedTypes.includes(file.type)) {
            featuredUploadStatus.textContent = 'Tipo nao permitido';
            featuredUploadStatus.style.color = 'var(--admin-danger)';
            return;
        }

        if (file.size > 5 * 1024 * 1024) {
            featuredUploadStatus.textContent = 'Arquivo muito grande (max 5MB)';
            featuredUploadStatus.style.color = 'var(--admin-danger)';
            return;
        }

        featuredUploadStatus.textContent = 'Enviando...';
        featuredUploadStatus.style.color = 'var(--admin-text-muted)';

        const formData = new FormData();
        formData.append('file', file);

        try {
            const response = await fetch('/admin/upload/post-image', {
                method: 'POST',
                body: formData,
            });

            const data = await response.json();

            if (response.ok) {
                featuredImageUrl.value = data.url;
                featuredImagePreview.innerHTML = `<img src="${data.url}" alt="Preview">`;
                featuredUploadStatus.textContent = '1200x630 OK!';
                featuredUploadStatus.style.color = 'var(--admin-success)';
            } else {
                featuredUploadStatus.textContent = data.detail || 'Erro';
                featuredUploadStatus.style.color = 'var(--admin-danger)';
            }
        } catch (error) {
            featuredUploadStatus.textContent = 'Erro de conexao';
            featuredUploadStatus.style.color = 'var(--admin-danger)';
        }

        // Limpa input file
        featuredImageFile.value = '';
    });
}

// Atualiza preview quando URL e alterada manualmente
if (featuredImageUrl) {
    featuredImageUrl.addEventListener('change', function() {
        const url = this.value.trim();
        if (url) {
            featuredImagePreview.innerHTML = `<img src="${url}" alt="Preview">`;
        } else {
            featuredImagePreview.innerHTML = '<div class="image-placeholder"><span>1200x630 px</span></div>';
        }
    });
}

// =============================================================================
// Geracao de SEO com IA
// =============================================================================

// Atualiza contadores de caracteres
document.getElementById('seo_title').addEventListener('input', function() {
    document.getElementById('seo_title_count').textContent = this.value.length;
});

document.getElementById('seo_description').addEventListener('input', function() {
    document.getElementById('seo_description_count').textContent = this.value.length;
});

// Mapeamento de campos para use_case da API
// Usa os novos use_cases especificos para Post quando disponiveis
const fieldToUseCase = {
    'seo_title': 'post_seo_title',
    'seo_description': 'post_seo_description',
    'seo_focus_keyword': 'post_seo_keyword',
    'tags': 'post_tags'
};

// Fallback para use_cases genericos caso os especificos nao existam
const fallbackUseCase = {
    'post_seo_title': 'seo_title',
    'post_seo_description': 'seo_description',
    'post_seo_keyword': 'seo_keywords'
};

async function generateSEO(field) {
    const title = document.getElementById('title').value.trim();
    const subtitle = document.getElementById('subtitle').value.trim();
    const content = document.getElementById('content').value.trim();

    if (!title && !content) {
        alert('Preencha o titulo ou conteudo antes de gerar SEO');
        return;
    }

    const useCase = fieldToUseCase[field] || field;
    const loadingDiv = document.getElementById('seo-loading');
    const targetInput = document.getElementById(field);

    loadingDiv.style.display = 'flex';
    targetInput.disabled = true;

    try {
        const response = await fetch('/admin/api/ai/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                use_case: useCase,
                title: title,
                subtitle: subtitle,
                content: content.substring(0, 2000)
            })
        });

        let data = await response.json();

        // Se o use_case especifico falhar, tenta o generico
        if (!response.ok && fallbackUseCase[useCase]) {
            const fallbackResponse = await fetch('/admin/api/ai/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    use_case: fallbackUseCase[useCase],
                    title: title,
                    subtitle: subtitle,
                    content: content.substring(0, 2000)
                })
            });
            data = await fallbackResponse.json();
            if (fallbackResponse.ok) {
                processGeneratedContent(field, data.generated_content, targetInput);
                return;
            }
        }

        if (response.ok) {
            processGeneratedContent(field, data.generated_content, targetInput);
        } else {
            alert('Erro ao gerar: ' + (data.detail || 'Erro desconhecido'));
        }
    } catch (error) {
        alert('Erro de conexao: ' + error.message);
    } finally {
        loadingDiv.style.display = 'none';
        targetInput.disabled = false;
    }
}

function processGeneratedContent(field, generatedContent, targetInput) {
    if (field === 'seo_focus_keyword') {
        // Remove prefixos comuns e pega a primeira keyword
        generatedContent = generatedContent
            .replace(/^(palavras?-?chave|keywords?|foco|principal)[:.\s-]*/i, '')
            .split(/[,\n]/)[0]
            .trim();
    }
    targetInput.value = generatedContent;
    // Atualiza contador se existir
    const countSpan = document.getElementById(field + '_count');
    if (countSpan) {
        countSpan.textContent = generatedContent.length;
    }
}

// Funcao para gerar tags com IA
async function generateTags() {
    const title = document.getElementById('title').value.trim();
    const subtitle = document.getElementById('subtitle').value.trim();
    const content = document.getElementById('content').value.trim();

    if (!title && !content) {
        alert('Preencha o titulo ou conteudo antes de gerar tags');
        return;
    }

    const loadingDiv = document.getElementById('tags_loading');
    const tagsInput = document.getElementById('tags');

    loadingDiv.style.display = 'flex';
    tagsInput.disabled = true;

    try {
        const response = await fetch('/admin/api/ai/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                use_case: 'post_tags',
                title: title,
                subtitle: subtitle,
                content: content.substring(0, 2000)
            })
        });

        const data = await response.json();

        if (response.ok) {
            // Limpa e formata as tags
            let tags = data.generated_content
                .replace(/^(tags?|sugestoes?)[:.\s-]*/i, '')
                .split(/[,\n]/)
                .map(t => t.trim().toLowerCase())
                .filter(t => t && !t.startsWith('#'))
                .slice(0, 5)
                .join(', ');

            tagsInput.value = tags;
        } else {
            alert('Erro ao gerar tags: ' + (data.detail || 'Erro desconhecido'));
        }
    } catch (error) {
        alert('Erro de conexao: ' + error.message);
    } finally {
        loadingDiv.style.display = 'none';
        tagsInput.disabled = false;
    }
}

async function generateAllSEO() {
    const title = document.getElementById('title').value.trim();
    const subtitle = document.getElementById('subtitle').value.trim();
    const content = document.getElementById('content').value.trim();

    if (!title && !content) {
        alert('Preencha o titulo ou conteudo antes de gerar SEO');
        return;
    }

    const loadingDiv = document.getElementById('seo-loading');
    const tagsLoading = document.getElementById('tags_loading');
    const seoKeyword = document.getElementById('seo_focus_keyword');
    const seoTitle = document.getElementById('seo_title');
    const seoDescription = document.getElementById('seo_description');
    const tagsInput = document.getElementById('tags');

    loadingDiv.style.display = 'flex';
    tagsLoading.style.display = 'flex';
    seoKeyword.disabled = true;
    seoTitle.disabled = true;
    seoDescription.disabled = true;
    tagsInput.disabled = true;

    const requestBody = {
        title: title,
        subtitle: subtitle,
        content: content.substring(0, 2000)
    };

    try {
        // Gera keyword, titulo, descricao e tags em paralelo
        // Usa os novos use_cases especificos para Post
        const [keywordResponse, titleResponse, descResponse, tagsResponse] = await Promise.all([
            fetch('/admin/api/ai/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ...requestBody, use_case: 'post_seo_keyword' })
            }),
            fetch('/admin/api/ai/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ...requestBody, use_case: 'post_seo_title' })
            }),
            fetch('/admin/api/ai/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ...requestBody, use_case: 'post_seo_description' })
            }),
            fetch('/admin/api/ai/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ...requestBody, use_case: 'post_tags' })
            })
        ]);

        const [keywordData, titleData, descData, tagsData] = await Promise.all([
            keywordResponse.json(),
            titleResponse.json(),
            descResponse.json(),
            tagsResponse.json()
        ]);

        if (keywordResponse.ok) {
            // Pega apenas a primeira keyword
            let keyword = keywordData.generated_content
                .replace(/^(palavras?-?chave|keywords?|foco|principal)[:.\s-]*/i, '')
                .split(/[,\n]/)[0]
                .trim();
            seoKeyword.value = keyword;
        }

        if (titleResponse.ok) {
            seoTitle.value = titleData.generated_content;
            document.getElementById('seo_title_count').textContent = titleData.generated_content.length;
        }

        if (descResponse.ok) {
            seoDescription.value = descData.generated_content;
            document.getElementById('seo_description_count').textContent = descData.generated_content.length;
        }

        if (tagsResponse.ok) {
            // Limpa e formata as tags
            let tags = tagsData.generated_content
                .replace(/^(tags?|sugestoes?)[:.\s-]*/i, '')
                .split(/[,\n]/)
                .map(t => t.trim().toLowerCase())
                .filter(t => t && !t.startsWith('#'))
                .slice(0, 5)
                .join(', ');
            tagsInput.value = tags;
        }

        if (!keywordResponse.ok || !titleResponse.ok || !descResponse.ok || !tagsResponse.ok) {
            alert('Alguns campos nao foram gerados. Verifique a configuracao de IA.');
        }
    } catch (error) {
        alert('Erro de conexao: ' + error.message);
    } finally {
        loadingDiv.style.display = 'none';
        tagsLoading.style.display = 'none';
        seoKeyword.disabled = false;
        seoTitle.disabled = false;
        seoDescription.disabled = false;
        tagsInput.disabled = false;
    }
}
</script>
{% endblock %}
