{% extends "admin/base.html" %}

{% block title %}{{ 'Editar' if product else 'Novo' }} Produto{% endblock %}

{% block breadcrumb %}
<span>/</span>
<a href="/admin/products">Produtos</a>
<span>/</span>
<span class="current">{{ 'Editar' if product else 'Novo' }}</span>
{% endblock %}

{% block content %}
<div class="admin-page-header">
    <h1 class="admin-page-title">{{ 'Editar Produto' if product else 'Novo Produto' }}</h1>
</div>

<form method="POST" action="{{ '/admin/products/' ~ product.id if product else '/admin/products' }}" class="admin-form">
    <div class="admin-form-grid">
        <!-- Main Content -->
        <div class="admin-form-main">
            <div class="admin-card">
                <div class="admin-form-group">
                    <label for="name" class="admin-form-label">Nome do Produto *</label>
                    <input
                        type="text"
                        id="name"
                        name="name"
                        class="admin-form-input"
                        value="{{ product.name if product else '' }}"
                        required
                    >
                </div>

                <div class="admin-form-group">
                    <label for="slug" class="admin-form-label">Slug</label>
                    <input
                        type="text"
                        id="slug"
                        name="slug"
                        class="admin-form-input"
                        value="{{ product.slug if product else '' }}"
                        placeholder="gerado-automaticamente"
                    >
                </div>

                <div class="admin-form-group">
                    <label for="short_description" class="admin-form-label">
                        Descricao Curta
                        <button type="button" class="admin-btn-icon-sm" onclick="generateProductDescription('short')" title="Gerar com IA">ü§ñ</button>
                    </label>
                    <textarea
                        id="short_description"
                        name="short_description"
                        class="admin-form-textarea"
                        style="min-height: 80px;"
                        maxlength="150"
                    >{{ product.short_description if product else '' }}</textarea>
                    <div class="admin-form-hint"><span id="short_description_count">{{ (product.short_description|length) if product and product.short_description else 0 }}</span>/150 caracteres</div>
                </div>

                <div class="admin-form-group">
                    <label for="long_description" class="admin-form-label">
                        Descricao Completa
                        <button type="button" class="admin-btn-icon-sm" onclick="generateProductDescription('long')" title="Gerar com IA">ü§ñ</button>
                    </label>
                    <textarea
                        id="long_description"
                        name="long_description"
                        class="admin-form-textarea"
                        style="min-height: 150px;"
                    >{{ product.long_description if product else '' }}</textarea>
                </div>

                <div id="description-loading" style="display: none; text-align: center; padding: 0.5rem; color: var(--admin-text-muted);">
                    <span>Gerando descricao com IA...</span>
                </div>
            </div>

            <!-- Affiliate Link -->
            <div class="admin-card">
                <div class="admin-card-header">
                    <h3 class="admin-card-title">Link de Afiliado</h3>
                </div>

                <div class="admin-form-group">
                    <label for="affiliate_url_raw" class="admin-form-label">URL do Afiliado *</label>
                    <input
                        type="url"
                        id="affiliate_url_raw"
                        name="affiliate_url_raw"
                        class="admin-form-input"
                        value="{{ product.affiliate_url_raw if product else '' }}"
                        placeholder="https://amazon.com.br/dp/..."
                        required
                    >
                </div>

                <div class="admin-form-group">
                    <label for="affiliate_redirect_slug" class="admin-form-label">Slug de Redirecionamento *</label>
                    <input
                        type="text"
                        id="affiliate_redirect_slug"
                        name="affiliate_redirect_slug"
                        class="admin-form-input"
                        value="{{ product.affiliate_redirect_slug if product else '' }}"
                        placeholder="produto-amazon"
                        required
                    >
                    <div class="admin-form-hint">URL: /goto/{{ product.affiliate_redirect_slug if product else 'seu-slug' }}</div>
                </div>
            </div>

            <!-- Redes Sociais - Se√ß√£o Colaps√°vel -->
            <div class="admin-card social-networks-section">
                <div class="admin-card-header">
                    <h3 class="admin-card-title">Redes Sociais</h3>
                    <span class="admin-form-hint" style="margin-left: auto;">Clique no √≠cone para configurar</span>
                </div>

                <!-- Grid de √≠cones das redes sociais -->
                <div class="social-networks-grid">
                    <!-- Instagram -->
                    <button type="button" class="social-network-btn {% if product and (product.instagram_headline or product.instagram_hashtags) %}configured{% endif %}" onclick="toggleSocialPanel('instagram')" title="Instagram">
                        <span class="social-icon">üì∏</span>
                        <span class="social-name">Instagram</span>
                        {% if product and (product.instagram_headline or product.instagram_hashtags) %}
                        <span class="social-badge">‚úì</span>
                        {% endif %}
                    </button>

                    <!-- TikTok (futuro) -->
                    <button type="button" class="social-network-btn disabled" title="TikTok (em breve)" disabled>
                        <span class="social-icon">üéµ</span>
                        <span class="social-name">TikTok</span>
                        <span class="social-soon">Em breve</span>
                    </button>

                    <!-- Twitter/X (futuro) -->
                    <button type="button" class="social-network-btn disabled" title="Twitter/X (em breve)" disabled>
                        <span class="social-icon">üê¶</span>
                        <span class="social-name">Twitter</span>
                        <span class="social-soon">Em breve</span>
                    </button>

                    <!-- Facebook (futuro) -->
                    <button type="button" class="social-network-btn disabled" title="Facebook (em breve)" disabled>
                        <span class="social-icon">üìò</span>
                        <span class="social-name">Facebook</span>
                        <span class="social-soon">Em breve</span>
                    </button>

                    <!-- Pinterest (futuro) -->
                    <button type="button" class="social-network-btn disabled" title="Pinterest (em breve)" disabled>
                        <span class="social-icon">üìå</span>
                        <span class="social-name">Pinterest</span>
                        <span class="social-soon">Em breve</span>
                    </button>
                </div>

                <!-- Painel Instagram (colaps√°vel) -->
                <div id="instagram-panel" class="social-panel" style="display: none;">
                    <div class="social-panel-header">
                        <h4>üì∏ Configura√ß√£o Instagram</h4>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <button type="button" class="admin-btn admin-btn-sm admin-btn-secondary" onclick="generateAllInstagram()" title="Gerar todos os campos Instagram com IA">
                                ü§ñ Gerar Tudo
                            </button>
                            <button type="button" class="social-panel-close" onclick="toggleSocialPanel('instagram')">&times;</button>
                        </div>
                    </div>

                    <div class="social-panel-content">
                        <div class="admin-form-row">
                            <div class="admin-form-group">
                                <label for="instagram_headline" class="admin-form-label">
                                    Headline
                                    <button type="button" class="admin-btn-icon-sm" onclick="generateInstagramField('headline')" title="Gerar com IA">ü§ñ</button>
                                </label>
                                <input
                                    type="text"
                                    id="instagram_headline"
                                    name="instagram_headline"
                                    class="admin-form-input"
                                    value="{{ product.instagram_headline if product else '' }}"
                                    placeholder="OFERTA IMPERDIVEL!"
                                    maxlength="40"
                                >
                                <div class="admin-form-hint"><span id="instagram_headline_count">{{ (product.instagram_headline|length) if product and product.instagram_headline else 0 }}</span>/40 caracteres</div>
                            </div>

                            <div class="admin-form-group">
                                <label for="instagram_badge" class="admin-form-label">
                                    Badge
                                    <button type="button" class="admin-btn-icon-sm" onclick="generateInstagramField('badge')" title="Gerar com IA">ü§ñ</button>
                                </label>
                                <input
                                    type="text"
                                    id="instagram_badge"
                                    name="instagram_badge"
                                    class="admin-form-input"
                                    value="{{ product.instagram_badge if product else '' }}"
                                    placeholder="NOVO!, BEST SELLER"
                                    maxlength="20"
                                >
                                <div class="admin-form-hint"><span id="instagram_badge_count">{{ (product.instagram_badge|length) if product and product.instagram_badge else 0 }}</span>/20 caracteres</div>
                            </div>
                        </div>

                        <div class="admin-form-group">
                            <label for="instagram_title" class="admin-form-label">
                                T√≠tulo Instagram
                                <button type="button" class="admin-btn-icon-sm" onclick="generateInstagramField('title')" title="Gerar com IA">ü§ñ</button>
                            </label>
                            <input
                                type="text"
                                id="instagram_title"
                                name="instagram_title"
                                class="admin-form-input"
                                value="{{ product.instagram_title if product else '' }}"
                                placeholder="Deixe vazio para usar nome do produto"
                                maxlength="100"
                            >
                            <div class="admin-form-hint">T√≠tulo curto (max 100 chars)</div>
                        </div>

                        <div class="admin-form-group">
                            <label for="instagram_hashtags" class="admin-form-label">
                                Hashtags
                                <button type="button" class="admin-btn-icon-sm" onclick="generateInstagramField('hashtags')" title="Gerar com IA">ü§ñ</button>
                            </label>
                            <input
                                type="text"
                                id="instagram_hashtags"
                                name="instagram_hashtags"
                                class="admin-form-input"
                                value="{{ product.instagram_hashtags | join(', ') if product and product.instagram_hashtags else '' }}"
                                placeholder="geek, gamer, oferta"
                            >
                            <div class="admin-form-hint">Separadas por v√≠rgula (sem #)</div>
                        </div>

                        <div class="admin-form-group">
                            <label for="instagram_caption" class="admin-form-label">
                                Caption
                                <button type="button" class="admin-btn-icon-sm" onclick="generateInstagramField('caption')" title="Gerar com IA">ü§ñ</button>
                            </label>
                            <textarea
                                id="instagram_caption"
                                name="instagram_caption"
                                class="admin-form-textarea"
                                style="min-height: 80px;"
                                placeholder="Caption pr√©-definida para posts..."
                            >{{ product.instagram_caption if product else '' }}</textarea>
                        </div>

                        {% if product %}
                        <!-- Preview do Post -->
                        <div class="admin-form-group" style="margin-top: 1rem; border-top: 1px solid var(--admin-border); padding-top: 1rem;">
                            <label class="admin-form-label">Preview do Post (1080x1080)</label>
                            <div id="instagram-preview-container" style="position: relative; width: 100%; height: 320px; overflow: hidden; border: 2px solid var(--admin-border); border-radius: 8px; background: #1a1a2e;">
                                <div id="instagram-preview-loading" style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: var(--admin-text-muted); z-index: 10;">
                                    Carregando preview...
                                </div>
                                <!-- Container com escala para mostrar post 1080x1080 em tamanho reduzido -->
                                <div style="width: 1080px; height: 1080px; transform: scale(0.296); transform-origin: top left;">
                                    <iframe
                                        id="instagram-preview-frame"
                                        style="width: 1080px; height: 1080px; border: none; background: #1a1a2e;"
                                        src="/admin/products/{{ product.id }}/instagram-preview"
                                    ></iframe>
                                </div>
                            </div>
                            <div style="margin-top: 0.5rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <button type="button" class="admin-btn admin-btn-secondary admin-btn-sm" onclick="refreshInstagramPreview()">
                                    üîÑ Atualizar Preview
                                </button>
                                <button type="button" class="admin-btn admin-btn-secondary admin-btn-sm" onclick="openPreviewFullscreen()">
                                    üîç Ver em Tamanho Real
                                </button>
                                <button type="button" class="admin-btn admin-btn-primary admin-btn-sm" onclick="downloadInstagramImage()" id="btn-download-image">
                                    üì• Download Imagem
                                </button>
                            </div>
                            <div id="download-status" style="display: none; margin-top: 0.5rem; padding: 0.5rem; border-radius: 4px; font-size: 0.85rem;"></div>
                        </div>

                        <!-- Estat√≠sticas de Publica√ß√£o (somente leitura) -->
                        <div class="admin-form-group" style="margin-top: 1.5rem; border-top: 1px solid var(--admin-border); padding-top: 1rem;">
                            <label class="admin-form-label">üìä Estat√≠sticas de Publica√ß√£o</label>

                            <div class="instagram-stats-grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-top: 0.75rem;">
                                <!-- IG Media ID -->
                                <div class="stat-item" style="background: var(--admin-bg-secondary); padding: 0.75rem; border-radius: 6px;">
                                    <div class="stat-label" style="font-size: 0.75rem; color: var(--admin-text-muted); margin-bottom: 0.25rem;">IG Media ID</div>
                                    <div class="stat-value" style="font-family: monospace; font-size: 0.85rem; word-break: break-all;">
                                        {{ product.last_ig_media_id if product.last_ig_media_id else '‚Äî' }}
                                    </div>
                                </div>

                                <!-- Quantidade de Publica√ß√µes -->
                                <div class="stat-item" style="background: var(--admin-bg-secondary); padding: 0.75rem; border-radius: 6px;">
                                    <div class="stat-label" style="font-size: 0.75rem; color: var(--admin-text-muted); margin-bottom: 0.25rem;">Publica√ß√µes</div>
                                    <div class="stat-value" style="font-size: 1.25rem; font-weight: 600; color: var(--admin-primary);">
                                        {{ product.post_count or 0 }}
                                    </div>
                                </div>

                                <!-- √öltima Publica√ß√£o -->
                                <div class="stat-item" style="background: var(--admin-bg-secondary); padding: 0.75rem; border-radius: 6px; grid-column: span 2;">
                                    <div class="stat-label" style="font-size: 0.75rem; color: var(--admin-text-muted); margin-bottom: 0.25rem;">√öltima Publica√ß√£o</div>
                                    <div class="stat-value" style="font-size: 0.9rem;">
                                        {% if product.last_post_date %}
                                        {{ product.last_post_date.strftime('%d/%m/%Y %H:%M') }}
                                        {% if product.last_post_url %}
                                        <a href="{{ product.last_post_url }}" target="_blank" rel="noopener" style="margin-left: 0.5rem; color: var(--admin-primary);">
                                            üîó Ver post
                                        </a>
                                        {% endif %}
                                        {% else %}
                                        <span style="color: var(--admin-text-muted);">Nunca publicado</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            {% if product.post_count > 0 %}
                            <div class="admin-form-hint" style="margin-top: 0.75rem;">
                                <a href="#" onclick="loadInstagramHistory(); return false;" style="color: var(--admin-primary);">
                                    üìú Ver hist√≥rico completo de publica√ß√µes
                                </a>
                            </div>
                            {% endif %}
                        </div>

                        <!-- Modal de Hist√≥rico de Publica√ß√µes -->
                        <div id="instagram-history-modal" class="admin-modal" style="display: none;">
                            <div class="admin-modal-backdrop" onclick="closeInstagramHistoryModal()"></div>
                            <div class="admin-modal-content" style="max-width: 600px;">
                                <div class="admin-modal-header">
                                    <h3>üìú Hist√≥rico de Publica√ß√µes</h3>
                                    <button type="button" class="admin-modal-close" onclick="closeInstagramHistoryModal()">&times;</button>
                                </div>
                                <div class="admin-modal-body" id="instagram-history-content">
                                    <div style="text-align: center; padding: 2rem; color: var(--admin-text-muted);">
                                        Carregando hist√≥rico...
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <div class="admin-form-hint" style="margin-top: 1rem; padding: 1rem; background: var(--admin-bg-secondary); border-radius: 8px;">
                            üí° Salve o produto para visualizar o preview do post Instagram.
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="admin-form-sidebar">
            <!-- Platform & Price -->
            <div class="admin-card">
                <div class="admin-form-group">
                    <label for="platform" class="admin-form-label">Plataforma *</label>
                    <select id="platform" name="platform" class="admin-form-select" required>
                        <option value="amazon" {% if not product or product.platform.value == 'amazon' %}selected{% endif %}>Amazon</option>
                        <option value="mercadolivre" {% if product and product.platform.value == 'mercadolivre' %}selected{% endif %}>Mercado Livre</option>
                        <option value="shopee" {% if product and product.platform.value == 'shopee' %}selected{% endif %}>Shopee</option>
                    </select>
                </div>

                <div class="admin-form-group">
                    <label for="platform_product_id" class="admin-form-label">ID do Produto na Plataforma</label>
                    <input
                        type="text"
                        id="platform_product_id"
                        name="platform_product_id"
                        class="admin-form-input"
                        value="{{ product.platform_product_id if product else '' }}"
                        placeholder="B08XYZ123"
                    >
                </div>

                <div class="admin-form-group">
                    <label for="price" class="admin-form-label">Preco (R$)</label>
                    <input
                        type="number"
                        id="price"
                        name="price"
                        class="admin-form-input"
                        value="{{ product.price if product else '' }}"
                        step="0.01"
                        min="0"
                    >
                </div>

                <div class="admin-form-group">
                    <label for="availability" class="admin-form-label">Disponibilidade</label>
                    <select id="availability" name="availability" class="admin-form-select">
                        <option value="available" {% if not product or product.availability.value == 'available' %}selected{% endif %}>Disponivel</option>
                        <option value="unavailable" {% if product and product.availability.value == 'unavailable' %}selected{% endif %}>Indisponivel</option>
                        <option value="unknown" {% if product and product.availability.value == 'unknown' %}selected{% endif %}>Desconhecido</option>
                    </select>
                </div>

                <div class="admin-form-actions">
                    <button type="submit" class="admin-btn admin-btn-primary admin-btn-block">
                        {{ 'Salvar' if product else 'Criar Produto' }}
                    </button>
                </div>
            </div>

            <!-- Images Gallery -->
            <div class="admin-card">
                <div class="admin-card-header">
                    <h3 class="admin-card-title">Imagens do Produto</h3>
                </div>

                <div class="image-gallery-section">
                    <!-- Galeria de imagens -->
                    <div class="image-gallery" id="image-gallery">
                        {% if product and product.images %}
                            {% for img_url in product.images %}
                            <div class="gallery-item" data-url="{{ img_url }}">
                                <img src="{{ img_url }}" alt="Imagem {{ loop.index }}">
                                <div class="gallery-item-actions">
                                    {% if loop.index0 == 0 %}
                                    <span class="gallery-item-main" title="Imagem principal">Principal</span>
                                    {% else %}
                                    <button type="button" class="gallery-action-btn" onclick="setAsMain(this)" title="Definir como principal">
                                        <span>&#9733;</span>
                                    </button>
                                    {% endif %}
                                    <button type="button" class="gallery-action-btn gallery-action-delete" onclick="removeImage(this)" title="Remover">
                                        <span>&times;</span>
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                        {% endif %}
                        <!-- Botao de adicionar -->
                        <div class="gallery-add" onclick="document.getElementById('image-file').click()">
                            <span class="gallery-add-icon">+</span>
                            <span class="gallery-add-text">Adicionar</span>
                        </div>
                    </div>

                    <!-- Input de arquivo oculto -->
                    <input
                        type="file"
                        id="image-file"
                        accept="image/jpeg,image/png,image/webp,image/gif"
                        multiple
                        style="display: none;"
                    >

                    <!-- Status de upload -->
                    <div class="upload-status-bar" id="upload-status-bar" style="display: none;">
                        <span id="upload-status-text">Enviando...</span>
                        <div class="upload-progress">
                            <div class="upload-progress-bar" id="upload-progress-bar"></div>
                        </div>
                    </div>

                    <!-- Hidden input para lista de imagens (JSON) -->
                    <input
                        type="hidden"
                        id="images"
                        name="images"
                        value="{{ product.images | tojson if product and product.images else '[]' }}"
                    >

                    <!-- URL manual opcional -->
                    <div class="admin-form-group" style="margin-top: 1rem;">
                        <label for="image_url_manual" class="admin-form-label">Ou cole uma URL externa</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <input
                                type="text"
                                id="image_url_manual"
                                class="admin-form-input"
                                placeholder="https://exemplo.com/imagem.jpg"
                                style="flex: 1;"
                            >
                            <button type="button" class="admin-btn admin-btn-secondary admin-btn-sm" onclick="addExternalUrl()">
                                Adicionar
                            </button>
                        </div>
                    </div>

                    <div class="admin-form-hint">Redimensionadas para 800x800 px (1:1). Formatos: JPG, PNG, WebP, GIF. Max: 10MB.</div>
                </div>
            </div>

            <!-- Rating -->
            <div class="admin-card">
                <div class="admin-form-group">
                    <label for="rating" class="admin-form-label">Avaliacao (0-5)</label>
                    <input
                        type="number"
                        id="rating"
                        name="rating"
                        class="admin-form-input"
                        value="{{ product.rating if product else '' }}"
                        step="0.1"
                        min="0"
                        max="5"
                    >
                </div>

                <div class="admin-form-group" style="margin-bottom: 0;">
                    <label for="review_count" class="admin-form-label">Numero de Reviews</label>
                    <input
                        type="number"
                        id="review_count"
                        name="review_count"
                        class="admin-form-input"
                        value="{{ product.review_count if product else '' }}"
                        min="0"
                    >
                </div>
            </div>

            <!-- Tags -->
            <div class="admin-card">
                <div class="admin-form-group" style="margin-bottom: 0;">
                    <label for="tags" class="admin-form-label">
                        Tags
                        <button type="button" class="admin-btn-icon-sm" onclick="generateProductTags()" title="Gerar com IA">ü§ñ</button>
                    </label>
                    <input
                        type="text"
                        id="tags"
                        name="tags"
                        class="admin-form-input"
                        value="{{ product.tags | join(', ') if product and product.tags else '' }}"
                        placeholder="tag1, tag2, tag3"
                    >
                    <div class="admin-form-hint">Separadas por virgula</div>
                </div>
            </div>

            <!-- Custos de IA -->
            {% if product %}
            <div class="admin-card" id="ai-costs-card" style="background: var(--admin-bg-tertiary);">
                <h4 style="margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
                    <span>üí∞</span> Custos de IA
                </h4>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; text-align: center; margin-bottom: 0.75rem;">
                    <div style="background: var(--admin-bg-secondary); padding: 0.5rem; border-radius: 4px;">
                        <div id="ai-prompt-tokens-display" style="font-size: 1rem; font-weight: bold; color: var(--admin-warning);">
                            {{ "{:,}".format(product.ai_prompt_tokens) }}
                        </div>
                        <div style="font-size: 0.65rem; color: var(--admin-text-muted);">Entrada</div>
                    </div>
                    <div style="background: var(--admin-bg-secondary); padding: 0.5rem; border-radius: 4px;">
                        <div id="ai-completion-tokens-display" style="font-size: 1rem; font-weight: bold; color: var(--admin-info);">
                            {{ "{:,}".format(product.ai_completion_tokens) }}
                        </div>
                        <div style="font-size: 0.65rem; color: var(--admin-text-muted);">Saida</div>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; text-align: center;">
                    <div>
                        <div id="ai-tokens-display" style="font-size: 1.1rem; font-weight: bold; color: var(--admin-primary);">
                            {{ "{:,}".format(product.ai_tokens_used) }}
                        </div>
                        <div style="font-size: 0.65rem; color: var(--admin-text-muted);">Total</div>
                    </div>
                    <div>
                        <div id="ai-cost-display" style="font-size: 1.1rem; font-weight: bold; color: var(--admin-success);">
                            ${{ "%.6f"|format(product.ai_cost_usd|float) }}
                        </div>
                        <div style="font-size: 0.65rem; color: var(--admin-text-muted);">Custo</div>
                    </div>
                    <div>
                        <div id="ai-generations-display" style="font-size: 1.1rem; font-weight: bold; color: var(--admin-text);">
                            {{ product.ai_generations_count }}
                        </div>
                        <div style="font-size: 0.65rem; color: var(--admin-text-muted);">Chamadas</div>
                    </div>
                </div>
            </div>
            {% else %}
            <!-- Novo produto - custos serao exibidos apos salvar -->
            <div class="admin-card" style="background: var(--admin-bg-tertiary); opacity: 0.6;">
                <h4 style="margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                    <span>üí∞</span> Custos de IA
                </h4>
                <p style="font-size: 0.8rem; color: var(--admin-text-muted); margin: 0;">
                    Salve o produto para acompanhar custos de IA
                </p>
            </div>
            {% endif %}

            <!-- Categorias -->
            <div class="admin-card">
                <div class="admin-card-header">
                    <h3 class="admin-card-title">Categorias</h3>
                </div>

                <div class="admin-form-group">
                    <label class="admin-form-label">Selecione as categorias</label>
                    <div class="category-selector" id="category-selector">
                        {% if categories %}
                        <div class="category-checkboxes">
                            {% for category in categories %}
                            <label class="admin-checkbox" data-slug="{{ category.slug }}">
                                <input
                                    type="checkbox"
                                    name="category_ids"
                                    value="{{ category.slug }}"
                                    {% if product and category.slug in product.categories %}checked{% endif %}
                                >
                                <span>{{ category.name }}</span>
                            </label>
                            {% endfor %}
                        </div>
                        {% else %}
                        <p class="admin-form-hint">Nenhuma categoria cadastrada.</p>
                        {% endif %}
                    </div>
                </div>

                <button type="button" class="admin-btn admin-btn-secondary admin-btn-sm" onclick="openCategoryModal()">
                    + Nova Categoria
                </button>

                <!-- Hidden input para categorias selecionadas (slugs) -->
                <input type="hidden" id="categories_json" name="categories_json" value="{{ product.categories | tojson if product and product.categories else '[]' }}">
            </div>
        </div>
    </div>
</form>

<!-- Modal Nova Categoria -->
<div class="admin-modal" id="category-modal" style="display: none;">
    <div class="admin-modal-backdrop" onclick="closeCategoryModal()"></div>
    <div class="admin-modal-content">
        <div class="admin-modal-header">
            <h3>Nova Categoria</h3>
            <button type="button" class="admin-modal-close" onclick="closeCategoryModal()">&times;</button>
        </div>
        <div class="admin-modal-body">
            <div class="admin-form-group">
                <label for="new_category_name" class="admin-form-label">Nome *</label>
                <input
                    type="text"
                    id="new_category_name"
                    class="admin-form-input"
                    placeholder="Ex: Gamer, Star Wars..."
                    required
                >
            </div>
            <div class="admin-form-group">
                <label for="new_category_slug" class="admin-form-label">Slug</label>
                <input
                    type="text"
                    id="new_category_slug"
                    class="admin-form-input"
                    placeholder="gerado-automaticamente"
                >
                <div class="admin-form-hint">Deixe vazio para gerar automaticamente</div>
            </div>
            <div class="admin-form-group">
                <label for="new_category_description" class="admin-form-label">Descricao</label>
                <textarea
                    id="new_category_description"
                    class="admin-form-textarea"
                    rows="2"
                    placeholder="Descricao breve da categoria"
                ></textarea>
            </div>

            <!-- Upload de imagem da categoria -->
            <div class="admin-form-group">
                <label class="admin-form-label">Imagem da Categoria</label>
                <div class="category-image-upload">
                    <div class="category-image-preview" id="category-image-preview">
                        <div class="image-placeholder">
                            <span>Sem imagem</span>
                        </div>
                    </div>
                    <div class="category-image-controls">
                        <input type="file" id="category-image-file" accept="image/jpeg,image/png,image/webp,image/gif" style="display: none;">
                        <button type="button" class="admin-btn admin-btn-secondary admin-btn-sm" onclick="document.getElementById('category-image-file').click()">
                            Upload
                        </button>
                        <span class="upload-status" id="category-upload-status"></span>
                    </div>
                    <input type="hidden" id="new_category_image_url" value="">
                    <div class="admin-form-hint">Redimensionada automaticamente para 400x400 px</div>
                </div>
            </div>
        </div>
        <div class="admin-modal-footer">
            <button type="button" class="admin-btn admin-btn-secondary" onclick="closeCategoryModal()">Cancelar</button>
            <button type="button" class="admin-btn admin-btn-primary" onclick="createCategory()">Criar Categoria</button>
        </div>
    </div>
</div>

<!-- Modal de Loading IA (bloqueia interacao) -->
<div id="ai-loading-modal" class="ai-loading-modal">
    <div class="ai-loading-backdrop"></div>
    <div class="ai-loading-content">
        <div class="ai-loading-spinner"></div>
        <div class="ai-loading-text">Gerando com IA...</div>
        <div class="ai-loading-subtext">Aguarde, isso pode levar alguns segundos</div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// =============================================================================
// Auto-geracao de Slugs
// =============================================================================

// Funcao para gerar slug a partir de texto
function generateSlug(text) {
    if (!text) return '';
    return text
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '') // Remove acentos
        .replace(/[^\w\s-]/g, '') // Remove caracteres especiais
        .replace(/\s+/g, '-') // Substitui espacos por hifens
        .replace(/-+/g, '-') // Remove hifens duplicados
        .trim();
}

// Elementos dos campos
const productNameInput = document.getElementById('name');
const productSlugInput = document.getElementById('slug');
const affiliateRedirectSlugInput = document.getElementById('affiliate_redirect_slug');
const platformSelect = document.getElementById('platform');

// Flags para detectar edicao manual
let slugManuallyEdited = {{ 'true' if product else 'false' }};
let redirectSlugManuallyEdited = {{ 'true' if product else 'false' }};

// Auto-gerar slug quando o nome muda (se nao foi editado manualmente)
if (productNameInput && productSlugInput) {
    productNameInput.addEventListener('input', function() {
        const slug = generateSlug(this.value);

        // Atualiza slug do produto se nao foi editado manualmente
        if (!slugManuallyEdited) {
            productSlugInput.value = slug;
        }

        // Atualiza slug de redirecionamento se nao foi editado manualmente
        if (!redirectSlugManuallyEdited && affiliateRedirectSlugInput) {
            const platform = platformSelect ? platformSelect.value : 'amazon';
            affiliateRedirectSlugInput.value = slug ? `${slug}-${platform}` : '';
        }
    });
}

// Atualiza slug de redirecionamento quando plataforma muda
if (platformSelect && affiliateRedirectSlugInput) {
    platformSelect.addEventListener('change', function() {
        if (!redirectSlugManuallyEdited && productNameInput) {
            const slug = generateSlug(productNameInput.value);
            if (slug) {
                affiliateRedirectSlugInput.value = `${slug}-${this.value}`;
            }
        }
    });
}

// Marcar slug como editado manualmente quando o usuario digitar
if (productSlugInput) {
    productSlugInput.addEventListener('input', function() {
        if (this.value.trim() !== '') {
            slugManuallyEdited = true;
        } else {
            slugManuallyEdited = false;
        }
    });
}

// Marcar slug de redirecionamento como editado manualmente
if (affiliateRedirectSlugInput) {
    affiliateRedirectSlugInput.addEventListener('input', function() {
        if (this.value.trim() !== '') {
            redirectSlugManuallyEdited = true;
        } else {
            redirectSlugManuallyEdited = false;
        }
    });
}

// =============================================================================
// Image Gallery Handler - Multiplas Imagens
// =============================================================================

const imageFileInput = document.getElementById('image-file');
const imageGallery = document.getElementById('image-gallery');
const imagesInput = document.getElementById('images');
const uploadStatusBar = document.getElementById('upload-status-bar');
const uploadStatusText = document.getElementById('upload-status-text');
const uploadProgressBar = document.getElementById('upload-progress-bar');
const imageUrlManualInput = document.getElementById('image_url_manual');

// Lista de imagens atual - trata string vazia como array vazio
let images = [];
try {
    const imagesValue = imagesInput.value.trim();
    images = imagesValue ? JSON.parse(imagesValue) : [];
} catch (e) {
    console.warn('Erro ao parsear imagens:', e);
    images = [];
}

// Upload de multiplos arquivos
imageFileInput.addEventListener('change', async function(e) {
    const files = Array.from(e.target.files);
    if (!files.length) return;

    const allowedTypes = ['image/jpeg', 'image/png', 'image/webp', 'image/gif'];
    const maxSize = 10 * 1024 * 1024; // 10MB (sera comprimido no servidor)

    // Filtra arquivos validos
    const validFiles = files.filter(file => {
        if (!allowedTypes.includes(file.type)) {
            console.warn(`Tipo nao permitido: ${file.name}`);
            return false;
        }
        if (file.size > maxSize) {
            console.warn(`Arquivo muito grande: ${file.name}`);
            return false;
        }
        return true;
    });

    if (!validFiles.length) {
        alert('Nenhum arquivo valido selecionado. Formatos: JPG, PNG, WebP, GIF. Max: 10MB');
        return;
    }

    // Mostra barra de progresso
    uploadStatusBar.style.display = 'block';
    uploadProgressBar.style.width = '0%';

    let uploaded = 0;
    const total = validFiles.length;

    for (const file of validFiles) {
        uploadStatusText.textContent = `Enviando ${uploaded + 1}/${total}...`;

        const formData = new FormData();
        formData.append('file', file);

        try {
            const response = await fetch('/admin/upload/image', {
                method: 'POST',
                body: formData,
            });

            const data = await response.json();

            if (response.ok) {
                addImageToGallery(data.url);
                uploaded++;
                uploadProgressBar.style.width = `${(uploaded / total) * 100}%`;
            } else {
                console.error(`Erro ao enviar ${file.name}:`, data.detail);
            }
        } catch (error) {
            console.error(`Erro de conexao ao enviar ${file.name}:`, error);
        }
    }

    // Finaliza
    uploadStatusText.textContent = `${uploaded}/${total} enviado(s)!`;
    uploadProgressBar.style.width = '100%';

    setTimeout(() => {
        uploadStatusBar.style.display = 'none';
    }, 2000);

    // Limpa input
    imageFileInput.value = '';
});

// Adiciona imagem a galeria
function addImageToGallery(url) {
    images.push(url);
    updateImagesInput();
    renderGallery();
}

// Adiciona URL externa
function addExternalUrl() {
    const url = imageUrlManualInput.value.trim();
    if (!url) return;

    if (!url.startsWith('http://') && !url.startsWith('https://')) {
        alert('URL deve comecar com http:// ou https://');
        return;
    }

    addImageToGallery(url);
    imageUrlManualInput.value = '';
}

// Remove imagem da galeria
function removeImage(btn) {
    const item = btn.closest('.gallery-item');
    const url = item.dataset.url;

    images = images.filter(img => img !== url);
    updateImagesInput();
    renderGallery();
}

// Define imagem como principal (move para primeira posicao)
function setAsMain(btn) {
    const item = btn.closest('.gallery-item');
    const url = item.dataset.url;

    // Remove da posicao atual e adiciona no inicio
    images = images.filter(img => img !== url);
    images.unshift(url);

    updateImagesInput();
    renderGallery();
}

// Atualiza input hidden com lista de imagens
function updateImagesInput() {
    imagesInput.value = JSON.stringify(images);
}

// Renderiza galeria completa
function renderGallery() {
    // Remove itens existentes (exceto botao de adicionar)
    const existingItems = imageGallery.querySelectorAll('.gallery-item');
    existingItems.forEach(item => item.remove());

    // Adiciona cada imagem
    const addButton = imageGallery.querySelector('.gallery-add');

    images.forEach((url, index) => {
        const item = document.createElement('div');
        item.className = 'gallery-item';
        item.dataset.url = url;

        const isMain = index === 0;
        const mainBadge = isMain
            ? '<span class="gallery-item-main" title="Imagem principal">Principal</span>'
            : `<button type="button" class="gallery-action-btn" onclick="setAsMain(this)" title="Definir como principal"><span>&#9733;</span></button>`;

        item.innerHTML = `
            <img src="${url}" alt="Imagem ${index + 1}">
            <div class="gallery-item-actions">
                ${mainBadge}
                <button type="button" class="gallery-action-btn gallery-action-delete" onclick="removeImage(this)" title="Remover">
                    <span>&times;</span>
                </button>
            </div>
        `;

        imageGallery.insertBefore(item, addButton);
    });
}

// =============================================================================
// Modal de Categoria
// =============================================================================

// Elementos do modal - usando var para evitar TDZ (Temporal Dead Zone)
var categoryModal = document.getElementById('category-modal');
var categoryImageFile = document.getElementById('category-image-file');
var categoryImagePreview = document.getElementById('category-image-preview');
var categoryUploadStatus = document.getElementById('category-upload-status');
var categoryImageUrlInput = document.getElementById('new_category_image_url');
var categoryNameInput = document.getElementById('new_category_name');
var categorySlugInput = document.getElementById('new_category_slug');
var categorySlugManuallyEdited = false;

// Auto-gerar slug da categoria quando o nome muda (se nao foi editado manualmente)
// Nota: generateSlug() ja esta definida no inicio do script
if (categoryNameInput) {
    categoryNameInput.addEventListener('input', function() {
        if (!categorySlugManuallyEdited && categorySlugInput) {
            categorySlugInput.value = generateSlug(this.value);
        }
    });
}

// Marcar slug como editado manualmente quando o usuario digitar
if (categorySlugInput) {
    categorySlugInput.addEventListener('input', function() {
        if (this.value.trim() !== '') {
            categorySlugManuallyEdited = true;
        }
    });
}

function openCategoryModal() {
    if (categoryModal) {
        categoryModal.style.display = 'flex';
        document.getElementById('new_category_name').focus();
    }
}

function closeCategoryModal() {
    if (!categoryModal) return;
    categoryModal.style.display = 'none';
    // Limpa campos
    document.getElementById('new_category_name').value = '';
    document.getElementById('new_category_slug').value = '';
    document.getElementById('new_category_description').value = '';
    if (categoryImageUrlInput) categoryImageUrlInput.value = '';
    if (categoryImagePreview) categoryImagePreview.innerHTML = '<div class="image-placeholder"><span>Sem imagem</span></div>';
    if (categoryUploadStatus) categoryUploadStatus.textContent = '';
    // Reseta flag de edicao manual do slug
    categorySlugManuallyEdited = false;
}

// Upload de imagem da categoria (redimensiona automaticamente para 400x400)
if (categoryImageFile) {
categoryImageFile.addEventListener('change', async function(e) {
    const file = e.target.files[0];
    if (!file) return;

    const allowedTypes = ['image/jpeg', 'image/png', 'image/webp', 'image/gif'];
    if (!allowedTypes.includes(file.type)) {
        categoryUploadStatus.textContent = 'Tipo nao permitido';
        categoryUploadStatus.style.color = 'var(--admin-danger)';
        return;
    }

    if (file.size > 10 * 1024 * 1024) {
        categoryUploadStatus.textContent = 'Max 10MB';
        categoryUploadStatus.style.color = 'var(--admin-danger)';
        return;
    }

    categoryUploadStatus.textContent = 'Enviando...';
    categoryUploadStatus.style.color = 'var(--admin-text-muted)';

    const formData = new FormData();
    formData.append('file', file);

    try {
        // Usa endpoint especifico para categorias (redimensiona para 400x400)
        const response = await fetch('/admin/upload/category-image', {
            method: 'POST',
            body: formData,
        });

        const data = await response.json();

        if (response.ok) {
            categoryImageUrlInput.value = data.url;
            categoryImagePreview.innerHTML = `<img src="${data.url}" alt="Preview">`;
            categoryUploadStatus.textContent = '400x400 OK!';
            categoryUploadStatus.style.color = 'var(--admin-success)';
        } else {
            categoryUploadStatus.textContent = data.detail || 'Erro';
            categoryUploadStatus.style.color = 'var(--admin-danger)';
        }
    } catch (error) {
        categoryUploadStatus.textContent = 'Erro de conexao';
        categoryUploadStatus.style.color = 'var(--admin-danger)';
    }

    categoryImageFile.value = '';
});
} // fecha if (categoryImageFile)

// Criar categoria via AJAX
async function createCategory() {
    const name = document.getElementById('new_category_name').value.trim();
    const slug = document.getElementById('new_category_slug').value.trim();
    const description = document.getElementById('new_category_description').value.trim();
    const imageUrl = categoryImageUrlInput.value;

    if (!name) {
        alert('Nome da categoria e obrigatorio');
        return;
    }

    try {
        const response = await fetch('/admin/api/categories', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                name: name,
                slug: slug || null,
                description: description || null,
                image_url: imageUrl || null,
            }),
        });

        const data = await response.json();

        if (response.ok) {
            // Adiciona checkbox da nova categoria
            addCategoryToList(data);
            closeCategoryModal();
        } else {
            alert(data.detail || 'Erro ao criar categoria');
        }
    } catch (error) {
        alert('Erro de conexao ao criar categoria');
        console.error(error);
    }
}

// Adiciona nova categoria a lista de checkboxes
function addCategoryToList(category) {
    const selector = document.getElementById('category-selector');
    let checkboxes = selector.querySelector('.category-checkboxes');

    // Se nao existe container de checkboxes, cria
    if (!checkboxes) {
        selector.innerHTML = '<div class="category-checkboxes"></div>';
        checkboxes = selector.querySelector('.category-checkboxes');
    }

    // Cria novo checkbox com data-slug
    const label = document.createElement('label');
    label.className = 'admin-checkbox';
    label.dataset.slug = category.slug;
    label.innerHTML = `
        <input type="checkbox" name="category_ids" value="${category.slug}" checked>
        <span>${category.name}</span>
    `;

    checkboxes.appendChild(label);
}

// Atualiza hidden input com categorias selecionadas antes do submit
document.querySelector('form.admin-form').addEventListener('submit', function(e) {
    const checkboxes = document.querySelectorAll('input[name="category_ids"]:checked');
    const categories = Array.from(checkboxes).map(cb => cb.value);

    document.getElementById('categories_json').value = JSON.stringify(categories);
});

// =============================================================================
// Geracao de Descricao com IA
// =============================================================================

// Atualiza contador de caracteres da descricao curta
const shortDescInput = document.getElementById('short_description');
if (shortDescInput) {
    shortDescInput.addEventListener('input', function() {
        const countSpan = document.getElementById('short_description_count');
        if (countSpan) {
            countSpan.textContent = this.value.length;
        }
    });
}

// =============================================================================
// Instagram Preview
// =============================================================================

{% if product %}
function refreshInstagramPreview() {
    const iframe = document.getElementById('instagram-preview-frame');
    const loading = document.getElementById('instagram-preview-loading');

    // Pega valores atuais dos campos
    const headline = document.getElementById('instagram_headline').value;
    const title = document.getElementById('instagram_title').value;
    const badge = document.getElementById('instagram_badge').value;

    // Monta URL com query params para override (usa endpoint admin)
    let url = `/admin/products/${productId}/instagram-preview`;
    const params = new URLSearchParams();

    if (headline) params.append('headline', headline);
    if (title) params.append('title', title);
    if (badge) params.append('badge', badge);

    const queryString = params.toString();
    if (queryString) {
        url += '?' + queryString;
    }

    // Mostra loading
    loading.style.display = 'block';
    iframe.style.opacity = '0.3';

    // Atualiza iframe
    iframe.src = url;

    // Esconde loading quando carregar
    iframe.onload = function() {
        loading.style.display = 'none';
        iframe.style.opacity = '1';
    };
}

function openPreviewFullscreen() {
    const headline = document.getElementById('instagram_headline').value;
    const title = document.getElementById('instagram_title').value;
    const badge = document.getElementById('instagram_badge').value;

    let url = `/admin/products/${productId}/instagram-preview`;
    const params = new URLSearchParams();

    if (headline) params.append('headline', headline);
    if (title) params.append('title', title);
    if (badge) params.append('badge', badge);

    const queryString = params.toString();
    if (queryString) {
        url += '?' + queryString;
    }

    window.open(url, '_blank', 'width=1100,height=1100');
}

// Atualiza preview quando campos Instagram mudam (com debounce)
let previewTimeout;
function schedulePreviewUpdate() {
    clearTimeout(previewTimeout);
    previewTimeout = setTimeout(refreshInstagramPreview, 1000);
}

// Adiciona listeners aos campos Instagram
['instagram_headline', 'instagram_title', 'instagram_badge'].forEach(id => {
    const input = document.getElementById(id);
    if (input) {
        input.addEventListener('input', schedulePreviewUpdate);
    }
});

// Contadores de caracteres para Headline e Badge
const headlineInput = document.getElementById('instagram_headline');
const badgeInput = document.getElementById('instagram_badge');

if (headlineInput) {
    headlineInput.addEventListener('input', function() {
        const countSpan = document.getElementById('instagram_headline_count');
        if (countSpan) {
            countSpan.textContent = this.value.length;
        }
    });
}

if (badgeInput) {
    badgeInput.addEventListener('input', function() {
        const countSpan = document.getElementById('instagram_badge_count');
        if (countSpan) {
            countSpan.textContent = this.value.length;
        }
    });
}

/**
 * Baixa a imagem do Instagram convertendo o HTML para imagem via API
 * Usa o endpoint admin que ja tem autenticacao por sessao
 */
async function downloadInstagramImage() {
    const btn = document.getElementById('btn-download-image');
    const statusDiv = document.getElementById('download-status');

    // Desabilita botao durante o processo
    btn.disabled = true;
    btn.textContent = '‚è≥ Gerando...';

    // Mostra status
    statusDiv.style.display = 'block';
    statusDiv.style.background = 'var(--admin-bg-secondary)';
    statusDiv.style.color = 'var(--admin-text-muted)';
    statusDiv.textContent = 'Gerando imagem (pode demorar alguns segundos)...';

    try {
        // Pega valores atuais dos campos
        const headline = document.getElementById('instagram_headline').value;
        const title = document.getElementById('instagram_title').value;
        const badge = document.getElementById('instagram_badge').value;

        // Usa o endpoint admin que gera a imagem diretamente
        const response = await fetch(`/admin/products/${productId}/instagram-image`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                headline: headline,
                title: title,
                badge: badge
            })
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.detail || 'Erro ao gerar imagem');
        }

        const data = await response.json();

        // Converte base64 para blob e faz download
        statusDiv.textContent = 'Preparando download...';
        const byteCharacters = atob(data.image_base64);
        const byteNumbers = new Array(byteCharacters.length);
        for (let i = 0; i < byteCharacters.length; i++) {
            byteNumbers[i] = byteCharacters.charCodeAt(i);
        }
        const byteArray = new Uint8Array(byteNumbers);
        const blob = new Blob([byteArray], { type: 'image/png' });

        // Cria link de download
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = `instagram-post-${productId}.png`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);

        // Sucesso
        statusDiv.style.background = 'var(--admin-success-bg, #d4edda)';
        statusDiv.style.color = 'var(--admin-success, #155724)';
        statusDiv.textContent = `‚úÖ Download concluido! (${data.file_size_kb} KB)`;

        setTimeout(() => {
            statusDiv.style.display = 'none';
        }, 3000);

    } catch (error) {
        console.error('Erro ao gerar imagem:', error);
        statusDiv.style.background = 'var(--admin-danger-bg, #f8d7da)';
        statusDiv.style.color = 'var(--admin-danger, #721c24)';
        statusDiv.textContent = `‚ùå Erro: ${error.message}`;
    } finally {
        btn.disabled = false;
        btn.textContent = 'üì• Download Imagem';
    }
}
{% endif %}

// =============================================================================
// Geracao de Descricao com IA
// =============================================================================

async function generateProductDescription(type) {
    const name = document.getElementById('name').value.trim();
    if (!name) {
        alert('Preencha o nome do produto antes de gerar a descricao');
        return;
    }

    const loadingDiv = document.getElementById('description-loading');
    const shortDesc = document.getElementById('short_description');
    const longDesc = document.getElementById('long_description');

    loadingDiv.style.display = 'block';

    // Coleta informacoes do produto
    const price = document.getElementById('price')?.value || '';
    const platform = document.getElementById('platform')?.value || '';

    try {
        const response = await fetch('/admin/api/ai/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                use_case: 'product_description',
                product_name: name,
                content: `Produto: ${name}\nPreco: ${price || 'Nao informado'}\nPlataforma: ${platform || 'Nao informada'}`
            })
        });

        const data = await response.json();

        if (response.ok) {
            const generated = data.generated_content;

            if (type === 'short') {
                // Extrai primeira frase ou primeiros 150 caracteres
                let shortText = generated.split('\n')[0];
                if (shortText.length > 150) {
                    shortText = shortText.substring(0, 147) + '...';
                }
                shortDesc.value = shortText;
                document.getElementById('short_description_count').textContent = shortText.length;
            } else {
                longDesc.value = generated;
            }
        } else {
            alert('Erro ao gerar: ' + (data.detail || 'Erro desconhecido'));
        }
    } catch (error) {
        alert('Erro de conexao: ' + error.message);
    } finally {
        loadingDiv.style.display = 'none';
    }
}

// =============================================================================
// Geracao com IA - Funcoes Auxiliares
// =============================================================================

{% if product %}
const productId = '{{ product.id }}';

// Variaveis locais para tracking de custos (atualizadas em tempo real)
let localTokensUsed = {{ product.ai_tokens_used }};
let localPromptTokens = {{ product.ai_prompt_tokens }};
let localCompletionTokens = {{ product.ai_completion_tokens }};
let localCostUsd = {{ product.ai_cost_usd|float }};
let localGenerationsCount = {{ product.ai_generations_count }};
{% else %}
const productId = null;
let localTokensUsed = 0;
let localPromptTokens = 0;
let localCompletionTokens = 0;
let localCostUsd = 0;
let localGenerationsCount = 0;
{% endif %}

// Controle do modal de loading global
const aiLoadingModal = document.getElementById('ai-loading-modal');

function showAILoading(text = 'Gerando com IA...') {
    if (!aiLoadingModal) return;
    const textEl = aiLoadingModal.querySelector('.ai-loading-text');
    if (textEl) textEl.textContent = text;
    aiLoadingModal.classList.add('active');
    document.body.style.overflow = 'hidden';
}

function hideAILoading() {
    if (!aiLoadingModal) return;
    aiLoadingModal.classList.remove('active');
    document.body.style.overflow = '';
}

// Atualiza exibicao de custos na pagina em tempo real
function updateCostDisplay(tokensUsed, promptTokens, completionTokens, costUsd) {
    localTokensUsed += tokensUsed || 0;
    localPromptTokens += promptTokens || 0;
    localCompletionTokens += completionTokens || 0;
    localCostUsd += costUsd || 0;
    localGenerationsCount += 1;

    const tokensDisplay = document.getElementById('ai-tokens-display');
    const promptDisplay = document.getElementById('ai-prompt-tokens-display');
    const completionDisplay = document.getElementById('ai-completion-tokens-display');
    const costDisplay = document.getElementById('ai-cost-display');
    const genDisplay = document.getElementById('ai-generations-display');

    if (tokensDisplay) {
        tokensDisplay.textContent = localTokensUsed.toLocaleString('pt-BR');
    }
    if (promptDisplay) {
        promptDisplay.textContent = localPromptTokens.toLocaleString('pt-BR');
    }
    if (completionDisplay) {
        completionDisplay.textContent = localCompletionTokens.toLocaleString('pt-BR');
    }
    if (costDisplay) {
        costDisplay.textContent = '$' + localCostUsd.toFixed(6);
    }
    if (genDisplay) {
        genDisplay.textContent = localGenerationsCount;
    }
}

// Atualiza custo no banco de dados
async function updateProductAICost(tokensUsed, promptTokens, completionTokens, costUsd) {
    if (!productId) return;

    try {
        await fetch(`/admin/api/products/${productId}/ai-cost`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                tokens_used: tokensUsed,
                prompt_tokens: promptTokens,
                completion_tokens: completionTokens,
                cost_usd: costUsd
            })
        });
    } catch (error) {
        console.error('Erro ao atualizar custo de IA:', error);
    }
}

// =============================================================================
// Geracao de Tags com IA
// =============================================================================

async function generateProductTags() {
    const name = document.getElementById('name').value.trim();
    if (!name) {
        alert('Preencha o nome do produto antes de gerar tags');
        return;
    }

    const tagsInput = document.getElementById('tags');
    const shortDesc = document.getElementById('short_description').value.trim();
    const longDesc = document.getElementById('long_description').value.trim();
    const platform = document.getElementById('platform')?.value || '';

    showAILoading('Gerando tags...');

    try {
        const response = await fetch('/admin/api/ai/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                use_case: 'product_tags',
                product_name: name,
                content: shortDesc || longDesc || name,
                platform: platform,
                entity_type: 'product',
                entity_id: productId
            })
        });

        const data = await response.json();

        if (response.ok) {
            // Limpa e formata as tags
            let rawContent = data.generated_content || '';
            let tags = rawContent
                .replace(/^(tags?|sugestoes?|palavras?-?chave)[:.\s-]*/i, '')
                .split(/[,\n]/)
                .map(t => t.trim().toLowerCase().replace(/^[-‚Ä¢*\d.)\s]+/, ''))
                .filter(t => t && !t.startsWith('#') && t.length > 1)
                .slice(0, 5)
                .join(', ');

            if (!tags && rawContent.trim()) {
                tags = rawContent.trim().toLowerCase();
            }

            tagsInput.value = tags;
            updateCostDisplay(data.tokens_used || 0, data.prompt_tokens || 0, data.completion_tokens || 0, data.cost_usd || 0);
            await updateProductAICost(data.tokens_used || 0, data.prompt_tokens || 0, data.completion_tokens || 0, data.cost_usd || 0);
        } else {
            alert('Erro ao gerar tags: ' + (data.detail || 'Erro desconhecido'));
        }
    } catch (error) {
        alert('Erro de conexao: ' + error.message);
    } finally {
        hideAILoading();
    }
}

// =============================================================================
// Geracao de Campos Instagram com IA
// =============================================================================

// Mapeamento de campos para use_cases
const instagramFieldToUseCase = {
    'headline': 'product_instagram_headline',
    'badge': 'product_instagram_badge',
    'title': 'product_instagram_title',
    'hashtags': 'product_instagram_hashtags',
    'caption': 'product_instagram_caption'
};

async function generateInstagramField(field) {
    const name = document.getElementById('name').value.trim();
    if (!name) {
        alert('Preencha o nome do produto antes de gerar conteudo');
        return;
    }

    const useCase = instagramFieldToUseCase[field];
    if (!useCase) {
        console.error('Campo desconhecido:', field);
        return;
    }

    const targetInput = document.getElementById(`instagram_${field}`);
    const price = document.getElementById('price')?.value || '';
    const platform = document.getElementById('platform')?.value || '';
    const shortDesc = document.getElementById('short_description').value.trim();
    const longDesc = document.getElementById('long_description').value.trim();

    const fieldLabels = {
        'headline': 'Gerando headline...',
        'badge': 'Gerando badge...',
        'title': 'Gerando titulo...',
        'hashtags': 'Gerando hashtags...',
        'caption': 'Gerando caption...'
    };

    showAILoading(fieldLabels[field] || 'Gerando com IA...');

    try {
        const response = await fetch('/admin/api/ai/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                use_case: useCase,
                product_name: name,
                content: shortDesc || longDesc || name,
                price: price,
                platform: platform,
                entity_type: 'product',
                entity_id: productId
            })
        });

        const data = await response.json();

        if (response.ok) {
            let generatedContent = data.generated_content || '';

            // Processamento especifico por campo
            if (field === 'hashtags') {
                // Remove # e formata como lista
                generatedContent = generatedContent
                    .replace(/#/g, '')
                    .split(/[,\n]/)
                    .map(h => h.trim().toLowerCase())
                    .filter(h => h && h.length > 1)
                    .slice(0, 15)
                    .join(', ');
            }

            targetInput.value = generatedContent;

            // Atualiza contador de caracteres se existir
            const countSpan = document.getElementById(`instagram_${field}_count`);
            if (countSpan) {
                countSpan.textContent = generatedContent.length;
            }

            updateCostDisplay(data.tokens_used || 0, data.prompt_tokens || 0, data.completion_tokens || 0, data.cost_usd || 0);
            await updateProductAICost(data.tokens_used || 0, data.prompt_tokens || 0, data.completion_tokens || 0, data.cost_usd || 0);

            // Atualiza preview se campo afetar
            if (['headline', 'title', 'badge'].includes(field)) {
                schedulePreviewUpdate();
            }
        } else {
            alert('Erro ao gerar: ' + (data.detail || 'Erro desconhecido'));
        }
    } catch (error) {
        alert('Erro de conexao: ' + error.message);
    } finally {
        hideAILoading();
    }
}

// Gera todos os campos Instagram de uma vez
async function generateAllInstagram() {
    const name = document.getElementById('name').value.trim();
    if (!name) {
        alert('Preencha o nome do produto antes de gerar conteudo');
        return;
    }

    const price = document.getElementById('price')?.value || '';
    const platform = document.getElementById('platform')?.value || '';
    const shortDesc = document.getElementById('short_description').value.trim();
    const longDesc = document.getElementById('long_description').value.trim();

    showAILoading('Gerando todos os campos Instagram...');

    try {
        const response = await fetch('/admin/api/ai/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                use_case: 'product_instagram_all',
                product_name: name,
                content: shortDesc || longDesc || name,
                price: price,
                platform: platform,
                entity_type: 'product',
                entity_id: productId
            })
        });

        const data = await response.json();

        if (response.ok) {
            try {
                // Tenta parsear como JSON
                const parsed = JSON.parse(data.generated_content);

                // Preenche os campos
                if (parsed.headline) {
                    document.getElementById('instagram_headline').value = parsed.headline;
                    const countHeadline = document.getElementById('instagram_headline_count');
                    if (countHeadline) countHeadline.textContent = parsed.headline.length;
                }
                if (parsed.badge) {
                    document.getElementById('instagram_badge').value = parsed.badge;
                    const countBadge = document.getElementById('instagram_badge_count');
                    if (countBadge) countBadge.textContent = parsed.badge.length;
                }
                if (parsed.title) {
                    document.getElementById('instagram_title').value = parsed.title;
                }
                if (parsed.hashtags) {
                    // Remove # e formata
                    const hashtags = parsed.hashtags
                        .replace(/#/g, '')
                        .split(/[,\n]/)
                        .map(h => h.trim().toLowerCase())
                        .filter(h => h && h.length > 1)
                        .slice(0, 15)
                        .join(', ');
                    document.getElementById('instagram_hashtags').value = hashtags;
                }
                if (parsed.caption) {
                    document.getElementById('instagram_caption').value = parsed.caption;
                }

                updateCostDisplay(data.tokens_used || 0, data.prompt_tokens || 0, data.completion_tokens || 0, data.cost_usd || 0);
                await updateProductAICost(data.tokens_used || 0, data.prompt_tokens || 0, data.completion_tokens || 0, data.cost_usd || 0);

                // Atualiza preview
                schedulePreviewUpdate();

            } catch (parseError) {
                // Se nao for JSON valido, gera campos individualmente em paralelo
                console.warn('Resposta nao e JSON valido, gerando campos individualmente');
                hideAILoading();

                // Gera campos em paralelo
                await Promise.all([
                    generateInstagramField('headline'),
                    generateInstagramField('badge'),
                    generateInstagramField('title'),
                    generateInstagramField('hashtags'),
                    generateInstagramField('caption')
                ]);
            }
        } else {
            alert('Erro ao gerar: ' + (data.detail || 'Erro desconhecido'));
        }
    } catch (error) {
        alert('Erro de conexao: ' + error.message);
    } finally {
        hideAILoading();
    }
}

// =============================================================================
// Redes Sociais - Paineis Colapsiveis
// =============================================================================

// Estado dos paineis abertos
let activeSocialPanel = null;

/**
 * Abre/fecha o painel de configuracao de uma rede social
 * @param {string} network - Nome da rede (instagram, tiktok, etc.)
 */
function toggleSocialPanel(network) {
    const panelId = `${network}-panel`;
    const panel = document.getElementById(panelId);
    const btn = document.querySelector(`.social-network-btn[onclick*="${network}"]`);

    if (!panel) {
        console.warn(`Painel ${panelId} nao encontrado`);
        return;
    }

    // Se o painel ja esta aberto, fecha
    if (panel.style.display !== 'none') {
        panel.style.display = 'none';
        if (btn) btn.classList.remove('active');
        activeSocialPanel = null;
        return;
    }

    // Fecha painel anterior se houver
    if (activeSocialPanel && activeSocialPanel !== panelId) {
        const prevPanel = document.getElementById(activeSocialPanel);
        const prevBtn = document.querySelector(`.social-network-btn[onclick*="${activeSocialPanel.replace('-panel', '')}"]`);
        if (prevPanel) prevPanel.style.display = 'none';
        if (prevBtn) prevBtn.classList.remove('active');
    }

    // Abre o novo painel
    panel.style.display = 'block';
    if (btn) btn.classList.add('active');
    activeSocialPanel = panelId;

    // Scroll suave ate o painel
    setTimeout(() => {
        panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }, 100);
}

// =============================================================================
// Hist√≥rico de Publica√ß√µes Instagram
// =============================================================================

{% if product %}
/**
 * Carrega e exibe o hist√≥rico de publica√ß√µes Instagram em um modal.
 * Faz requisi√ß√£o √† API interna do admin para buscar o hist√≥rico.
 */
async function loadInstagramHistory() {
    const modal = document.getElementById('instagram-history-modal');
    const content = document.getElementById('instagram-history-content');

    // Exibe modal com loading
    modal.style.display = 'flex';
    content.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--admin-text-muted);">Carregando hist√≥rico...</div>';

    try {
        // Busca hist√≥rico via API interna do admin
        const response = await fetch(`/admin/products/{{ product.id }}/instagram-history`);
        const data = await response.json();

        if (!response.ok) {
            throw new Error(data.detail || 'Erro ao carregar hist√≥rico');
        }

        if (data.items.length === 0) {
            content.innerHTML = `
                <div style="text-align: center; padding: 2rem; color: var(--admin-text-muted);">
                    Nenhuma publica√ß√£o registrada.
                </div>
            `;
            return;
        }

        // Renderiza lista de publica√ß√µes
        let html = '<div class="instagram-history-list" style="display: flex; flex-direction: column; gap: 1rem;">';

        for (const item of data.items) {
            const postedAt = new Date(item.posted_at);
            const formattedDate = postedAt.toLocaleDateString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            html += `
                <div class="history-item" style="background: var(--admin-bg-secondary); padding: 1rem; border-radius: 8px; border-left: 3px solid var(--admin-primary);">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                        <div style="font-weight: 600; color: var(--admin-text);">üìÖ ${formattedDate}</div>
                        ${item.post_url ? `<a href="${item.post_url}" target="_blank" rel="noopener" style="color: var(--admin-primary); font-size: 0.85rem;">üîó Ver post</a>` : ''}
                    </div>
                    ${item.ig_media_id ? `
                        <div style="font-size: 0.8rem; color: var(--admin-text-muted); margin-bottom: 0.25rem;">
                            <strong>IG Media ID:</strong>
                            <code style="background: var(--admin-bg); padding: 0.1rem 0.3rem; border-radius: 3px; font-size: 0.75rem;">${item.ig_media_id}</code>
                        </div>
                    ` : ''}
                    ${item.caption ? `
                        <div style="font-size: 0.85rem; color: var(--admin-text-muted); margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid var(--admin-border);">
                            <strong>Caption:</strong>
                            <p style="margin: 0.25rem 0 0 0; white-space: pre-wrap; max-height: 100px; overflow-y: auto;">${item.caption.substring(0, 200)}${item.caption.length > 200 ? '...' : ''}</p>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        html += '</div>';
        html += `<div style="text-align: center; margin-top: 1rem; font-size: 0.85rem; color: var(--admin-text-muted);">Total: ${data.total} publica√ß√£o(√µes)</div>`;

        content.innerHTML = html;

    } catch (error) {
        console.error('Erro ao carregar hist√≥rico:', error);
        content.innerHTML = `
            <div style="text-align: center; padding: 2rem; color: var(--admin-danger);">
                Erro ao carregar hist√≥rico: ${error.message}
            </div>
        `;
    }
}

/**
 * Fecha o modal de hist√≥rico de publica√ß√µes.
 */
function closeInstagramHistoryModal() {
    const modal = document.getElementById('instagram-history-modal');
    if (modal) {
        modal.style.display = 'none';
    }
}
{% endif %}
</script>
{% endblock %}
