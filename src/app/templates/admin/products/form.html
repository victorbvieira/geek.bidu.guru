{% extends "admin/base.html" %}

{% block title %}{{ 'Editar' if product else 'Novo' }} Produto{% endblock %}

{% block breadcrumb %}
<span>/</span>
<a href="/admin/products">Produtos</a>
<span>/</span>
<span class="current">{{ 'Editar' if product else 'Novo' }}</span>
{% endblock %}

{% block content %}
<div class="admin-page-header">
    <h1 class="admin-page-title">{{ 'Editar Produto' if product else 'Novo Produto' }}</h1>
</div>

<form method="POST" action="{{ '/admin/products/' ~ product.id if product else '/admin/products' }}" class="admin-form">
    <div class="admin-form-grid">
        <!-- Main Content -->
        <div class="admin-form-main">
            <div class="admin-card">
                <div class="admin-form-group">
                    <label for="name" class="admin-form-label">Nome do Produto *</label>
                    <input
                        type="text"
                        id="name"
                        name="name"
                        class="admin-form-input"
                        value="{{ product.name if product else '' }}"
                        required
                    >
                </div>

                <div class="admin-form-group">
                    <label for="slug" class="admin-form-label">Slug</label>
                    <input
                        type="text"
                        id="slug"
                        name="slug"
                        class="admin-form-input"
                        value="{{ product.slug if product else '' }}"
                        placeholder="gerado-automaticamente"
                    >
                </div>

                <div class="admin-form-group">
                    <label for="short_description" class="admin-form-label">Descricao Curta</label>
                    <textarea
                        id="short_description"
                        name="short_description"
                        class="admin-form-textarea"
                        style="min-height: 80px;"
                    >{{ product.short_description if product else '' }}</textarea>
                </div>

                <div class="admin-form-group">
                    <label for="long_description" class="admin-form-label">Descricao Completa</label>
                    <textarea
                        id="long_description"
                        name="long_description"
                        class="admin-form-textarea"
                        style="min-height: 150px;"
                    >{{ product.long_description if product else '' }}</textarea>
                </div>
            </div>

            <!-- Affiliate Link -->
            <div class="admin-card">
                <div class="admin-card-header">
                    <h3 class="admin-card-title">Link de Afiliado</h3>
                </div>

                <div class="admin-form-group">
                    <label for="affiliate_url_raw" class="admin-form-label">URL do Afiliado *</label>
                    <input
                        type="url"
                        id="affiliate_url_raw"
                        name="affiliate_url_raw"
                        class="admin-form-input"
                        value="{{ product.affiliate_url_raw if product else '' }}"
                        placeholder="https://amazon.com.br/dp/..."
                        required
                    >
                </div>

                <div class="admin-form-group">
                    <label for="affiliate_redirect_slug" class="admin-form-label">Slug de Redirecionamento *</label>
                    <input
                        type="text"
                        id="affiliate_redirect_slug"
                        name="affiliate_redirect_slug"
                        class="admin-form-input"
                        value="{{ product.affiliate_redirect_slug if product else '' }}"
                        placeholder="produto-amazon"
                        required
                    >
                    <div class="admin-form-hint">URL: /goto/{{ product.affiliate_redirect_slug if product else 'seu-slug' }}</div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="admin-form-sidebar">
            <!-- Platform & Price -->
            <div class="admin-card">
                <div class="admin-form-group">
                    <label for="platform" class="admin-form-label">Plataforma *</label>
                    <select id="platform" name="platform" class="admin-form-select" required>
                        <option value="amazon" {% if not product or product.platform.value == 'amazon' %}selected{% endif %}>Amazon</option>
                        <option value="mercadolivre" {% if product and product.platform.value == 'mercadolivre' %}selected{% endif %}>Mercado Livre</option>
                        <option value="shopee" {% if product and product.platform.value == 'shopee' %}selected{% endif %}>Shopee</option>
                    </select>
                </div>

                <div class="admin-form-group">
                    <label for="platform_product_id" class="admin-form-label">ID do Produto na Plataforma</label>
                    <input
                        type="text"
                        id="platform_product_id"
                        name="platform_product_id"
                        class="admin-form-input"
                        value="{{ product.platform_product_id if product else '' }}"
                        placeholder="B08XYZ123"
                    >
                </div>

                <div class="admin-form-group">
                    <label for="price" class="admin-form-label">Preco (R$)</label>
                    <input
                        type="number"
                        id="price"
                        name="price"
                        class="admin-form-input"
                        value="{{ product.price if product else '' }}"
                        step="0.01"
                        min="0"
                    >
                </div>

                <div class="admin-form-group">
                    <label for="availability" class="admin-form-label">Disponibilidade</label>
                    <select id="availability" name="availability" class="admin-form-select">
                        <option value="available" {% if not product or product.availability.value == 'available' %}selected{% endif %}>Disponivel</option>
                        <option value="unavailable" {% if product and product.availability.value == 'unavailable' %}selected{% endif %}>Indisponivel</option>
                        <option value="unknown" {% if product and product.availability.value == 'unknown' %}selected{% endif %}>Desconhecido</option>
                    </select>
                </div>

                <div class="admin-form-actions">
                    <button type="submit" class="admin-btn admin-btn-primary admin-btn-block">
                        {{ 'Salvar' if product else 'Criar Produto' }}
                    </button>
                </div>
            </div>

            <!-- Images Gallery -->
            <div class="admin-card">
                <div class="admin-card-header">
                    <h3 class="admin-card-title">Imagens do Produto</h3>
                </div>

                <div class="image-gallery-section">
                    <!-- Galeria de imagens -->
                    <div class="image-gallery" id="image-gallery">
                        {% if product and product.images %}
                            {% for img_url in product.images %}
                            <div class="gallery-item" data-url="{{ img_url }}">
                                <img src="{{ img_url }}" alt="Imagem {{ loop.index }}">
                                <div class="gallery-item-actions">
                                    {% if loop.index0 == 0 %}
                                    <span class="gallery-item-main" title="Imagem principal">Principal</span>
                                    {% else %}
                                    <button type="button" class="gallery-action-btn" onclick="setAsMain(this)" title="Definir como principal">
                                        <span>&#9733;</span>
                                    </button>
                                    {% endif %}
                                    <button type="button" class="gallery-action-btn gallery-action-delete" onclick="removeImage(this)" title="Remover">
                                        <span>&times;</span>
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                        {% endif %}
                        <!-- Botao de adicionar -->
                        <div class="gallery-add" onclick="document.getElementById('image-file').click()">
                            <span class="gallery-add-icon">+</span>
                            <span class="gallery-add-text">Adicionar</span>
                        </div>
                    </div>

                    <!-- Input de arquivo oculto -->
                    <input
                        type="file"
                        id="image-file"
                        accept="image/jpeg,image/png,image/webp,image/gif"
                        multiple
                        style="display: none;"
                    >

                    <!-- Status de upload -->
                    <div class="upload-status-bar" id="upload-status-bar" style="display: none;">
                        <span id="upload-status-text">Enviando...</span>
                        <div class="upload-progress">
                            <div class="upload-progress-bar" id="upload-progress-bar"></div>
                        </div>
                    </div>

                    <!-- Hidden input para lista de imagens (JSON) -->
                    <input
                        type="hidden"
                        id="images"
                        name="images"
                        value="{{ product.images | tojson if product and product.images else '[]' }}"
                    >

                    <!-- URL manual opcional -->
                    <div class="admin-form-group" style="margin-top: 1rem;">
                        <label for="image_url_manual" class="admin-form-label">Ou cole uma URL externa</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <input
                                type="text"
                                id="image_url_manual"
                                class="admin-form-input"
                                placeholder="https://exemplo.com/imagem.jpg"
                                style="flex: 1;"
                            >
                            <button type="button" class="admin-btn admin-btn-secondary admin-btn-sm" onclick="addExternalUrl()">
                                Adicionar
                            </button>
                        </div>
                    </div>

                    <div class="admin-form-hint">Redimensionadas para 800x800 px (1:1). Formatos: JPG, PNG, WebP, GIF. Max: 10MB.</div>
                </div>
            </div>

            <!-- Rating -->
            <div class="admin-card">
                <div class="admin-form-group">
                    <label for="rating" class="admin-form-label">Avaliacao (0-5)</label>
                    <input
                        type="number"
                        id="rating"
                        name="rating"
                        class="admin-form-input"
                        value="{{ product.rating if product else '' }}"
                        step="0.1"
                        min="0"
                        max="5"
                    >
                </div>

                <div class="admin-form-group" style="margin-bottom: 0;">
                    <label for="review_count" class="admin-form-label">Numero de Reviews</label>
                    <input
                        type="number"
                        id="review_count"
                        name="review_count"
                        class="admin-form-input"
                        value="{{ product.review_count if product else '' }}"
                        min="0"
                    >
                </div>
            </div>

            <!-- Tags -->
            <div class="admin-card">
                <div class="admin-form-group" style="margin-bottom: 0;">
                    <label for="tags" class="admin-form-label">Tags</label>
                    <input
                        type="text"
                        id="tags"
                        name="tags"
                        class="admin-form-input"
                        value="{{ product.tags | join(', ') if product and product.tags else '' }}"
                        placeholder="tag1, tag2, tag3"
                    >
                    <div class="admin-form-hint">Separadas por virgula</div>
                </div>
            </div>

            <!-- Categorias -->
            <div class="admin-card">
                <div class="admin-card-header">
                    <h3 class="admin-card-title">Categorias</h3>
                </div>

                <div class="admin-form-group">
                    <label class="admin-form-label">Selecione as categorias</label>
                    <div class="category-selector" id="category-selector">
                        {% if categories %}
                        <div class="category-checkboxes">
                            {% for category in categories %}
                            <label class="admin-checkbox" data-slug="{{ category.slug }}">
                                <input
                                    type="checkbox"
                                    name="category_ids"
                                    value="{{ category.slug }}"
                                    {% if product and category.slug in product.categories %}checked{% endif %}
                                >
                                <span>{{ category.name }}</span>
                            </label>
                            {% endfor %}
                        </div>
                        {% else %}
                        <p class="admin-form-hint">Nenhuma categoria cadastrada.</p>
                        {% endif %}
                    </div>
                </div>

                <button type="button" class="admin-btn admin-btn-secondary admin-btn-sm" onclick="openCategoryModal()">
                    + Nova Categoria
                </button>

                <!-- Hidden input para categorias selecionadas (slugs) -->
                <input type="hidden" id="categories_json" name="categories_json" value="{{ product.categories | tojson if product and product.categories else '[]' }}">
            </div>
        </div>
    </div>
</form>

<!-- Modal Nova Categoria -->
<div class="admin-modal" id="category-modal" style="display: none;">
    <div class="admin-modal-backdrop" onclick="closeCategoryModal()"></div>
    <div class="admin-modal-content">
        <div class="admin-modal-header">
            <h3>Nova Categoria</h3>
            <button type="button" class="admin-modal-close" onclick="closeCategoryModal()">&times;</button>
        </div>
        <div class="admin-modal-body">
            <div class="admin-form-group">
                <label for="new_category_name" class="admin-form-label">Nome *</label>
                <input
                    type="text"
                    id="new_category_name"
                    class="admin-form-input"
                    placeholder="Ex: Gamer, Star Wars..."
                    required
                >
            </div>
            <div class="admin-form-group">
                <label for="new_category_slug" class="admin-form-label">Slug</label>
                <input
                    type="text"
                    id="new_category_slug"
                    class="admin-form-input"
                    placeholder="gerado-automaticamente"
                >
                <div class="admin-form-hint">Deixe vazio para gerar automaticamente</div>
            </div>
            <div class="admin-form-group">
                <label for="new_category_description" class="admin-form-label">Descricao</label>
                <textarea
                    id="new_category_description"
                    class="admin-form-textarea"
                    rows="2"
                    placeholder="Descricao breve da categoria"
                ></textarea>
            </div>

            <!-- Upload de imagem da categoria -->
            <div class="admin-form-group">
                <label class="admin-form-label">Imagem da Categoria</label>
                <div class="category-image-upload">
                    <div class="category-image-preview" id="category-image-preview">
                        <div class="image-placeholder">
                            <span>Sem imagem</span>
                        </div>
                    </div>
                    <div class="category-image-controls">
                        <input type="file" id="category-image-file" accept="image/jpeg,image/png,image/webp,image/gif" style="display: none;">
                        <button type="button" class="admin-btn admin-btn-secondary admin-btn-sm" onclick="document.getElementById('category-image-file').click()">
                            Upload
                        </button>
                        <span class="upload-status" id="category-upload-status"></span>
                    </div>
                    <input type="hidden" id="new_category_image_url" value="">
                    <div class="admin-form-hint">Redimensionada automaticamente para 400x400 px</div>
                </div>
            </div>
        </div>
        <div class="admin-modal-footer">
            <button type="button" class="admin-btn admin-btn-secondary" onclick="closeCategoryModal()">Cancelar</button>
            <button type="button" class="admin-btn admin-btn-primary" onclick="createCategory()">Criar Categoria</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// =============================================================================
// Image Gallery Handler - Multiplas Imagens
// =============================================================================

const imageFileInput = document.getElementById('image-file');
const imageGallery = document.getElementById('image-gallery');
const imagesInput = document.getElementById('images');
const uploadStatusBar = document.getElementById('upload-status-bar');
const uploadStatusText = document.getElementById('upload-status-text');
const uploadProgressBar = document.getElementById('upload-progress-bar');
const imageUrlManualInput = document.getElementById('image_url_manual');

// Lista de imagens atual - trata string vazia como array vazio
let images = [];
try {
    const imagesValue = imagesInput.value.trim();
    images = imagesValue ? JSON.parse(imagesValue) : [];
} catch (e) {
    console.warn('Erro ao parsear imagens:', e);
    images = [];
}

// Upload de multiplos arquivos
imageFileInput.addEventListener('change', async function(e) {
    const files = Array.from(e.target.files);
    if (!files.length) return;

    const allowedTypes = ['image/jpeg', 'image/png', 'image/webp', 'image/gif'];
    const maxSize = 10 * 1024 * 1024; // 10MB (sera comprimido no servidor)

    // Filtra arquivos validos
    const validFiles = files.filter(file => {
        if (!allowedTypes.includes(file.type)) {
            console.warn(`Tipo nao permitido: ${file.name}`);
            return false;
        }
        if (file.size > maxSize) {
            console.warn(`Arquivo muito grande: ${file.name}`);
            return false;
        }
        return true;
    });

    if (!validFiles.length) {
        alert('Nenhum arquivo valido selecionado. Formatos: JPG, PNG, WebP, GIF. Max: 10MB');
        return;
    }

    // Mostra barra de progresso
    uploadStatusBar.style.display = 'block';
    uploadProgressBar.style.width = '0%';

    let uploaded = 0;
    const total = validFiles.length;

    for (const file of validFiles) {
        uploadStatusText.textContent = `Enviando ${uploaded + 1}/${total}...`;

        const formData = new FormData();
        formData.append('file', file);

        try {
            const response = await fetch('/admin/upload/image', {
                method: 'POST',
                body: formData,
            });

            const data = await response.json();

            if (response.ok) {
                addImageToGallery(data.url);
                uploaded++;
                uploadProgressBar.style.width = `${(uploaded / total) * 100}%`;
            } else {
                console.error(`Erro ao enviar ${file.name}:`, data.detail);
            }
        } catch (error) {
            console.error(`Erro de conexao ao enviar ${file.name}:`, error);
        }
    }

    // Finaliza
    uploadStatusText.textContent = `${uploaded}/${total} enviado(s)!`;
    uploadProgressBar.style.width = '100%';

    setTimeout(() => {
        uploadStatusBar.style.display = 'none';
    }, 2000);

    // Limpa input
    imageFileInput.value = '';
});

// Adiciona imagem a galeria
function addImageToGallery(url) {
    images.push(url);
    updateImagesInput();
    renderGallery();
}

// Adiciona URL externa
function addExternalUrl() {
    const url = imageUrlManualInput.value.trim();
    if (!url) return;

    if (!url.startsWith('http://') && !url.startsWith('https://')) {
        alert('URL deve comecar com http:// ou https://');
        return;
    }

    addImageToGallery(url);
    imageUrlManualInput.value = '';
}

// Remove imagem da galeria
function removeImage(btn) {
    const item = btn.closest('.gallery-item');
    const url = item.dataset.url;

    images = images.filter(img => img !== url);
    updateImagesInput();
    renderGallery();
}

// Define imagem como principal (move para primeira posicao)
function setAsMain(btn) {
    const item = btn.closest('.gallery-item');
    const url = item.dataset.url;

    // Remove da posicao atual e adiciona no inicio
    images = images.filter(img => img !== url);
    images.unshift(url);

    updateImagesInput();
    renderGallery();
}

// Atualiza input hidden com lista de imagens
function updateImagesInput() {
    imagesInput.value = JSON.stringify(images);
}

// Renderiza galeria completa
function renderGallery() {
    // Remove itens existentes (exceto botao de adicionar)
    const existingItems = imageGallery.querySelectorAll('.gallery-item');
    existingItems.forEach(item => item.remove());

    // Adiciona cada imagem
    const addButton = imageGallery.querySelector('.gallery-add');

    images.forEach((url, index) => {
        const item = document.createElement('div');
        item.className = 'gallery-item';
        item.dataset.url = url;

        const isMain = index === 0;
        const mainBadge = isMain
            ? '<span class="gallery-item-main" title="Imagem principal">Principal</span>'
            : `<button type="button" class="gallery-action-btn" onclick="setAsMain(this)" title="Definir como principal"><span>&#9733;</span></button>`;

        item.innerHTML = `
            <img src="${url}" alt="Imagem ${index + 1}">
            <div class="gallery-item-actions">
                ${mainBadge}
                <button type="button" class="gallery-action-btn gallery-action-delete" onclick="removeImage(this)" title="Remover">
                    <span>&times;</span>
                </button>
            </div>
        `;

        imageGallery.insertBefore(item, addButton);
    });
}

// =============================================================================
// Modal de Categoria
// =============================================================================

// Elementos do modal - usando var para evitar TDZ (Temporal Dead Zone)
var categoryModal = document.getElementById('category-modal');
var categoryImageFile = document.getElementById('category-image-file');
var categoryImagePreview = document.getElementById('category-image-preview');
var categoryUploadStatus = document.getElementById('category-upload-status');
var categoryImageUrlInput = document.getElementById('new_category_image_url');
var categoryNameInput = document.getElementById('new_category_name');
var categorySlugInput = document.getElementById('new_category_slug');
var categorySlugManuallyEdited = false;

// Funcao para gerar slug a partir de texto
function generateSlug(text) {
    if (!text) return '';
    return text
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '') // Remove acentos
        .replace(/[^\w\s-]/g, '') // Remove caracteres especiais
        .replace(/\s+/g, '-') // Substitui espacos por hifens
        .replace(/-+/g, '-') // Remove hifens duplicados
        .trim();
}

// Auto-gerar slug quando o nome muda (se nao foi editado manualmente)
if (categoryNameInput) {
    categoryNameInput.addEventListener('input', function() {
        if (!categorySlugManuallyEdited && categorySlugInput) {
            categorySlugInput.value = generateSlug(this.value);
        }
    });
}

// Marcar slug como editado manualmente quando o usuario digitar
if (categorySlugInput) {
    categorySlugInput.addEventListener('input', function() {
        if (this.value.trim() !== '') {
            categorySlugManuallyEdited = true;
        }
    });
}

function openCategoryModal() {
    if (categoryModal) {
        categoryModal.style.display = 'flex';
        document.getElementById('new_category_name').focus();
    }
}

function closeCategoryModal() {
    if (!categoryModal) return;
    categoryModal.style.display = 'none';
    // Limpa campos
    document.getElementById('new_category_name').value = '';
    document.getElementById('new_category_slug').value = '';
    document.getElementById('new_category_description').value = '';
    if (categoryImageUrlInput) categoryImageUrlInput.value = '';
    if (categoryImagePreview) categoryImagePreview.innerHTML = '<div class="image-placeholder"><span>Sem imagem</span></div>';
    if (categoryUploadStatus) categoryUploadStatus.textContent = '';
    // Reseta flag de edicao manual do slug
    categorySlugManuallyEdited = false;
}

// Upload de imagem da categoria (redimensiona automaticamente para 400x400)
if (categoryImageFile) {
categoryImageFile.addEventListener('change', async function(e) {
    const file = e.target.files[0];
    if (!file) return;

    const allowedTypes = ['image/jpeg', 'image/png', 'image/webp', 'image/gif'];
    if (!allowedTypes.includes(file.type)) {
        categoryUploadStatus.textContent = 'Tipo nao permitido';
        categoryUploadStatus.style.color = 'var(--admin-danger)';
        return;
    }

    if (file.size > 10 * 1024 * 1024) {
        categoryUploadStatus.textContent = 'Max 10MB';
        categoryUploadStatus.style.color = 'var(--admin-danger)';
        return;
    }

    categoryUploadStatus.textContent = 'Enviando...';
    categoryUploadStatus.style.color = 'var(--admin-text-muted)';

    const formData = new FormData();
    formData.append('file', file);

    try {
        // Usa endpoint especifico para categorias (redimensiona para 400x400)
        const response = await fetch('/admin/upload/category-image', {
            method: 'POST',
            body: formData,
        });

        const data = await response.json();

        if (response.ok) {
            categoryImageUrlInput.value = data.url;
            categoryImagePreview.innerHTML = `<img src="${data.url}" alt="Preview">`;
            categoryUploadStatus.textContent = '400x400 OK!';
            categoryUploadStatus.style.color = 'var(--admin-success)';
        } else {
            categoryUploadStatus.textContent = data.detail || 'Erro';
            categoryUploadStatus.style.color = 'var(--admin-danger)';
        }
    } catch (error) {
        categoryUploadStatus.textContent = 'Erro de conexao';
        categoryUploadStatus.style.color = 'var(--admin-danger)';
    }

    categoryImageFile.value = '';
});
} // fecha if (categoryImageFile)

// Criar categoria via AJAX
async function createCategory() {
    const name = document.getElementById('new_category_name').value.trim();
    const slug = document.getElementById('new_category_slug').value.trim();
    const description = document.getElementById('new_category_description').value.trim();
    const imageUrl = categoryImageUrlInput.value;

    if (!name) {
        alert('Nome da categoria e obrigatorio');
        return;
    }

    try {
        const response = await fetch('/admin/api/categories', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                name: name,
                slug: slug || null,
                description: description || null,
                image_url: imageUrl || null,
            }),
        });

        const data = await response.json();

        if (response.ok) {
            // Adiciona checkbox da nova categoria
            addCategoryToList(data);
            closeCategoryModal();
        } else {
            alert(data.detail || 'Erro ao criar categoria');
        }
    } catch (error) {
        alert('Erro de conexao ao criar categoria');
        console.error(error);
    }
}

// Adiciona nova categoria a lista de checkboxes
function addCategoryToList(category) {
    const selector = document.getElementById('category-selector');
    let checkboxes = selector.querySelector('.category-checkboxes');

    // Se nao existe container de checkboxes, cria
    if (!checkboxes) {
        selector.innerHTML = '<div class="category-checkboxes"></div>';
        checkboxes = selector.querySelector('.category-checkboxes');
    }

    // Cria novo checkbox com data-slug
    const label = document.createElement('label');
    label.className = 'admin-checkbox';
    label.dataset.slug = category.slug;
    label.innerHTML = `
        <input type="checkbox" name="category_ids" value="${category.slug}" checked>
        <span>${category.name}</span>
    `;

    checkboxes.appendChild(label);
}

// Atualiza hidden input com categorias selecionadas antes do submit
document.querySelector('form.admin-form').addEventListener('submit', function(e) {
    const checkboxes = document.querySelectorAll('input[name="category_ids"]:checked');
    const categories = Array.from(checkboxes).map(cb => cb.value);

    document.getElementById('categories_json').value = JSON.stringify(categories);
});
</script>
{% endblock %}
