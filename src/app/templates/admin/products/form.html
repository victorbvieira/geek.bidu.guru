{% extends "admin/base.html" %}

{% block title %}{{ 'Editar' if product else 'Novo' }} Produto{% endblock %}

{% block breadcrumb %}
<span>/</span>
<a href="/admin/products">Produtos</a>
<span>/</span>
<span class="current">{{ 'Editar' if product else 'Novo' }}</span>
{% endblock %}

{% block content %}
<div class="admin-page-header">
    <h1 class="admin-page-title">{{ 'Editar Produto' if product else 'Novo Produto' }}</h1>
</div>

<form method="POST" action="{{ '/admin/products/' ~ product.id if product else '/admin/products' }}" class="admin-form">
    <div class="admin-form-grid">
        <!-- Main Content -->
        <div class="admin-form-main">
            <div class="admin-card">
                <div class="admin-form-group">
                    <label for="name" class="admin-form-label">Nome do Produto *</label>
                    <input
                        type="text"
                        id="name"
                        name="name"
                        class="admin-form-input"
                        value="{{ product.name if product else '' }}"
                        required
                    >
                </div>

                <div class="admin-form-group">
                    <label for="slug" class="admin-form-label">Slug</label>
                    <input
                        type="text"
                        id="slug"
                        name="slug"
                        class="admin-form-input"
                        value="{{ product.slug if product else '' }}"
                        placeholder="gerado-automaticamente"
                    >
                </div>

                <div class="admin-form-group">
                    <label for="short_description" class="admin-form-label">Descricao Curta</label>
                    <textarea
                        id="short_description"
                        name="short_description"
                        class="admin-form-textarea"
                        style="min-height: 80px;"
                    >{{ product.short_description if product else '' }}</textarea>
                </div>

                <div class="admin-form-group">
                    <label for="long_description" class="admin-form-label">Descricao Completa</label>
                    <textarea
                        id="long_description"
                        name="long_description"
                        class="admin-form-textarea"
                        style="min-height: 150px;"
                    >{{ product.long_description if product else '' }}</textarea>
                </div>
            </div>

            <!-- Affiliate Link -->
            <div class="admin-card">
                <div class="admin-card-header">
                    <h3 class="admin-card-title">Link de Afiliado</h3>
                </div>

                <div class="admin-form-group">
                    <label for="affiliate_url_raw" class="admin-form-label">URL do Afiliado *</label>
                    <input
                        type="url"
                        id="affiliate_url_raw"
                        name="affiliate_url_raw"
                        class="admin-form-input"
                        value="{{ product.affiliate_url_raw if product else '' }}"
                        placeholder="https://amazon.com.br/dp/..."
                        required
                    >
                </div>

                <div class="admin-form-group">
                    <label for="affiliate_redirect_slug" class="admin-form-label">Slug de Redirecionamento *</label>
                    <input
                        type="text"
                        id="affiliate_redirect_slug"
                        name="affiliate_redirect_slug"
                        class="admin-form-input"
                        value="{{ product.affiliate_redirect_slug if product else '' }}"
                        placeholder="produto-amazon"
                        required
                    >
                    <div class="admin-form-hint">URL: /goto/{{ product.affiliate_redirect_slug if product else 'seu-slug' }}</div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="admin-form-sidebar">
            <!-- Platform & Price -->
            <div class="admin-card">
                <div class="admin-form-group">
                    <label for="platform" class="admin-form-label">Plataforma *</label>
                    <select id="platform" name="platform" class="admin-form-select" required>
                        <option value="amazon" {% if not product or product.platform.value == 'amazon' %}selected{% endif %}>Amazon</option>
                        <option value="mercadolivre" {% if product and product.platform.value == 'mercadolivre' %}selected{% endif %}>Mercado Livre</option>
                        <option value="shopee" {% if product and product.platform.value == 'shopee' %}selected{% endif %}>Shopee</option>
                    </select>
                </div>

                <div class="admin-form-group">
                    <label for="platform_product_id" class="admin-form-label">ID do Produto na Plataforma</label>
                    <input
                        type="text"
                        id="platform_product_id"
                        name="platform_product_id"
                        class="admin-form-input"
                        value="{{ product.platform_product_id if product else '' }}"
                        placeholder="B08XYZ123"
                    >
                </div>

                <div class="admin-form-group">
                    <label for="price" class="admin-form-label">Preco (R$)</label>
                    <input
                        type="number"
                        id="price"
                        name="price"
                        class="admin-form-input"
                        value="{{ product.price if product else '' }}"
                        step="0.01"
                        min="0"
                    >
                </div>

                <div class="admin-form-group">
                    <label for="availability" class="admin-form-label">Disponibilidade</label>
                    <select id="availability" name="availability" class="admin-form-select">
                        <option value="available" {% if not product or product.availability.value == 'available' %}selected{% endif %}>Disponivel</option>
                        <option value="unavailable" {% if product and product.availability.value == 'unavailable' %}selected{% endif %}>Indisponivel</option>
                        <option value="unknown" {% if product and product.availability.value == 'unknown' %}selected{% endif %}>Desconhecido</option>
                    </select>
                </div>

                <div class="admin-form-actions">
                    <button type="submit" class="admin-btn admin-btn-primary admin-btn-block">
                        {{ 'Salvar' if product else 'Criar Produto' }}
                    </button>
                </div>
            </div>

            <!-- Images Gallery -->
            <div class="admin-card">
                <div class="admin-card-header">
                    <h3 class="admin-card-title">Imagens do Produto</h3>
                </div>

                <div class="image-gallery-section">
                    <!-- Galeria de imagens -->
                    <div class="image-gallery" id="image-gallery">
                        {% if product and product.images %}
                            {% for img_url in product.images %}
                            <div class="gallery-item" data-url="{{ img_url }}">
                                <img src="{{ img_url }}" alt="Imagem {{ loop.index }}">
                                <div class="gallery-item-actions">
                                    {% if loop.index0 == 0 %}
                                    <span class="gallery-item-main" title="Imagem principal">Principal</span>
                                    {% else %}
                                    <button type="button" class="gallery-action-btn" onclick="setAsMain(this)" title="Definir como principal">
                                        <span>&#9733;</span>
                                    </button>
                                    {% endif %}
                                    <button type="button" class="gallery-action-btn gallery-action-delete" onclick="removeImage(this)" title="Remover">
                                        <span>&times;</span>
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                        {% endif %}
                        <!-- Botao de adicionar -->
                        <div class="gallery-add" onclick="document.getElementById('image-file').click()">
                            <span class="gallery-add-icon">+</span>
                            <span class="gallery-add-text">Adicionar</span>
                        </div>
                    </div>

                    <!-- Input de arquivo oculto -->
                    <input
                        type="file"
                        id="image-file"
                        accept="image/jpeg,image/png,image/webp,image/gif"
                        multiple
                        style="display: none;"
                    >

                    <!-- Status de upload -->
                    <div class="upload-status-bar" id="upload-status-bar" style="display: none;">
                        <span id="upload-status-text">Enviando...</span>
                        <div class="upload-progress">
                            <div class="upload-progress-bar" id="upload-progress-bar"></div>
                        </div>
                    </div>

                    <!-- Hidden input para lista de imagens (JSON) -->
                    <input
                        type="hidden"
                        id="images"
                        name="images"
                        value="{{ product.images | tojson if product and product.images else '[]' }}"
                    >

                    <!-- URL manual opcional -->
                    <div class="admin-form-group" style="margin-top: 1rem;">
                        <label for="image_url_manual" class="admin-form-label">Ou cole uma URL externa</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <input
                                type="text"
                                id="image_url_manual"
                                class="admin-form-input"
                                placeholder="https://exemplo.com/imagem.jpg"
                                style="flex: 1;"
                            >
                            <button type="button" class="admin-btn admin-btn-secondary admin-btn-sm" onclick="addExternalUrl()">
                                Adicionar
                            </button>
                        </div>
                    </div>

                    <div class="admin-form-hint">Formatos: JPG, PNG, WebP, GIF. Max: 5MB. A primeira imagem sera a principal.</div>
                </div>
            </div>

            <!-- Rating -->
            <div class="admin-card">
                <div class="admin-form-group">
                    <label for="rating" class="admin-form-label">Avaliacao (0-5)</label>
                    <input
                        type="number"
                        id="rating"
                        name="rating"
                        class="admin-form-input"
                        value="{{ product.rating if product else '' }}"
                        step="0.1"
                        min="0"
                        max="5"
                    >
                </div>

                <div class="admin-form-group" style="margin-bottom: 0;">
                    <label for="review_count" class="admin-form-label">Numero de Reviews</label>
                    <input
                        type="number"
                        id="review_count"
                        name="review_count"
                        class="admin-form-input"
                        value="{{ product.review_count if product else '' }}"
                        min="0"
                    >
                </div>
            </div>

            <!-- Tags -->
            <div class="admin-card">
                <div class="admin-form-group" style="margin-bottom: 0;">
                    <label for="tags" class="admin-form-label">Tags</label>
                    <input
                        type="text"
                        id="tags"
                        name="tags"
                        class="admin-form-input"
                        value="{{ product.tags | join(', ') if product and product.tags else '' }}"
                        placeholder="tag1, tag2, tag3"
                    >
                    <div class="admin-form-hint">Separadas por virgula</div>
                </div>
            </div>
        </div>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
// =============================================================================
// Image Gallery Handler - Multiplas Imagens
// =============================================================================

const imageFileInput = document.getElementById('image-file');
const imageGallery = document.getElementById('image-gallery');
const imagesInput = document.getElementById('images');
const uploadStatusBar = document.getElementById('upload-status-bar');
const uploadStatusText = document.getElementById('upload-status-text');
const uploadProgressBar = document.getElementById('upload-progress-bar');
const imageUrlManualInput = document.getElementById('image_url_manual');

// Lista de imagens atual
let images = JSON.parse(imagesInput.value || '[]');

// Upload de multiplos arquivos
imageFileInput.addEventListener('change', async function(e) {
    const files = Array.from(e.target.files);
    if (!files.length) return;

    const allowedTypes = ['image/jpeg', 'image/png', 'image/webp', 'image/gif'];
    const maxSize = 5 * 1024 * 1024; // 5MB

    // Filtra arquivos validos
    const validFiles = files.filter(file => {
        if (!allowedTypes.includes(file.type)) {
            console.warn(`Tipo nao permitido: ${file.name}`);
            return false;
        }
        if (file.size > maxSize) {
            console.warn(`Arquivo muito grande: ${file.name}`);
            return false;
        }
        return true;
    });

    if (!validFiles.length) {
        alert('Nenhum arquivo valido selecionado. Formatos: JPG, PNG, WebP, GIF. Max: 5MB');
        return;
    }

    // Mostra barra de progresso
    uploadStatusBar.style.display = 'block';
    uploadProgressBar.style.width = '0%';

    let uploaded = 0;
    const total = validFiles.length;

    for (const file of validFiles) {
        uploadStatusText.textContent = `Enviando ${uploaded + 1}/${total}...`;

        const formData = new FormData();
        formData.append('file', file);

        try {
            const response = await fetch('/admin/upload/image', {
                method: 'POST',
                body: formData,
            });

            const data = await response.json();

            if (response.ok) {
                addImageToGallery(data.url);
                uploaded++;
                uploadProgressBar.style.width = `${(uploaded / total) * 100}%`;
            } else {
                console.error(`Erro ao enviar ${file.name}:`, data.detail);
            }
        } catch (error) {
            console.error(`Erro de conexao ao enviar ${file.name}:`, error);
        }
    }

    // Finaliza
    uploadStatusText.textContent = `${uploaded}/${total} enviado(s)!`;
    uploadProgressBar.style.width = '100%';

    setTimeout(() => {
        uploadStatusBar.style.display = 'none';
    }, 2000);

    // Limpa input
    imageFileInput.value = '';
});

// Adiciona imagem a galeria
function addImageToGallery(url) {
    images.push(url);
    updateImagesInput();
    renderGallery();
}

// Adiciona URL externa
function addExternalUrl() {
    const url = imageUrlManualInput.value.trim();
    if (!url) return;

    if (!url.startsWith('http://') && !url.startsWith('https://')) {
        alert('URL deve comecar com http:// ou https://');
        return;
    }

    addImageToGallery(url);
    imageUrlManualInput.value = '';
}

// Remove imagem da galeria
function removeImage(btn) {
    const item = btn.closest('.gallery-item');
    const url = item.dataset.url;

    images = images.filter(img => img !== url);
    updateImagesInput();
    renderGallery();
}

// Define imagem como principal (move para primeira posicao)
function setAsMain(btn) {
    const item = btn.closest('.gallery-item');
    const url = item.dataset.url;

    // Remove da posicao atual e adiciona no inicio
    images = images.filter(img => img !== url);
    images.unshift(url);

    updateImagesInput();
    renderGallery();
}

// Atualiza input hidden com lista de imagens
function updateImagesInput() {
    imagesInput.value = JSON.stringify(images);
}

// Renderiza galeria completa
function renderGallery() {
    // Remove itens existentes (exceto botao de adicionar)
    const existingItems = imageGallery.querySelectorAll('.gallery-item');
    existingItems.forEach(item => item.remove());

    // Adiciona cada imagem
    const addButton = imageGallery.querySelector('.gallery-add');

    images.forEach((url, index) => {
        const item = document.createElement('div');
        item.className = 'gallery-item';
        item.dataset.url = url;

        const isMain = index === 0;
        const mainBadge = isMain
            ? '<span class="gallery-item-main" title="Imagem principal">Principal</span>'
            : `<button type="button" class="gallery-action-btn" onclick="setAsMain(this)" title="Definir como principal"><span>&#9733;</span></button>`;

        item.innerHTML = `
            <img src="${url}" alt="Imagem ${index + 1}">
            <div class="gallery-item-actions">
                ${mainBadge}
                <button type="button" class="gallery-action-btn gallery-action-delete" onclick="removeImage(this)" title="Remover">
                    <span>&times;</span>
                </button>
            </div>
        `;

        imageGallery.insertBefore(item, addButton);
    });
}
</script>
{% endblock %}
