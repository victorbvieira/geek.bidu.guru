{% extends "admin/base.html" %}

{% block title %}{{ 'Editar' if product else 'Novo' }} Produto{% endblock %}

{% block breadcrumb %}
<span>/</span>
<a href="/admin/products">Produtos</a>
<span>/</span>
<span class="current">{{ 'Editar' if product else 'Novo' }}</span>
{% endblock %}

{% block content %}
<div class="admin-page-header">
    <h1 class="admin-page-title">{{ 'Editar Produto' if product else 'Novo Produto' }}</h1>
</div>

<form method="POST" action="{{ '/admin/products/' ~ product.id if product else '/admin/products' }}" class="admin-form">
    <div class="admin-form-grid">
        <!-- Main Content -->
        <div class="admin-form-main">
            <div class="admin-card">
                <div class="admin-form-group">
                    <label for="name" class="admin-form-label">Nome do Produto *</label>
                    <input
                        type="text"
                        id="name"
                        name="name"
                        class="admin-form-input"
                        value="{{ product.name if product else '' }}"
                        required
                    >
                </div>

                <div class="admin-form-group">
                    <label for="slug" class="admin-form-label">Slug</label>
                    <input
                        type="text"
                        id="slug"
                        name="slug"
                        class="admin-form-input"
                        value="{{ product.slug if product else '' }}"
                        placeholder="gerado-automaticamente"
                    >
                </div>

                <div class="admin-form-group">
                    <label for="short_description" class="admin-form-label">Descricao Curta</label>
                    <textarea
                        id="short_description"
                        name="short_description"
                        class="admin-form-textarea"
                        style="min-height: 80px;"
                    >{{ product.short_description if product else '' }}</textarea>
                </div>

                <div class="admin-form-group">
                    <label for="long_description" class="admin-form-label">Descricao Completa</label>
                    <textarea
                        id="long_description"
                        name="long_description"
                        class="admin-form-textarea"
                        style="min-height: 150px;"
                    >{{ product.long_description if product else '' }}</textarea>
                </div>
            </div>

            <!-- Affiliate Link -->
            <div class="admin-card">
                <div class="admin-card-header">
                    <h3 class="admin-card-title">Link de Afiliado</h3>
                </div>

                <div class="admin-form-group">
                    <label for="affiliate_url_raw" class="admin-form-label">URL do Afiliado *</label>
                    <input
                        type="url"
                        id="affiliate_url_raw"
                        name="affiliate_url_raw"
                        class="admin-form-input"
                        value="{{ product.affiliate_url_raw if product else '' }}"
                        placeholder="https://amazon.com.br/dp/..."
                        required
                    >
                </div>

                <div class="admin-form-group">
                    <label for="affiliate_redirect_slug" class="admin-form-label">Slug de Redirecionamento *</label>
                    <input
                        type="text"
                        id="affiliate_redirect_slug"
                        name="affiliate_redirect_slug"
                        class="admin-form-input"
                        value="{{ product.affiliate_redirect_slug if product else '' }}"
                        placeholder="produto-amazon"
                        required
                    >
                    <div class="admin-form-hint">URL: /goto/{{ product.affiliate_redirect_slug if product else 'seu-slug' }}</div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="admin-form-sidebar">
            <!-- Platform & Price -->
            <div class="admin-card">
                <div class="admin-form-group">
                    <label for="platform" class="admin-form-label">Plataforma *</label>
                    <select id="platform" name="platform" class="admin-form-select" required>
                        <option value="amazon" {% if not product or product.platform.value == 'amazon' %}selected{% endif %}>Amazon</option>
                        <option value="mercadolivre" {% if product and product.platform.value == 'mercadolivre' %}selected{% endif %}>Mercado Livre</option>
                        <option value="shopee" {% if product and product.platform.value == 'shopee' %}selected{% endif %}>Shopee</option>
                    </select>
                </div>

                <div class="admin-form-group">
                    <label for="platform_product_id" class="admin-form-label">ID do Produto na Plataforma</label>
                    <input
                        type="text"
                        id="platform_product_id"
                        name="platform_product_id"
                        class="admin-form-input"
                        value="{{ product.platform_product_id if product else '' }}"
                        placeholder="B08XYZ123"
                    >
                </div>

                <div class="admin-form-group">
                    <label for="price" class="admin-form-label">Preco (R$)</label>
                    <input
                        type="number"
                        id="price"
                        name="price"
                        class="admin-form-input"
                        value="{{ product.price if product else '' }}"
                        step="0.01"
                        min="0"
                    >
                </div>

                <div class="admin-form-group">
                    <label for="availability" class="admin-form-label">Disponibilidade</label>
                    <select id="availability" name="availability" class="admin-form-select">
                        <option value="available" {% if not product or product.availability.value == 'available' %}selected{% endif %}>Disponivel</option>
                        <option value="unavailable" {% if product and product.availability.value == 'unavailable' %}selected{% endif %}>Indisponivel</option>
                        <option value="unknown" {% if product and product.availability.value == 'unknown' %}selected{% endif %}>Desconhecido</option>
                    </select>
                </div>

                <div class="admin-form-actions">
                    <button type="submit" class="admin-btn admin-btn-primary admin-btn-block">
                        {{ 'Salvar' if product else 'Criar Produto' }}
                    </button>
                </div>
            </div>

            <!-- Image -->
            <div class="admin-card">
                <div class="admin-card-header">
                    <h3 class="admin-card-title">Imagem Principal</h3>
                </div>

                <div class="image-upload-section">
                    <!-- Preview da imagem -->
                    <div class="image-preview" id="image-preview">
                        {% if product and product.main_image_url %}
                        <img src="{{ product.main_image_url }}" alt="Preview" id="preview-img">
                        {% else %}
                        <div class="image-placeholder" id="preview-placeholder">
                            <span>Nenhuma imagem</span>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Upload -->
                    <div class="image-upload-controls">
                        <input
                            type="file"
                            id="image-file"
                            accept="image/jpeg,image/png,image/webp,image/gif"
                            style="display: none;"
                        >
                        <button type="button" class="admin-btn admin-btn-secondary admin-btn-sm" onclick="document.getElementById('image-file').click()">
                            Fazer Upload
                        </button>
                        <span class="upload-status" id="upload-status"></span>
                    </div>

                    <!-- URL manual (hidden input para o form) -->
                    <input
                        type="hidden"
                        id="main_image_url"
                        name="main_image_url"
                        value="{{ product.main_image_url if product else '' }}"
                    >

                    <!-- URL manual opcional -->
                    <div class="admin-form-group" style="margin-top: 1rem;">
                        <label for="image_url_manual" class="admin-form-label">Ou cole uma URL</label>
                        <input
                            type="url"
                            id="image_url_manual"
                            class="admin-form-input"
                            value="{{ product.main_image_url if product else '' }}"
                            placeholder="https://..."
                            onchange="setImageUrl(this.value)"
                        >
                    </div>

                    <div class="admin-form-hint">Formatos: JPG, PNG, WebP, GIF. Max: 5MB</div>
                </div>
            </div>

            <!-- Rating -->
            <div class="admin-card">
                <div class="admin-form-group">
                    <label for="rating" class="admin-form-label">Avaliacao (0-5)</label>
                    <input
                        type="number"
                        id="rating"
                        name="rating"
                        class="admin-form-input"
                        value="{{ product.rating if product else '' }}"
                        step="0.1"
                        min="0"
                        max="5"
                    >
                </div>

                <div class="admin-form-group" style="margin-bottom: 0;">
                    <label for="review_count" class="admin-form-label">Numero de Reviews</label>
                    <input
                        type="number"
                        id="review_count"
                        name="review_count"
                        class="admin-form-input"
                        value="{{ product.review_count if product else '' }}"
                        min="0"
                    >
                </div>
            </div>

            <!-- Tags -->
            <div class="admin-card">
                <div class="admin-form-group" style="margin-bottom: 0;">
                    <label for="tags" class="admin-form-label">Tags</label>
                    <input
                        type="text"
                        id="tags"
                        name="tags"
                        class="admin-form-input"
                        value="{{ product.tags | join(', ') if product and product.tags else '' }}"
                        placeholder="tag1, tag2, tag3"
                    >
                    <div class="admin-form-hint">Separadas por virgula</div>
                </div>
            </div>
        </div>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
// Image Upload Handler
const imageFileInput = document.getElementById('image-file');
const mainImageUrlInput = document.getElementById('main_image_url');
const imageUrlManualInput = document.getElementById('image_url_manual');
const imagePreview = document.getElementById('image-preview');
const uploadStatus = document.getElementById('upload-status');

// Upload de arquivo
imageFileInput.addEventListener('change', async function(e) {
    const file = e.target.files[0];
    if (!file) return;

    // Valida tipo
    const allowedTypes = ['image/jpeg', 'image/png', 'image/webp', 'image/gif'];
    if (!allowedTypes.includes(file.type)) {
        uploadStatus.textContent = 'Tipo de arquivo nao permitido';
        uploadStatus.style.color = 'var(--admin-danger)';
        return;
    }

    // Valida tamanho (5MB)
    if (file.size > 5 * 1024 * 1024) {
        uploadStatus.textContent = 'Arquivo muito grande (max 5MB)';
        uploadStatus.style.color = 'var(--admin-danger)';
        return;
    }

    // Mostra loading
    uploadStatus.textContent = 'Enviando...';
    uploadStatus.style.color = 'var(--admin-text-muted)';

    // Prepara form data
    const formData = new FormData();
    formData.append('file', file);

    try {
        const response = await fetch('/admin/upload/image', {
            method: 'POST',
            body: formData,
        });

        const data = await response.json();

        if (response.ok) {
            // Sucesso
            setImageUrl(data.url);
            uploadStatus.textContent = 'Enviado!';
            uploadStatus.style.color = 'var(--admin-success)';

            // Limpa status apos 3s
            setTimeout(() => {
                uploadStatus.textContent = '';
            }, 3000);
        } else {
            // Erro
            uploadStatus.textContent = data.detail || 'Erro no upload';
            uploadStatus.style.color = 'var(--admin-danger)';
        }
    } catch (error) {
        uploadStatus.textContent = 'Erro de conexao';
        uploadStatus.style.color = 'var(--admin-danger)';
        console.error('Upload error:', error);
    }

    // Limpa input
    imageFileInput.value = '';
});

// Define URL da imagem e atualiza preview
function setImageUrl(url) {
    mainImageUrlInput.value = url;
    imageUrlManualInput.value = url;

    // Atualiza preview
    if (url) {
        imagePreview.innerHTML = `<img src="${url}" alt="Preview" id="preview-img">`;
    } else {
        imagePreview.innerHTML = `<div class="image-placeholder" id="preview-placeholder"><span>Nenhuma imagem</span></div>`;
    }
}
</script>
{% endblock %}
