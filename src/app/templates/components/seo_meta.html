{#
    Componente SEO - Meta tags e Schema.org/JSON-LD

    Variaveis esperadas:
    - canonical_url: URL canonica da pagina (obrigatorio)
    - title: Titulo da pagina
    - description: Descricao meta
    - og_type: Tipo Open Graph (default: website)
    - og_image: URL da imagem Open Graph (se nao fornecida, gera dinamicamente)
    - og_image_type: Tipo de imagem OG dinamica (post, product, category, home)
    - article_published: Data de publicacao (para artigos)
    - article_modified: Data de modificacao (para artigos)
    - article_author: Nome do autor (para artigos)
    - article_section: Secao do artigo (categoria)
    - schema_type: Tipo de schema (BlogPosting, Product, ItemList, etc)
    - post: Objeto Post (para BlogPosting)
    - product: Objeto Product (para Product schema)
    - products: Lista de produtos (para ItemList)
    - breadcrumbs: Lista de breadcrumbs [{"name": "...", "url": "..."}]
#}

{# Gera URL da imagem OG dinamica se nao fornecida #}
{% set og_image_url = og_image %}

{# Converte URL relativa para absoluta se necessario #}
{% if og_image_url and og_image_url.startswith('/') %}
    {% set og_image_url = base_url ~ og_image_url %}
{% elif og_image_url and not og_image_url.startswith('http') %}
    {% set og_image_url = base_url ~ '/' ~ og_image_url %}
{% endif %}

{# Se nao tem imagem, gera URL dinamica #}
{% if not og_image_url %}
    {% if og_image_type == 'product' and product %}
        {% set og_image_url = base_url ~ '/og/product.png?title=' ~ (product.name | urlencode) ~ ('&price=' ~ (product.price | format_price | urlencode) if product.price else '') ~ ('&platform=' ~ product.platform.value if product.platform else '') %}
    {% elif og_image_type == 'category' or og_type == 'category' %}
        {% set og_image_url = base_url ~ '/og/category.png?title=' ~ (title | urlencode) ~ ('&subtitle=' ~ (description | urlencode) if description else '') %}
    {% elif og_type == 'article' or schema_type == 'BlogPosting' %}
        {% set og_image_url = base_url ~ '/og/post.png?title=' ~ (title | urlencode) ~ ('&subtitle=' ~ (description | urlencode) if description else '') ~ ('&category=' ~ (article_section | urlencode) if article_section else '') %}
    {% else %}
        {% set og_image_url = base_url ~ '/og/home.png' %}
    {% endif %}
{% endif %}

{# Canonical URL - Evita conteudo duplicado #}
<link rel="canonical" href="{{ canonical_url }}">

{# Meta tags basicas #}
<meta name="description" content="{{ description | default('Encontre o presente geek perfeito') }}">
{% if seo_keywords %}
<meta name="keywords" content="{{ seo_keywords }}">
{% endif %}

{# Robots meta #}
{% if noindex %}
<meta name="robots" content="noindex, nofollow">
{% else %}
<meta name="robots" content="index, follow">
{% endif %}

{# Open Graph #}
<meta property="og:title" content="{{ title | default('geek.bidu.guru') }}">
<meta property="og:description" content="{{ description | default('Encontre o presente geek perfeito') }}">
<meta property="og:type" content="{{ og_type | default('website') }}">
<meta property="og:url" content="{{ canonical_url }}">
<meta property="og:site_name" content="geek.bidu.guru">
<meta property="og:locale" content="pt_BR">
{% if og_image_url %}
<meta property="og:image" content="{{ og_image_url }}">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="630">
{% endif %}

{# Article meta (para posts) #}
{% if og_type == 'article' %}
{% if article_published %}
<meta property="article:published_time" content="{{ article_published }}">
{% endif %}
{% if article_modified %}
<meta property="article:modified_time" content="{{ article_modified }}">
{% endif %}
{% if article_author %}
<meta property="article:author" content="{{ article_author }}">
{% endif %}
{% if article_section %}
<meta property="article:section" content="{{ article_section }}">
{% endif %}
{% if article_tags %}
{% for tag in article_tags %}
<meta property="article:tag" content="{{ tag }}">
{% endfor %}
{% endif %}
{% endif %}

{# Twitter Cards #}
<meta name="twitter:card" content="{{ twitter_card | default('summary_large_image') }}">
<meta name="twitter:title" content="{{ title | default('geek.bidu.guru') }}">
<meta name="twitter:description" content="{{ description | default('Encontre o presente geek perfeito') }}">
{% if og_image_url %}
<meta name="twitter:image" content="{{ og_image_url }}">
{% endif %}

{# ============================================================================= #}
{# SCHEMA.ORG / JSON-LD                                                          #}
{# ============================================================================= #}

{# Schema Organization (sempre incluido) #}
<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Organization",
    "name": "geek.bidu.guru",
    "url": "{{ base_url | default('https://geek.bidu.guru') }}",
    "logo": "{{ base_url | default('https://geek.bidu.guru') }}/static/images/logo.png",
    "sameAs": []
}
</script>

{# Schema WebSite (para busca) #}
<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "WebSite",
    "name": "geek.bidu.guru",
    "url": "{{ base_url | default('https://geek.bidu.guru') }}",
    "potentialAction": {
        "@type": "SearchAction",
        "target": "{{ base_url | default('https://geek.bidu.guru') }}/busca?q={search_term_string}",
        "query-input": "required name=search_term_string"
    }
}
</script>

{# Schema BreadcrumbList #}
{% if breadcrumbs and breadcrumbs|length > 0 %}
<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    "itemListElement": [
        {% for crumb in breadcrumbs %}
        {
            "@type": "ListItem",
            "position": {{ loop.index }},
            "name": "{{ crumb.name }}",
            "item": "{{ crumb.url }}"
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    ]
}
</script>
{% endif %}

{# Schema BlogPosting (para posts) #}
{% if schema_type == 'BlogPosting' and post %}
<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "headline": "{{ post.title }}",
    "description": "{{ post.seo_description or post.subtitle or post.title }}",
    "url": "{{ canonical_url }}",
    {% if post.featured_image_url %}
    "image": "{{ post.featured_image_url }}",
    {% endif %}
    "datePublished": "{{ post.publish_at.isoformat() if post.publish_at else post.created_at.isoformat() }}",
    "dateModified": "{{ post.updated_at.isoformat() if post.updated_at else post.created_at.isoformat() }}",
    {% if post.author %}
    "author": {
        "@type": "Person",
        "name": "{{ post.author.name }}"
    },
    {% endif %}
    "publisher": {
        "@type": "Organization",
        "name": "geek.bidu.guru",
        "logo": {
            "@type": "ImageObject",
            "url": "{{ base_url | default('https://geek.bidu.guru') }}/static/images/logo.png"
        }
    },
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "{{ canonical_url }}"
    }
    {% if post.tags and post.tags|length > 0 %},
    "keywords": "{{ post.tags | join(', ') }}"
    {% endif %}
}
</script>
{% endif %}

{# Schema Product (para pagina de produto individual) #}
{% if schema_type == 'Product' and product %}
<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Product",
    "name": "{{ product.name }}",
    "description": "{{ product.short_description or product.name }}",
    "url": "{{ canonical_url }}",
    {% if product.main_image_url %}
    "image": "{{ product.main_image_url }}",
    {% endif %}
    {% if product.price %}
    "offers": {
        "@type": "Offer",
        "price": "{{ product.price }}",
        "priceCurrency": "{{ product.currency | default('BRL') }}",
        "availability": "{% if product.availability.value == 'available' %}https://schema.org/InStock{% elif product.availability.value == 'unavailable' %}https://schema.org/OutOfStock{% else %}https://schema.org/PreOrder{% endif %}",
        "url": "{{ canonical_url }}"
    },
    {% endif %}
    {% if product.rating %}
    "aggregateRating": {
        "@type": "AggregateRating",
        "ratingValue": "{{ product.rating }}",
        "reviewCount": "{{ product.review_count | default(1) }}"
    },
    {% endif %}
    "brand": {
        "@type": "Brand",
        "name": "{{ product.platform.value | title if product.platform else 'Diversos' }}"
    }
}
</script>
{% endif %}

{# Schema ItemList (para listicles e listas de produtos) #}
{% if schema_type == 'ItemList' and products and products|length > 0 %}
<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "ItemList",
    "name": "{{ title | default('Lista de Produtos') }}",
    "description": "{{ description | default('Selecao de produtos geek') }}",
    "numberOfItems": {{ products|length }},
    "itemListElement": [
        {% for product in products %}
        {
            "@type": "ListItem",
            "position": {{ loop.index }},
            "item": {
                "@type": "Product",
                "name": "{{ product.name }}",
                {% if product.short_description %}
                "description": "{{ product.short_description }}",
                {% endif %}
                {% if product.main_image_url %}
                "image": "{{ product.main_image_url }}",
                {% endif %}
                {% if product.price %}
                "offers": {
                    "@type": "Offer",
                    "price": "{{ product.price }}",
                    "priceCurrency": "{{ product.currency | default('BRL') }}"
                }
                {% endif %}
            }
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    ]
}
</script>
{% endif %}

{# Schema FAQPage (para posts com perguntas frequentes) #}
{% if schema_type == 'FAQPage' and faqs and faqs|length > 0 %}
<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "FAQPage",
    "mainEntity": [
        {% for faq in faqs %}
        {
            "@type": "Question",
            "name": "{{ faq.question }}",
            "acceptedAnswer": {
                "@type": "Answer",
                "text": "{{ faq.answer }}"
            }
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    ]
}
</script>
{% endif %}
