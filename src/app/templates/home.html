{% extends "base.html" %}

{% block content %}
<section class="hero">
    <div class="container">
        <h1>Encontre o presente geek perfeito</h1>
        <p class="hero-subtitle">
            Listas, reviews e ideias criadas por geeks, para geeks - com os melhores achados da Amazon, Mercado Livre e Shopee.
        </p>
        <div class="hero-cta">
            <a href="/ocasioes" class="btn btn-primary">Ver por ocasi√£o</a>
            <a href="/categorias/preco/ate-100" class="btn btn-secondary">Presentes at√© R$ 100</a>
        </div>
    </div>
</section>

<section class="featured">
    <div class="container">
        <h2>Destaques</h2>
        {% if featured_products %}
        <p class="section-description">Os melhores presentes geek selecionados para voce</p>
        <div class="products-grid-home">
            {% for product in featured_products %}
            <article class="product-card-home">
                {% if product.main_image_url %}
                <a href="/produto/{{ product.slug }}" class="product-image-home">
                    <img src="{{ product.main_image_url }}" alt="{{ product.name }}" loading="lazy">
                </a>
                {% else %}
                <a href="/produto/{{ product.slug }}" class="product-image-home product-image-placeholder">
                    <span>Sem imagem</span>
                </a>
                {% endif %}
                <div class="product-content-home">
                    <span class="product-platform platform-{{ product.platform.value }}">
                        {{ product.platform.value | title }}
                    </span>
                    <h3 class="product-name-home">
                        <a href="/produto/{{ product.slug }}">{{ product.name[:50] }}{% if product.name|length > 50 %}...{% endif %}</a>
                    </h3>
                    {% if product.price %}
                    <span class="product-price-home">{{ product.price | format_price }}</span>
                    {% endif %}
                    <a href="/goto/{{ product.affiliate_redirect_slug }}" class="product-cta-home" target="_blank" rel="noopener sponsored">
                        Ver oferta
                    </a>
                </div>
            </article>
            {% endfor %}
        </div>
        <div class="see-all">
            <a href="/produtos" class="btn btn-secondary">Ver todos os produtos</a>
        </div>
        {% elif featured_posts %}
        <p class="section-description">Os melhores artigos sobre presentes geek</p>
        <div class="posts-grid">
            {% for post in featured_posts %}
            <article class="post-card">
                {% if post.featured_image_url %}
                <a href="/blog/{{ post.slug }}" class="post-image">
                    <img src="{{ post.featured_image_url }}" alt="{{ post.title }}" loading="lazy">
                </a>
                {% endif %}
                <div class="post-content">
                    <h3 class="post-title">
                        <a href="/blog/{{ post.slug }}">{{ post.title }}</a>
                    </h3>
                    {% if post.subtitle %}
                    <p class="post-excerpt">{{ post.subtitle[:100] }}{% if post.subtitle|length > 100 %}...{% endif %}</p>
                    {% endif %}
                </div>
            </article>
            {% endfor %}
        </div>
        <div class="see-all">
            <a href="/blog" class="btn btn-secondary">Ver todos os artigos</a>
        </div>
        {% else %}
        <p class="section-description">Em breve: os melhores presentes geek selecionados para voce!</p>
        <div class="posts-grid">
            <div class="placeholder-card">
                <p>Conteudo em construcao...</p>
            </div>
        </div>
        {% endif %}
    </div>
</section>

<!-- Secao de Listas (Carrossel) -->
{% if recent_listicles %}
<section class="content-carousel">
    <div class="container">
        <div class="section-header">
            <div>
                <h2 class="section-title">Listas</h2>
                <p class="section-subtitle">Top 10, comparativos e selecoes especiais</p>
            </div>
            <a href="/listas" class="section-link">Ver todas</a>
        </div>
        <div class="carousel-wrapper">
            <button class="carousel-btn carousel-prev" aria-label="Anterior" data-carousel="listicles">
                <span>&lt;</span>
            </button>
            <div class="carousel-track" id="carousel-listicles">
                {% for post in recent_listicles %}
                <article class="carousel-card">
                    {% if post.featured_image_url %}
                    <a href="/blog/{{ post.slug }}" class="carousel-image">
                        <img src="{{ post.featured_image_url }}" alt="{{ post.title }}" loading="lazy">
                        <span class="carousel-badge">Lista</span>
                    </a>
                    {% endif %}
                    <div class="carousel-content">
                        {% if post.category %}
                        <a href="/categoria/{{ post.category.slug }}" class="carousel-category">
                            {{ post.category.name }}
                        </a>
                        {% endif %}
                        <h3 class="carousel-title">
                            <a href="/blog/{{ post.slug }}">{{ post.title[:60] }}{% if post.title|length > 60 %}...{% endif %}</a>
                        </h3>
                    </div>
                </article>
                {% endfor %}
            </div>
            <button class="carousel-btn carousel-next" aria-label="Proximo" data-carousel="listicles">
                <span>&gt;</span>
            </button>
        </div>
    </div>
</section>
{% endif %}

<!-- Secao de Guias (Carrossel) -->
{% if recent_guides %}
<section class="content-carousel content-carousel-alt">
    <div class="container">
        <div class="section-header">
            <div>
                <h2 class="section-title">Guias de Compra</h2>
                <p class="section-subtitle">Tudo que voce precisa saber para escolher o presente perfeito</p>
            </div>
            <a href="/guias" class="section-link">Ver todos</a>
        </div>
        <div class="carousel-wrapper">
            <button class="carousel-btn carousel-prev" aria-label="Anterior" data-carousel="guides">
                <span>&lt;</span>
            </button>
            <div class="carousel-track" id="carousel-guides">
                {% for post in recent_guides %}
                <article class="carousel-card">
                    {% if post.featured_image_url %}
                    <a href="/blog/{{ post.slug }}" class="carousel-image">
                        <img src="{{ post.featured_image_url }}" alt="{{ post.title }}" loading="lazy">
                        <span class="carousel-badge carousel-badge-guide">Guia</span>
                    </a>
                    {% endif %}
                    <div class="carousel-content">
                        {% if post.category %}
                        <a href="/categoria/{{ post.category.slug }}" class="carousel-category">
                            {{ post.category.name }}
                        </a>
                        {% endif %}
                        <h3 class="carousel-title">
                            <a href="/blog/{{ post.slug }}">{{ post.title[:60] }}{% if post.title|length > 60 %}...{% endif %}</a>
                        </h3>
                    </div>
                </article>
                {% endfor %}
            </div>
            <button class="carousel-btn carousel-next" aria-label="Proximo" data-carousel="guides">
                <span>&gt;</span>
            </button>
        </div>
    </div>
</section>
{% endif %}

<section class="categories">
    <div class="container">
        <h2 class="section-title">Navegue por Categoria</h2>
        <div class="category-grid">
            {% if categories %}
                {% for category in categories %}
                <a href="/categoria/{{ category.slug }}" class="category-card">
                    {% if category.image_url %}
                    <img src="{{ category.image_url }}" alt="{{ category.name }}" class="category-image">
                    {% else %}
                    <span class="category-icon">üì¶</span>
                    {% endif %}
                    <span class="category-name">{{ category.name }}</span>
                </a>
                {% endfor %}
            {% else %}
            <a href="/categoria/gamer" class="category-card">
                <span class="category-icon">üéÆ</span>
                <span class="category-name">Gamer</span>
            </a>
            <a href="/categoria/dev" class="category-card">
                <span class="category-icon">üíª</span>
                <span class="category-name">Dev</span>
            </a>
            <a href="/categoria/otaku" class="category-card">
                <span class="category-icon">üéå</span>
                <span class="category-name">Otaku</span>
            </a>
            <a href="/categoria/star-wars" class="category-card">
                <span class="category-icon">‚≠ê</span>
                <span class="category-name">Star Wars</span>
            </a>
            <a href="/categoria/marvel" class="category-card">
                <span class="category-icon">ü¶∏</span>
                <span class="category-name">Marvel</span>
            </a>
            <a href="/categoria/boardgames" class="category-card">
                <span class="category-icon">üé≤</span>
                <span class="category-name">Board Games</span>
            </a>
            {% endif %}
        </div>
        <div class="see-all">
            <a href="/categorias" class="btn btn-secondary">Ver todas as categorias</a>
        </div>
    </div>
</section>

<section class="newsletter">
    <div class="container">
        <h2>Fique por dentro!</h2>
        <p>Receba as melhores ideias de presentes geek toda semana.</p>
        <form class="newsletter-form" id="newsletter-form">
            <input type="email" name="email" placeholder="Seu melhor e-mail" required>
            <!-- Honeypot anti-spam (invisivel para usuarios) -->
            <input type="text" name="website" class="hp-field" tabindex="-1" autocomplete="off">
            <!-- Timestamp anti-spam -->
            <input type="hidden" name="ts" id="form-timestamp">
            <button type="submit" class="btn btn-primary">Inscrever</button>
        </form>
        <p class="newsletter-feedback" id="newsletter-feedback"></p>
    </div>
</section>

<script>
// Seta timestamp quando pagina carrega (anti-spam)
document.getElementById('form-timestamp').value = Math.floor(Date.now() / 1000);

// Submit via AJAX para melhor UX
document.getElementById('newsletter-form').addEventListener('submit', async function(e) {
    e.preventDefault();

    const form = e.target;
    const feedback = document.getElementById('newsletter-feedback');
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;

    // Desabilita botao durante envio
    submitBtn.disabled = true;
    submitBtn.textContent = 'Enviando...';
    feedback.textContent = '';
    feedback.className = 'newsletter-feedback';

    try {
        const formData = new FormData(form);
        const data = {
            email: formData.get('email'),
            website: formData.get('website'),
            ts: formData.get('ts')
        };

        const response = await fetch('/api/v1/newsletter/subscribe', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (response.ok) {
            feedback.textContent = result.message;
            feedback.className = 'newsletter-feedback success';
            form.reset();
            // Reseta timestamp para proximo envio
            document.getElementById('form-timestamp').value = Math.floor(Date.now() / 1000);
        } else {
            feedback.textContent = result.detail || 'Erro ao inscrever. Tente novamente.';
            feedback.className = 'newsletter-feedback error';
        }
    } catch (error) {
        feedback.textContent = 'Erro de conexao. Tente novamente.';
        feedback.className = 'newsletter-feedback error';
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
    }
});
</script>
{% endblock %}

{% block extra_css %}
<style>
/* Carrossel de Listas e Guias */
.content-carousel {
    padding: 3rem 0;
    background: var(--color-bg);
}

.content-carousel-alt {
    background: var(--color-bg-alt);
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
    gap: 1rem;
}

.section-title {
    margin: 0;
    font-size: 1.75rem;
}

.section-subtitle {
    margin: 0.25rem 0 0;
    color: var(--color-text-muted);
    font-size: 0.95rem;
}

.section-link {
    color: var(--color-primary);
    text-decoration: none;
    font-weight: 500;
    font-size: 0.95rem;
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

.section-link:hover {
    text-decoration: underline;
}

.carousel-wrapper {
    position: relative;
    overflow: hidden;
}

.carousel-track {
    display: flex;
    gap: 1.5rem;
    overflow-x: auto;
    scroll-behavior: smooth;
    scrollbar-width: none;
    -ms-overflow-style: none;
    padding: 0.5rem 0;
}

.carousel-track::-webkit-scrollbar {
    display: none;
}

.carousel-card {
    flex: 0 0 280px;
    background: var(--color-bg-card);
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transition: transform 0.2s, box-shadow 0.2s;
}

.carousel-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 4px 16px rgba(0,0,0,0.15);
}

.carousel-image {
    display: block;
    position: relative;
}

.carousel-image img {
    width: 100%;
    height: 160px;
    object-fit: cover;
}

.carousel-badge {
    position: absolute;
    top: 0.5rem;
    left: 0.5rem;
    background: var(--color-primary);
    color: white;
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
}

.carousel-badge-guide {
    background: #e67e22;
}

.carousel-content {
    padding: 1rem;
}

.carousel-category {
    display: inline-block;
    font-size: 0.7rem;
    text-transform: uppercase;
    color: var(--color-primary);
    text-decoration: none;
    margin-bottom: 0.25rem;
}

.carousel-title {
    font-size: 1rem;
    margin: 0;
    line-height: 1.3;
}

.carousel-title a {
    color: var(--color-text);
    text-decoration: none;
}

.carousel-title a:hover {
    color: var(--color-primary);
}

.carousel-btn {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    color: var(--color-text);
    cursor: pointer;
    z-index: 10;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transition: background 0.2s, transform 0.2s;
}

.carousel-btn:hover {
    background: var(--color-primary);
    color: white;
    transform: translateY(-50%) scale(1.05);
}

.carousel-prev {
    left: 0;
}

.carousel-next {
    right: 0;
}

@media (max-width: 768px) {
    .carousel-card {
        flex: 0 0 260px;
    }

    .carousel-btn {
        display: none;
    }

    .section-header {
        flex-direction: column;
        align-items: flex-start;
    }
}

/* Newsletter form */
.newsletter {
    padding: 3rem 0;
    background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
    color: white;
    text-align: center;
}

.newsletter h2 {
    margin-bottom: 0.5rem;
}

.newsletter p {
    margin-bottom: 1.5rem;
    opacity: 0.9;
}

.newsletter-form {
    display: flex;
    justify-content: center;
    gap: 0.5rem;
    max-width: 500px;
    margin: 0 auto;
    flex-wrap: wrap;
}

.newsletter-form input[type="email"] {
    flex: 1;
    min-width: 200px;
    padding: 0.875rem 1rem;
    border: none;
    border-radius: 8px;
    font-size: 1rem;
}

.newsletter-form button {
    padding: 0.875rem 2rem;
    white-space: nowrap;
}

/* Honeypot - invisivel para usuarios */
.hp-field {
    position: absolute !important;
    left: -9999px !important;
    opacity: 0 !important;
    height: 0 !important;
    width: 0 !important;
    overflow: hidden !important;
}

/* Feedback da inscricao */
.newsletter-feedback {
    margin-top: 1rem;
    font-size: 0.9rem;
    min-height: 1.4em;
}

.newsletter-feedback.success {
    color: #a7f3d0;
}

.newsletter-feedback.error {
    color: #fecaca;
}

@media (max-width: 480px) {
    .newsletter-form {
        flex-direction: column;
    }

    .newsletter-form input[type="email"],
    .newsletter-form button {
        width: 100%;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Carrossel simples com scroll
(function() {
    document.querySelectorAll('.carousel-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const carouselId = this.dataset.carousel;
            const track = document.getElementById('carousel-' + carouselId);
            if (!track) return;

            const cardWidth = track.querySelector('.carousel-card')?.offsetWidth || 280;
            const scrollAmount = cardWidth + 24; // card + gap

            if (this.classList.contains('carousel-prev')) {
                track.scrollBy({ left: -scrollAmount, behavior: 'smooth' });
            } else {
                track.scrollBy({ left: scrollAmount, behavior: 'smooth' });
            }
        });
    });
})();
</script>
{% endblock %}
